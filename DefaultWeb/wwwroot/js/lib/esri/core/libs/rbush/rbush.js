//>>built
define(["../quickselect/quickselect"],function(C){function t(a,b){return this instanceof t?(this._maxEntries=Math.max(4,a||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),b&&this._initFormat(b),void this.clear()):new t(a,b)}function p(a,b){q(a,0,a.children.length,b,a)}function q(a,b,c,d,e){e||(e=l(null));e.minX=1/0;e.minY=1/0;e.maxX=-(1/0);e.maxY=-(1/0);for(var g=b;c>g;g++)b=a.children[g],r(e,a.leaf?d(b):b);return e}function r(a,b){return a.minX=Math.min(a.minX,b.minX),a.minY=Math.min(a.minY,
b.minY),a.maxX=Math.max(a.maxX,b.maxX),a.maxY=Math.max(a.maxY,b.maxY),a}function z(a,b){return a.minX-b.minX}function A(a,b){return a.minY-b.minY}function w(a){return(a.maxX-a.minX)*(a.maxY-a.minY)}function u(a){return a.maxX-a.minX+(a.maxY-a.minY)}function x(a,b){return a.minX<=b.minX&&a.minY<=b.minY&&b.maxX<=a.maxX&&b.maxY<=a.maxY}function v(a,b){return b.minX<=a.maxX&&b.minY<=a.maxY&&b.maxX>=a.minX&&b.maxY>=a.minY}function l(a){return{children:a,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-(1/0),maxY:-(1/
0)}}function B(a,b,c,d,e){for(var g,f=[b,c];f.length;)c=f.pop(),b=f.pop(),d>=c-b||(g=b+Math.ceil((c-b)/d/2)*d,C(a,g,b,c,e),f.push(b,g,g,c))}return t.prototype={all:function(){return this._all(this.data,[])},search:function(a){var b=this.data,c=[],d=this.toBBox;if(!v(a,b))return c;for(var e,g,f,k,h=[];b;){e=0;for(g=b.children.length;g>e;e++)f=b.children[e],k=b.leaf?d(f):f,v(a,k)&&(b.leaf?c.push(f):x(a,k)?this._all(f,c):h.push(f));b=h.pop()}return c},collides:function(a){var b=this.data,c=this.toBBox;
if(!v(a,b))return!1;for(var d,e,g,f,k=[];b;){d=0;for(e=b.children.length;e>d;d++)if(g=b.children[d],f=b.leaf?c(g):g,v(a,f)){if(b.leaf||x(a,f))return!0;k.push(g)}b=k.pop()}return!1},load:function(a){if(!a||!a.length)return this;if(a.length<this._minEntries){for(var b=0,c=a.length;c>b;b++)this.insert(a[b]);return this}a=this._build(a.slice(),0,a.length-1,0);this.data.children.length?this.data.height===a.height?this._splitRoot(this.data,a):(this.data.height<a.height&&(b=this.data,this.data=a,a=b),this._insert(a,
this.data.height-a.height-1,!0)):this.data=a;return this},insert:function(a){return a&&this._insert(a,this.data.height-1),this},clear:function(){return this.data=l([]),this},remove:function(a,b){if(!a)return this;for(var c,d,e,g,f=this.data,k=this.toBBox(a),h=[],n=[];f||h.length;){f||(f=h.pop(),d=h[h.length-1],c=n.pop(),g=!0);var m;if(m=f.leaf){a:{m=a;var y=f.children,p=b;if(p){for(var l=0;l<y.length;l++)if(p(m,y[l])){m=l;break a}m=-1}else m=y.indexOf(m)}m=(e=m,-1!==e)}if(m)return f.children.splice(e,
1),h.push(f),this._condense(h),this;g||f.leaf||!x(f,k)?d?(c++,f=d.children[c],g=!1):f=null:(h.push(f),n.push(c),c=0,d=f,f=f.children[0])}return this},toBBox:function(a){return a},compareMinX:z,compareMinY:A,toJSON:function(){return this.data},fromJSON:function(a){return this.data=a,this},_all:function(a,b){for(var c=[];a;)a.leaf?b.push.apply(b,a.children):c.push.apply(c,a.children),a=c.pop();return b},_build:function(a,b,c,d){var e,g=c-b+1,f=this._maxEntries;if(f>=g)return e=l(a.slice(b,c+1)),p(e,
this.toBBox),e;d||(d=Math.ceil(Math.log(g)/Math.log(f)),f=Math.ceil(g/Math.pow(f,d-1)));e=l([]);e.leaf=!1;e.height=d;var k,h,n,g=Math.ceil(g/f),f=g*Math.ceil(Math.sqrt(f));for(B(a,b,c,f,this.compareMinX);c>=b;b+=f)for(h=Math.min(b+f-1,c),B(a,b,h,g,this.compareMinY),k=b;h>=k;k+=g)n=Math.min(k+g-1,h),e.children.push(this._build(a,k,n,d-1));return p(e,this.toBBox),e},_chooseSubtree:function(a,b,c,d){for(var e,g,f,k,h,n,m,l;d.push(b),!b.leaf&&d.length-1!==c;){m=l=1/0;e=0;for(g=b.children.length;g>e;e++)f=
b.children[e],h=w(f),n=(Math.max(f.maxX,a.maxX)-Math.min(f.minX,a.minX))*(Math.max(f.maxY,a.maxY)-Math.min(f.minY,a.minY))-h,l>n?(l=n,m=m>h?h:m,k=f):n===l&&m>h&&(m=h,k=f);b=k||b.children[0]}return b},_insert:function(a,b,c){var d=this.toBBox;c=c?a:d(a);var d=[],e=this._chooseSubtree(c,this.data,b,d);e.children.push(a);for(r(e,c);0<=b&&d[b].children.length>this._maxEntries;)this._split(d,b),b--;this._adjustParentBBoxes(c,d,b)},_split:function(a,b){var c=a[b],d=c.children.length,e=this._minEntries;
this._chooseSplitAxis(c,e,d);d=this._chooseSplitIndex(c,e,d);d=l(c.children.splice(d,c.children.length-d));d.height=c.height;d.leaf=c.leaf;p(c,this.toBBox);p(d,this.toBBox);b?a[b-1].children.push(d):this._splitRoot(c,d)},_splitRoot:function(a,b){this.data=l([a,b]);this.data.height=a.height+1;this.data.leaf=!1;p(this.data,this.toBBox)},_chooseSplitIndex:function(a,b,c){var d,e,g,f,k,h,l;k=h=1/0;for(d=b;c-b>=d;d++)e=q(a,0,d,this.toBBox),g=q(a,d,c,this.toBBox),f=Math.max(0,Math.min(e.maxX,g.maxX)-Math.max(e.minX,
g.minX))*Math.max(0,Math.min(e.maxY,g.maxY)-Math.max(e.minY,g.minY)),e=w(e)+w(g),k>f?(k=f,l=d,h=h>e?e:h):f===k&&h>e&&(h=e,l=d);return l},_chooseSplitAxis:function(a,b,c){var d=a.leaf?this.compareMinX:z,e=a.leaf?this.compareMinY:A,g=this._allDistMargin(a,b,c,d);this._allDistMargin(a,b,c,e)>g&&a.children.sort(d)},_allDistMargin:function(a,b,c,d){a.children.sort(d);var e,g=this.toBBox,f=q(a,0,b,g),k=q(a,c-b,c,g),h=u(f)+u(k);for(d=b;c-b>d;d++)e=a.children[d],r(f,a.leaf?g(e):e),h+=u(f);for(d=c-b-1;d>=
b;d--)e=a.children[d],r(k,a.leaf?g(e):e),h+=u(k);return h},_adjustParentBBoxes:function(a,b,c){for(;0<=c;c--)r(b[c],a)},_condense:function(a){for(var b,c=a.length-1;0<=c;c--)0===a[c].children.length?0<c?(b=a[c-1].children,b.splice(b.indexOf(a[c]),1)):this.clear():p(a[c],this.toBBox)},_initFormat:function(a){var b=["return a"," - b",";"];this.compareMinX=new Function("a","b",b.join(a[0]));this.compareMinY=new Function("a","b",b.join(a[1]));this.toBBox=new Function("a","return {minX: a"+a[0]+", minY: a"+
a[1]+", maxX: a"+a[2]+", maxY: a"+a[3]+"};")}},t});