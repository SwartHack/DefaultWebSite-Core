//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper ../../../core/accessorSupport/decorators ../../../core/Accessor ../../../core/Error ../../../core/Evented ../../../core/Logger ../../../core/HandleRegistry ../../../core/Promise ../../../core/promiseUtils ../../support/GraphicsManager ../../../geometry/support/scaleUtils".split(" "),function(x,y,p,e,z,d,q,g,r,t,u,v,h,w,k){var l=t.getLogger("esri.layers.graphics.controllers.SnapshotController");
return function(m){function b(){var a=m.call(this)||this;return a._cancelErrorMsg="SnapshotController: query cancelled",a._featureResolution={value:.25,scale:945},a._gManager=null,a._handles=new u,a._maxFeatures={point:16E3,multipoint:8E3,polyline:4E3,polygon:4E3,multipatch:4E3},a._source=null,a._started=!1,a._pendingQueries=new Map,a.extent=null,a.hasAllFeatures=!1,a.hasFeatures=!1,a.layer=null,a.layerView=null,a.maxPageSize=null,a.pageSize=null,a.paginationEnabled=!1,a}return p(b,m),b.prototype.initialize=
function(){var a=this,c=this.layer.when(function(){return a._verifyCapabilities()}).then(function(){return a._init()});this.addResolvingPromise(c)},b.prototype.destroy=function(){this.cancelQuery();this._gManager&&(this._gManager.destroy(),this._gManager=null);this._handles.destroy();this._pendingQueries=this._handles=null},Object.defineProperty(b.prototype,"updating",{get:function(){return!!(this._pendingQueries&&0<this._pendingQueries.size)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,
"graphics",{set:function(a){this._get("graphics")!==a&&(this._handles.remove("graphics"),a&&(this._collectionChanged({added:a.toArray()}),this._handles.add(a.on("change",this._collectionChanged.bind(this)),"graphics")),this._set("graphics",a))},enumerable:!0,configurable:!0}),b.prototype.cancelQuery=function(){var a=this;this._pendingQueries&&(this._pendingQueries.forEach(function(c,b){c.isFulfilled()||c.cancel(Error(a._cancelErrorMsg))}),this._pendingQueries.clear(),this.notifyChange("updating"))},
b.prototype.refresh=function(){this.isResolved()&&this._started&&this._queryFeatures()},b.prototype.startup=function(){this._started||(this._started=!0,this._resolutionParams=this._getResolutionParams(),this._queryFeatures())},b.prototype.update=function(){this.startup()},b.prototype._init=function(){var a=this.layer;this.paginationEnabled=!!a.get("capabilities.query.supportsPagination");this._source=a.source;this.pageSize=null==this.maxPageSize?a.maxRecordCount:Math.min(a.maxRecordCount,this.maxPageSize);
this._gManager=new w({graphics:this.graphics,objectIdField:a.objectIdField});this._setupStateWatchers()},b.prototype._getResolutionParams=function(){var a,c=this.layer,b=c.get("capabilities.query.supportsQuantization");if("polyline"===c.geometryType||"polygon"===c.geometryType){var f=k.getMetersPerUnit(this.layerView.view.spatialReference);null!=f&&(a=this._featureResolution.scale,f=this._featureResolution.value/f,a=c.maxScale?c.maxScale:c.minScale?Math.min(a,c.minScale):Math.min(a,k.getScale(this.layerView.view,
c.fullExtent)),a*=f/this._featureResolution.scale)}return a?{maxAllowableOffset:b?null:a,quantizationParameters:b?{mode:"view",originPosition:"upperLeft",tolerance:a,extent:c.fullExtent}:null}:null},b.prototype._setupStateWatchers=function(){this._handles.add([this.watch("extent",this.refresh.bind(this)),this.layer.watch("definitionExpression",this.refresh.bind(this)),this.layer.on("edits",this._editsHandler.bind(this))])},b.prototype._createQueryParams=function(){var a=this.layerView,c=this.layer.createQuery();
return c.outSpatialReference=a.view.spatialReference,c.geometry=this.extent,c.set(this._resolutionParams),this.paginationEnabled&&(c.start=0,c.num=this.pageSize),c},b.prototype._queryFeatures=function(){this.cancelQuery();this.hasAllFeatures=this.hasFeatures=!1;this._gManager.beginPagedUpdate();this.emit("query-start");this._executeQuery(this._createQueryParams())},b.prototype._executeQuery=function(a){var c=this,b=this._source.queryFeatures(a),f=this._gManager.createIntentToAdd();this._querySetup(f,
b);b.then(this._processFeatureSet.bind(this,a,f))["catch"](function(a){return c._queryError(f,a)}).always(function(){return c._queryTeardown(f)})},b.prototype._processFeatureSet=function(a,c,b){var f=b.exceededTransferLimit,d=b.features,e=this._maxFeatures[this.layer.geometryType]||0,n=d?d.length:0,g=this._gManager.numGraphics+n,h=g>=e;h&&(l.warn('Feature limit exceeded on layer "',this.layer.title,'". Not all features are shown.'),(e=g-e)&&d.splice(n-e,e));a=f&&this.paginationEnabled&&!h?this._queryNextPage(a):
!1;return d&&this._gManager.addPage(d,c),this.hasFeatures=!0,a||(this._gManager.endPagedUpdate(),this.hasAllFeatures=!f,this.emit("query-end",{success:!0})),b},b.prototype._queryNextPage=function(a){return a.start+=this.pageSize,this._executeQuery(a),!0},b.prototype._queryError=function(a,c){if(c&&"cancel"===c.dojoType&&!this.hasFeatures?this._gManager.revertPagedUpdate():this._gManager.endPagedUpdate(),this.emit("query-end",{success:!1}),c&&"cancel"===c.dojoType)return h.reject(c);a=new g("snapshotcontroller:tile-request-failed",
"Failed to query for features",{error:c});return l.error(a),h.reject(a)},b.prototype._querySetup=function(a,c){this._pendingQueries.set(a,c);this.notifyChange("updating")},b.prototype._queryTeardown=function(a){this._gManager.removeIntent(a);this._pendingQueries["delete"](a);this.notifyChange("updating")},b.prototype._processRefetch=function(a,c){(c=c.features)&&this._gManager.add(c,a)},b.prototype._refetchError=function(a,c){},b.prototype._verifyCapabilities=function(){if(!this.layer.get("capabilities.operations.supportsQuery"))throw new g("graphicscontroller:query-capability-required",
"Service requires query capabilities to be used as a feature layer",{layer:this.layer});},b.prototype._collectionChanged=function(a){var c=a.added;if(c)for(var b=0;b<c.length;b++)c[b].layer=this.layer;if(c=a.removed)for(b=0;b<c.length;b++)c[b].layer=null},b.prototype._editsHandler=function(a){var b=function(a){return a.objectId},d=a.deletedFeatures.map(b);this._gManager["delete"](d);a=a.addedFeatures.concat(a.updatedFeatures).map(b);a.length&&(b=this._createQueryParams(),b.objectIds=a,b=this._source.queryFeatures(b),
a=this._gManager.createIntentToAdd(a),this._querySetup(a,b),b.then(this._processRefetch.bind(this,a)).otherwise(this._refetchError.bind(this,a)).always(this._queryTeardown.bind(this,a)))},e([d.property()],b.prototype,"_pendingQueries",void 0),e([d.property({dependsOn:["_pendingQueries"]})],b.prototype,"updating",null),e([d.property()],b.prototype,"graphics",null),e([d.property()],b.prototype,"extent",void 0),e([d.property()],b.prototype,"hasAllFeatures",void 0),e([d.property()],b.prototype,"hasFeatures",
void 0),e([d.property()],b.prototype,"layer",void 0),e([d.property()],b.prototype,"layerView",void 0),e([d.property()],b.prototype,"maxPageSize",void 0),e([d.property()],b.prototype,"pageSize",void 0),e([d.property()],b.prototype,"paginationEnabled",void 0),b=e([d.subclass("esri.layers.graphics.controllers.SnapshotController")],b)}(d.declared(q,v,r))});