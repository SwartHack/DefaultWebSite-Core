//>>built
define("../../../core/declare dojo/_base/lang dojo/Deferred ../../../core/Accessor ../../../core/Promise ../../../core/urlUtils ../../../core/promiseUtils ../../../geometry/Extent ../../support/WebSocketConnector ../../../tasks/QueryTask ../../../request".split(" "),function(p,h,q,r,t,m,l,u,v,n,w){return p([r,t],{getDefaults:function(a){var b=this.inherited(arguments),d=a.layer;return d&&(b=h.mixin(b,{url:d.url})),b},initialize:function(){this.addResolvingPromise(this._fetchLayers())},properties:{connectionInfo:{get:function(){if(this.layer.hasMemorySource||
this.layer.socketUrl)return{serviceSocketUrls:[this.layer.socketUrl]};if(this.layerDefinition){var a,b,d,e,c={};b=this.layerDefinition;var f=[],k=[],g=[];if(b.streamUrls&&b.streamUrls.forEach(function(a){"ws"===a.transport&&(f=a.urls,c.token=a.token)},this),f.forEach(function(a){0===a.lastIndexOf("wss",0)?g.push(a):k.push(a)}),a="https"===m.appUrl.scheme||0===this.url.lastIndexOf("https:",0)?g:0===k.length?g:k,a&&1<a.length)for(b=0;b<a.length-1;b++)d=b+Math.floor(Math.random()*(a.length-b)),e=a[d],
a[d]=a[b],a[b]=e;return c.serviceSocketUrls=a,c}}},latestUrl:{get:function(){var a=this.layerDefinition;return a=(a=a.keepLatestArchive&&a.keepLatestArchive.featuresUrl)?a:null}},latestQueryTask:{get:function(){var a=this.latestUrl;return a?new n(a):null}},relatedFeaturesInfo:{get:function(){var a=(this.layerDefinition||{}).relatedFeatures;return a=a&&a.featuresUrl?a:null}},relatedFeaturesQueryTask:{get:function(){var a=this.relatedFeaturesInfo;return(a=a?a.featuresUrl:null)?new n(a):null}},parsedUrl:{get:function(){return this.url?
m.urlToObject(this.url):null}},url:null},createWebSocketConnector:function(a){var b=new q;return this.when(function(){var d,e,c,f=this.connectionInfo,k=this.layer.spatialReference,g={};try{d=this.makeFilter()}catch(x){return void b.reject(x)}if(f){if(f.socketUrl?c=[f.socketUrl]:f.serviceSocketUrls&&(c=f.serviceSocketUrls.map(function(a){return a+"/"+this.layer.socketDirection}.bind(this))),g.socketUrls=c,d&&(d.where||d.geometry||d.outFields))(c=d.geometry)&&"string"!=typeof c&&(c=c.toJSON?JSON.stringify(c.toJSON()):
JSON.stringify(c)),e=h.mixin(e||{},{where:d.where,geometry:c,outFields:d.outFields});f.token&&(e=h.mixin(e||{},{token:f.token}));a&&k&&a.wkid!==k.wkid&&(e=h.mixin(e||{},{outSR:a.wkid}));g.queryParams=e;g.layerSource=this;d=new v(g);b.resolve(d)}else b.reject(Error("No web socket urls found"))}.bind(this)),b.promise},getWebSocketToken:function(){return this._fetchStreamLayer().then(function(a){a=a.data;var b=null;return a.streamUrls&&a.streamUrls.some(function(a){return"ws"===a.transport?(b=a.token,
!0):void 0},this),b}.bind(this))},makeFilter:function(a){var b,d=this.layer,e=null;if(a){var c;if(b={},a.hasOwnProperty("where")&&(b.where=a.where),a.hasOwnProperty("geometry")){if(c=a.geometry,c&&!c.hasOwnProperty("xmin"))throw Error("Cannot make filter. Only Extent is supported for the geometry filter");c&&!c.declaredClass&&(c=new u(c));b.geometry=c}}else if(b=d.filter||{},b={where:b.where,geometry:b.geometry},(a=this.relatedFeaturesInfo&&this.relatedFeaturesInfo.outFields||d.outFields)&&-1===a.indexOf("*")){var f=
d.fields.map(function(a){return a.name}),e=a.filter(function(a){return-1!==f.indexOf(a)}).join(",");b=h.mixin(b||{},{outFields:e})}return b},_fetchLayers:function(){return this._fetchStreamLayer().then(function(a){return a.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),this.layerDefinition=a.data,this._fetchArchiveLayer()}.bind(this)).then(function(a){return this.archivedLayerDefinition=a&&a.data,this._fetchRelatedLayer()}.bind(this)).then(function(a){this.relatedLayerDefinition=a&&a.data}.bind(this))},
_fetchStreamLayer:function(){return this._requestServiceDefinition({url:this.layer.parsedUrl.path,content:h.mixin({f:"json"},this.layer.parsedUrl.query)})},_fetchArchiveLayer:function(){var a=this.latestUrl;return a?this._requestServiceDefinition({url:a}):l.resolve()},_fetchRelatedLayer:function(){var a=this.relatedFeaturesInfo;return a?this._requestServiceDefinition({url:a.featuresUrl}):l.resolve()},_requestServiceDefinition:function(a){return a&&a.url?w(a.url,{query:h.mixin(a.content||{},{f:"json"}),
responseType:"json",callbackParamName:"callback"}):l.reject(Error("url is a required options property"))}})});