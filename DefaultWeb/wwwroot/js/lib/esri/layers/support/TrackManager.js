//>>built
define(["../../core/declare","dojo/_base/array","../../Graphic","../../geometry/Polyline","../GraphicsLayer"],function(n,g,p,q,r){return n(null,{declaredClass:"esri.layers.support.TrackManager",constructor:function(b){this.layer=b;this.trackMap={};this.trackLineMap={}},initialize:function(b){this.map=b;var c=this.layer,a=c._getRenderer(),a=a&&a.trackRenderer;if("point"===c.geometryType){var d=this.container=new r._GraphicsLayer({id:c.id+"_tracks",_child:!0});d.loaded=!0;d.onLoad(d);d._setMap(b,c._div);
d.setRenderer(a)}},addFeatures:function(b){var c=this.trackMap,a=this.layer,d=a._trackIdField,f=[];g.forEach(b,function(b){var a=b.attributes[d];(c[a]=c[a]||[]).push(b);-1===g.indexOf(f,a)&&f.push(a)});var e=a._startTimeField,h=a.objectIdField,l=function(a,b){var c=a.attributes[e],d=b.attributes[e];return c===d?a.attributes[h]<b.attributes[h]?-1:1:d>c?-1:1};g.forEach(f,function(a){c[a].sort(l)})},trimTracks:function(b){function c(a){for(a=d[a]||[];a.length>f;)e.push(a.shift())}var a,d=this.trackMap,
f=this.layer.maximumTrackPoints||0,e=[];if(!f)return e;if(b)g.forEach(b,function(a){c(a)});else for(a in d)d.hasOwnProperty(a)&&c(a);return e},drawTracks:function(b){function c(b){var c,e,g,k,m=a[b];if(k=h.trackLineMap[b],l.remove(k),delete h.trackLineMap[b],k=null,!m||2>m.length)return!1;e=[];for(c=m.length-1;0<=c;c--)(g=m[c].geometry)&&e.push([g.x,g.y]);c={};c[f]=b;1<e.length&&(k=new p(new q({paths:[e],spatialReference:d}),null,c),l.add(k),h.trackLineMap[b]=k)}var a,d,f,e,h=this,l=this.container;
if(l)if(a=this.trackMap,d=this.map.spatialReference,f=this.layer._trackIdField,b)g.forEach(b,function(a){c(a)});else for(e in a)a.hasOwnProperty(e)&&c(e)},refreshTracks:function(b){function c(a){var b,c;if(d.drawTracks([a]),h&&h.latestObservationRenderer)for(a=f[a]||[],b=a.length,c=0;b>c;c++)e._repaint(a[c],null,!0)}var a,d=this,f=this.trackMap,e=this.layer,h=e._getRenderer();if(b)g.forEach(b,function(a){c(a)});else for(a in f)f.hasOwnProperty(a)&&c(a);this.moveLatestToFront()},moveLatestToFront:function(b){g.forEach(this.getLatestObservations(b),
function(b){var a=b._shape;a&&a._moveToFront();this._repaint(b,null,!0)},this.layer)},getLatestObservations:function(b){function c(a){a=e[a];return a[a.length-1]}var a,d=[],f=this.layer._getRenderer(),e=this.trackMap;if(!f.latestObservationRenderer)return d;if(b)g.forEach(b,function(a){d.push(c(a))});else for(a in e)e.hasOwnProperty(a)&&d.push(c(a));return d},clearTracks:function(b){var c,a=this.getLatestObservations(b),d=this.container;b?g.forEach(b,function(a){delete this.trackMap[a];d&&(c=this.trackLineMap[a],
d.remove(c),delete this.trackLineMap[a])},this):(this.trackMap={},this.trackLineMap={},d&&d.removeAll());g.forEach(a,function(a){this._repaint(a,null,!0)},this.layer)},isLatestObservation:function(b){var c=this.trackMap[b.attributes[this.layer._trackIdField]];return c?c[c.length-1]===b:!1},destroy:function(){var b=this.container;b&&(b.removeAll(),b._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}})});