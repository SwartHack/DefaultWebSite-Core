//>>built
define("require exports ../../config ../../core/lang ../../request ../support/KMLSublayer ../../tasks/support/FeatureSet ../../PopupTemplate ../../renderers/support/jsonUtils".split(" "),function(y,f,n,g,p,q,r,t,u){function l(a,d,b){b.forEach(function(b){a.set(b.attributes[d],b)})}function v(a,d){var b;return d.some(function(d){return d.id===a?(b=d,!0):!1}),b}Object.defineProperty(f,"__esModule",{value:!0});var w={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};
f.parseKML=function(a){var d=a.folders.slice(),b=new Map,m=new Map,h=new Map,k=new Map,f=new Map,x={esriGeometryPoint:m,esriGeometryPolyline:h,esriGeometryPolygon:k};return a.featureCollection.layers.forEach(function(c){var e=g.clone(c);e.featureSet.features=[];var a=c.featureSet.geometryType;b.set(a,e);e=c.layerDefinition.objectIdField;"esriGeometryPoint"===a?l(m,e,c.featureSet.features):"esriGeometryPolyline"===a?l(h,e,c.featureSet.features):"esriGeometryPolygon"===a&&l(k,e,c.featureSet.features)}),
a.groundOverlays&&a.groundOverlays.forEach(function(c){f.set(c.id,c)}),a.folders.forEach(function(c){c.networkLinkIds.forEach(function(e){var b;b=c.id;e=v(e,a.networkLinks);(b=(e&&(e.parentFolderId=b,e.networkLink=e),e))&&d.push(b)})}),d.forEach(function(c){c.featureInfos&&(c.points=g.clone(b.get("esriGeometryPoint")),c.polylines=g.clone(b.get("esriGeometryPolyline")),c.polygons=g.clone(b.get("esriGeometryPolygon")),c.mapImages=[],c.featureInfos.map(function(b){switch(b.type){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":var a=
x[b.type].get(b.id);a&&c[w[b.type]].featureSet.features.push(a);break;case "GroundOverlay":(b=f.get(b.id))&&c.mapImages.push(b)}}))}),{folders:a.folders,sublayers:d}};f.fetchService=function(a,d,b){return p(n.kmlServiceUrl,{callbackParamName:"callback",query:{url:a,model:"simple",folders:"",refresh:0!==b?!0:void 0,outSR:JSON.stringify(d)},responseType:"json"})};f.sublayersFromJSON=function(a,d,b){void 0===d&&(d=null);void 0===b&&(b=[]);var f=[],h={},k=a.sublayers,g=a.folders.map(function(b){return b.id});
return k.forEach(function(a){var c=new q;(d?c.read(a,d):c.read(a),b.length&&-1<g.indexOf(c.id)&&(c.visible=-1!==b.indexOf(c.id)),h[a.id]=c,null!=a.parentFolderId&&-1!==a.parentFolderId)?(a=h[a.parentFolderId],a.sublayers||(a.sublayers=[]),a.sublayers.unshift(c)):f.unshift(c)}),f};f.getGraphics=function(a){var d=r.fromJSON(a.featureSet).features,b=u.fromJSON(a.layerDefinition.drawingInfo.renderer),f=t.fromJSON(a.popupInfo);return d.map(function(a){var d=b.getSymbol(a);return a.symbol=d,a.popupTemplate=
f,a})}});