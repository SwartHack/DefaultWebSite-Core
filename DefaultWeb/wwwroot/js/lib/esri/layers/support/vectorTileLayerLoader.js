//>>built
define("require exports dojo/has dojo/_base/lang ../../core/promiseUtils ../../core/urlUtils ../../config ../../request".split(" "),function(z,n,u,v,g,d,l,m){function h(a){if(a){var b=d.getOrigin(a);return d.canUseXhr(b)||-1!==p.indexOf(b)||p.push(b),a}}function q(a,b,c){if(null!=b.sources){c&&-1!==c.path.indexOf("root.json")&&(c.path=c.path.substr(0,c.path.indexOf("root.json")),a.styleUrl=c.path);var e=r(b,c),f=b.sprite||null,k=b.glyphs||null,e=c&&c.path||e&&e.url;return e&&(b.sprite&&!d.isAbsolute(b.sprite)&&
(f=d.normalize(d.join(e,b.sprite))),b.glyphs&&!d.isAbsolute(b.glyphs)&&(k=d.normalize(d.join(e,b.glyphs)))),a.style=b,a.spriteUrl=f,a.glyphsUrl=k,w(a,b,c)}return b.hasOwnProperty("tileInfo")?(a.layerDefinition=b,a.serviceUrl=c.path,x(a,b,c)):void 0}function x(a,b,c){if(y&&!b.hasOwnProperty("defaultStyles"))throw Error("Service definition must have 'defaultStyles' element!");b=b.defaultStyles;return d.isAbsolute(b)?a.styleUrl=d.normalize(b):a.styleUrl=d.normalize(d.join(c.path,b)),h(a.styleUrl),m(d.join(a.styleUrl,
"root.json"),{responseType:"json"}).then(function(b){var c=b.data.sprite||null,e=b.data.glyphs||null;return c&&!d.isAbsolute(c)&&(c=d.normalize(d.join(a.styleUrl,c))),e&&!d.isAbsolute(e)&&(e=d.normalize(d.join(a.styleUrl,e))),a.spriteUrl=c,a.glyphsUrl=e,a.style=b.data,b.data})}function w(a,b,c){b=r(b,c);return b||g.reject("Source isn't available in the syle object!"),b.url?(a.serviceUrl=b.url,d.isAbsolute(a.serviceUrl)||(a.serviceUrl=d.join(c.path,a.serviceUrl)),h(a.serviceUrl),m(a.serviceUrl,{query:{f:"json"},
responseType:"json"}).then(function(b){return a.layerDefinition=t(b.data),a})):(a.layerDefinition=t(b),g.resolve(a))}function r(a,b){if(!a.sources)return null;var c=a.sources;a=null;if(c.esri){if(a=c.esri,b&&a.url&&!d.isAbsolute(a.url))c=b.path.substring(0,b.path.lastIndexOf("/")),a.url=d.join(c,a.url)}else{for(var e=0,f=Object.keys(c);e<f.length;e++)if(b=f[e],-1!==b.toLocaleLowerCase().indexOf("street")&&"vector"===a.type){a=c[b];break}if(!a)for(e=0,f=Object.keys(c);e<f.length&&(b=f[e],a=c[b],"vector"!==
a.type);e++);}return a}function t(a){if(a.hasOwnProperty("tileInfo"))return a;for(var b={xmin:-2.0037507067161843E7,ymin:-2.0037507067161843E7,xmax:2.0037507067161843E7,ymax:2.0037507067161843E7,spatialReference:{wkid:102100}},c=(b.xmax-b.xmin)/512,e=[],d=a.hasOwnProperty("minzoom")?parseFloat(a.minzoom):0,k=a.hasOwnProperty("maxzoom")?parseFloat(a.maxzoom):16;k>d;d++){var g=c/Math.pow(2,d);e.push({level:d,scale:Math.floor(3779.527559055118*g),resolution:g})}return a.tiles.forEach(h),{capabilities:"TilesOnly",
initialExtent:b,fullExtent:b,minScale:e[0].scale,maxScale:e[e.length-1].scale,tiles:a.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-2.0037508342787E7,y:2.0037508342787E7},lods:e,spatialReference:{wkid:102100}}}}Object.defineProperty(n,"__esModule",{value:!0});var y=u("dojo-debug-messages"),p=l.defaults&&l.defaults.io.corsEnabledServers||l.request.corsEnabledServers;n.loadMetadata=function(a){if(!a)return g.reject("invalid input URL!");var b={layerDefinition:null,parsedUrl:null,
serviceUrl:null,style:null,styleUrl:null,url:null,spriteUrl:null,glyphsUrl:null};if("string"!=typeof a)return q(b,a,null).then(function(){return b});a=b.url=d.normalize(a);var c=b.parsedUrl=d.urlToObject(a);return h(a),m(c.path,{responseType:"json",query:v.mixin({f:"json"},c.query)}).then(function(a){return q(b,a.data,c)}).then(function(){return b})}});