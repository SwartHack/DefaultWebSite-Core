//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/paramHelper ../core/accessorSupport/decorators ../core/Error ../config ../kernel ../request ../geometry/Extent ../core/global ../core/JSONSupport ../core/Loadable ./PortalQueryParams ./PortalQueryResult ./PortalUser ../core/promiseUtils ../core/requireUtils ../core/urlUtils dojo/promise/all dojo/_base/kernel dojo/_base/lang dojo/_base/url".split(" "),function(n,
J,x,y,c,z,d,t,u,h,A,B,f,C,D,p,E,F,l,q,r,v,G,H,I){var m;return function(w){function b(a){a=w.call(this)||this;return a.access=null,a.allSSL=!1,a.authMode="auto",a.authorizedCrossOriginDomains=null,a.basemapGalleryGroupQuery=null,a.bingKey=null,a.canListApps=!1,a.canListData=!1,a.canListPreProvisionedItems=!1,a.canProvisionDirectPurchase=!1,a.canSearchPublic=!1,a.canShareBingPublic=!1,a.canSharePublic=!1,a.canSignInArcGIS=!1,a.canSignInIDP=!1,a.colorSetsGroupQuery=null,a.commentsEnabled=!1,a.created=
null,a.culture=null,a.customBaseUrl=null,a.defaultBasemap=null,a.defaultExtent=null,a.defaultVectorBasemap=null,a.description=null,a.featuredGroups=null,a.featuredItemsGroupQuery=null,a.galleryTemplatesGroupQuery=null,a.livingAtlasGroupQuery=null,a.helperServices=null,a.homePageFeaturedContent=null,a.homePageFeaturedContentCount=null,a.httpPort=null,a.httpsPort=null,a.id=null,a.ipCntryCode=null,a.isPortal=!1,a.layerTemplatesGroupQuery=null,a.maxTokenExpirationMinutes=null,a.modified=null,a.name=null,
a.portalHostname=null,a.portalMode=null,a.portalProperties=null,a.region=null,a.rotatorPanels=null,a.showHomePageDescription=!1,a.supportsHostedServices=!1,a.symbolSetsGroupQuery=null,a.templatesGroupQuery=null,a.units=null,a.url=u.portalUrl,a.urlKey=null,a.user=null,a.useStandardizedQuery=!1,a.useVectorBasemaps=!1,a.vectorBasemapGalleryGroupQuery=null,a}return y(b,w),e=b,b.prototype.normalizeCtorArgs=function(a){return"string"==typeof a?{url:a}:a},b.prototype.destroy=function(){this._esriId_credentialCreateHandle&&
(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},b.prototype.readAuthorizedCrossOriginDomains=function(a){if(a)for(var b=0;b<a.length;b++){var d=a[b],c=d;r.hasProtocol(c)||(c=r.appUrl.scheme+"://"+c);r.canUseXhr(c)||u.request.corsEnabledServers.push({host:d,withCredentials:!0})}return a},b.prototype.readDefaultBasemap=function(a){return a?(a=m.fromJSON(a),a.portalItem={portal:this},a):null},b.prototype.readDefaultVectorBasemap=function(a){return a?(a=m.fromJSON(a),
a.portalItem={portal:this},a):null},Object.defineProperty(b.prototype,"extraQuery",{get:function(){return this.id&&!this.canSearchPublic?" AND orgid:"+this.id:null},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"isOrganization",{get:function(){return!!this.access},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"restUrl",{get:function(){var a=this.url;if(a)var b=a.indexOf("/sharing"),a=0<b?a.substring(0,b):this.url.replace(/\/+$/,""),a=a+"/sharing/rest";return a},
enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"thumbnailUrl",{get:function(){var a=this.restUrl,b=this.thumbnail;return a&&b?this._normalizeSSL(a+"/portals/self/resources/"+b):null},enumerable:!0,configurable:!0}),b.prototype.readUrlKey=function(a){return a?a.toLowerCase():a},b.prototype.readUser=function(a){var b=null;return a&&(b=F.fromJSON(a),b.portal=this),b},b.prototype.load=function(){var a=this,b=q.when(n,"../Basemap").then(function(a){m=a}).then(function(){return a._fetchSelf()}).then(function(b){if(h.id){var c=
h.id;a.credential=c.findCredential(a.restUrl);a.credential||a.authMode!==e.AUTH_MODE_AUTO||(a._esriId_credentialCreateHandle=c.on("credential-create",function(){c.findCredential(a.restUrl)&&a._signIn()}))}a.read(b)});return this.addResolvingPromise(b),this.when()},b.prototype.fetchBasemaps=function(a){var b=new p;return b.query=a||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),b.disableExtraQuery=!0,this.queryGroups(b).then(function(a){return(b.num=100,
b.query='type:"Web Map" -type:"Web Application"',a.total)?(a=a.results[0],b.sortField=a.sortField||"name",b.sortOrder=a.sortOrder||"desc",a.queryItems(b)):null}).then(function(a){return a&&a.total?a.results.filter(function(a){return"Web Map"===a.type}).map(function(a){return new m({portalItem:a})}):[]})},b.prototype.fetchFeaturedGroups=function(){var a=this.featuredGroups,b=new p;if(b.num=100,b.sortField="title",a&&a.length){for(var c=[],d=0;d<a.length;d++){var k=a[d];c.push('(title:"'+k.title+'" AND owner:'+
k.owner+")")}return b.query=c.join(" OR "),this.queryGroups(b).then(function(a){return a.results})}return l.resolve([])},b.getDefault=function(){return e._default||(e._default=new e),e._default},b.prototype.queryGroups=function(a){return this._queryPortal("/community/groups",a,"PortalGroup")},b.prototype.queryItems=function(a){return this._queryPortal("/search",a,"PortalItem")},b.prototype.queryUsers=function(a){return a.sortField||(a.sortField="username"),this._queryPortal("/community/users",a,"PortalUser")},
b.prototype.toJSON=function(){throw new t("internal:not-yet-implemented","Portal.toJSON is not yet implemented");},b.prototype._fetchSelf=function(a){void 0===a&&(a=this.authMode);var b=this.restUrl+"/portals/self";a={authMode:a,query:{culture:G.locale}};return"auto"===a.authMode&&(a.authMode="no-prompt"),this._request(b,a)},b.prototype._queryPortal=function(a,b,c){var d=this,g=function(c){return d._request(d.restUrl+a,b.toRequestOptions(d)).then(function(a){var g=b.clone();return g.start=a.nextStart,
new E({nextQueryParams:g,queryParams:b,total:a.total,results:e._resultsToTypedArray(c,{portal:d},a)})}).then(function(a){return v(a.results.map(function(b){return"function"==typeof b.when?b.when():a})).always(function(){return a})})};return c?q.when(n,"./"+c).then(function(a){return g(a)}):g()},b.prototype._signIn=function(){var a=this;if(this.authMode===e.AUTH_MODE_ANONYMOUS)return l.reject(new t("portal:invalid-auth-mode",'Current "authMode"\' is "'+this.authMode+'"'));if("failed"===this.loadStatus)return l.reject(this.loadError);
var b=function(b){return l.resolve().then(function(){return"not-loaded"===a.loadStatus?(b||(a.authMode="immediate"),a.load().then(function(){return null})):"loading"===a.loadStatus?a.load().then(function(){return a.credential?null:(a.credential=b,a._fetchSelf("immediate"))}):a.user&&a.credential===b?null:(a.credential=b,a._fetchSelf("immediate"))}).then(function(b){b&&a.read(b)})};return h.id?h.id.getCredential(this.restUrl).then(function(a){return b(a)}):b(this.credential)},b.prototype._normalizeSSL=
function(a){var b=this.allSSL;if(b||("isSecureContext"in f?b=f.isSecureContext:f.location&&f.location.origin&&(b=0===f.location.origin.indexOf("https:"))),this.isPortal){var c=new I(a);return-1<this.portalHostname.toLowerCase().indexOf(c.host.toLowerCase())&&c.port&&"80"!==c.port&&"443"!==c.port?b?"https://"+c.host+(this.httpsPort&&443!==this.httpsPort?":"+this.httpsPort:"")+c.path+"?"+c.query:"http://"+c.host+(this.httpPort&&80!==this.httpPort?":"+this.httpPort:"")+c.path+"?"+c.query:b?a.replace("http:",
"https:"):a}return b?a.replace("http:","https:"):a},b.prototype._normalizeUrl=function(a){var b=this.credential&&this.credential.token;return this._normalizeSSL(b?a+(-1<a.indexOf("?")?"\x26":"?")+"token\x3d"+b:a)},b.prototype._requestToTypedArray=function(a,b,c){var d=this,g=function(c){return d._request(a,b).then(function(a){var b=e._resultsToTypedArray(c,{portal:d},a);return v(b.map(function(b){return"function"==typeof b.when?b.when():a})).always(function(){return b})})};return c?q.when(n,"./"+
c).then(function(a){return g(a)}):g()},b.prototype._request=function(a,b){var c=this.authMode===e.AUTH_MODE_ANONYMOUS?"anonymous":"auto",d=null,k="auto",f={f:"json"},h="json";b&&(b.authMode&&(c=b.authMode),b.body&&(d=b.body),b.method&&(k=b.method),b.query&&(f=x({},f,b.query)),b.responseType&&(h=b.responseType));b={authMode:c,body:d,callbackParamName:"callback",method:k,query:f,responseType:h,timeout:0};return A(this._normalizeSSL(a),b).then(function(a){return a.data})},b._resultsToTypedArray=function(a,
b,c){var d;return c?(d=c.listings||c.notifications||c.userInvitations||c.tags||c.items||c.groups||c.comments||c.provisions||c.results||c.relatedItems||c,(a||b)&&(d=d.map(function(c){c=H.mixin(a?a.fromJSON(c):c,b);return"function"==typeof c.load&&c.load(),c}))):d=[],d},b.AUTH_MODE_ANONYMOUS="anonymous",b.AUTH_MODE_AUTO="auto",b.AUTH_MODE_IMMEDIATE="immediate",c([d.property()],b.prototype,"access",void 0),c([d.property()],b.prototype,"allSSL",void 0),c([d.property()],b.prototype,"authMode",void 0),
c([d.property()],b.prototype,"authorizedCrossOriginDomains",void 0),c([d.reader("authorizedCrossOriginDomains")],b.prototype,"readAuthorizedCrossOriginDomains",null),c([d.property()],b.prototype,"basemapGalleryGroupQuery",void 0),c([d.property()],b.prototype,"bingKey",void 0),c([d.property()],b.prototype,"canListApps",void 0),c([d.property()],b.prototype,"canListData",void 0),c([d.property()],b.prototype,"canListPreProvisionedItems",void 0),c([d.property()],b.prototype,"canProvisionDirectPurchase",
void 0),c([d.property()],b.prototype,"canSearchPublic",void 0),c([d.property()],b.prototype,"canShareBingPublic",void 0),c([d.property()],b.prototype,"canSharePublic",void 0),c([d.property()],b.prototype,"canSignInArcGIS",void 0),c([d.property()],b.prototype,"canSignInIDP",void 0),c([d.property()],b.prototype,"colorSetsGroupQuery",void 0),c([d.property()],b.prototype,"commentsEnabled",void 0),c([d.property({type:Date})],b.prototype,"created",void 0),c([d.property()],b.prototype,"credential",void 0),
c([d.property()],b.prototype,"culture",void 0),c([d.property()],b.prototype,"customBaseUrl",void 0),c([d.property()],b.prototype,"defaultBasemap",void 0),c([d.reader("defaultBasemap")],b.prototype,"readDefaultBasemap",null),c([d.property({type:B})],b.prototype,"defaultExtent",void 0),c([d.property()],b.prototype,"defaultVectorBasemap",void 0),c([d.reader("defaultVectorBasemap")],b.prototype,"readDefaultVectorBasemap",null),c([d.property()],b.prototype,"description",void 0),c([d.property({dependsOn:["id",
"canSearchPublic"],readOnly:!0})],b.prototype,"extraQuery",null),c([d.property()],b.prototype,"featuredGroups",void 0),c([d.property()],b.prototype,"featuredItemsGroupQuery",void 0),c([d.property()],b.prototype,"galleryTemplatesGroupQuery",void 0),c([d.property()],b.prototype,"livingAtlasGroupQuery",void 0),c([d.property()],b.prototype,"helpBase",void 0),c([d.property()],b.prototype,"helperServices",void 0),c([d.property()],b.prototype,"helpMap",void 0),c([d.property()],b.prototype,"homePageFeaturedContent",
void 0),c([d.property()],b.prototype,"homePageFeaturedContentCount",void 0),c([d.property()],b.prototype,"httpPort",void 0),c([d.property()],b.prototype,"httpsPort",void 0),c([d.property()],b.prototype,"id",void 0),c([d.property()],b.prototype,"ipCntryCode",void 0),c([d.property({dependsOn:["access"],readOnly:!0})],b.prototype,"isOrganization",null),c([d.property()],b.prototype,"isPortal",void 0),c([d.property()],b.prototype,"layerTemplatesGroupQuery",void 0),c([d.property()],b.prototype,"maxTokenExpirationMinutes",
void 0),c([d.property({type:Date})],b.prototype,"modified",void 0),c([d.property()],b.prototype,"name",void 0),c([d.property()],b.prototype,"portalHostname",void 0),c([d.property()],b.prototype,"portalMode",void 0),c([d.property()],b.prototype,"portalProperties",void 0),c([d.property()],b.prototype,"region",void 0),c([d.property({dependsOn:["url"],readOnly:!0})],b.prototype,"restUrl",null),c([d.property()],b.prototype,"rotatorPanels",void 0),c([d.property()],b.prototype,"showHomePageDescription",
void 0),c([d.property()],b.prototype,"staticImagesUrl",void 0),c([d.property()],b.prototype,"stylesGroupQuery",void 0),c([d.property()],b.prototype,"supportsHostedServices",void 0),c([d.property()],b.prototype,"symbolSetsGroupQuery",void 0),c([d.property()],b.prototype,"templatesGroupQuery",void 0),c([d.property()],b.prototype,"thumbnail",void 0),c([d.property({dependsOn:["restUrl","thumbnail"],readOnly:!0})],b.prototype,"thumbnailUrl",null),c([d.property()],b.prototype,"units",void 0),c([d.property()],
b.prototype,"url",void 0),c([d.property()],b.prototype,"urlKey",void 0),c([d.reader("urlKey")],b.prototype,"readUrlKey",null),c([d.property()],b.prototype,"user",void 0),c([d.reader("user")],b.prototype,"readUser",null),c([d.property()],b.prototype,"useStandardizedQuery",void 0),c([d.property()],b.prototype,"useVectorBasemaps",void 0),c([d.property()],b.prototype,"vectorBasemapGalleryGroupQuery",void 0),c([z(1,d.cast(p))],b.prototype,"_queryPortal",null),b=e=c([d.subclass("esri.portal.Portal")],b);
var e}(d.declared(C,D))});