//>>built
define("../core/declare ../core/Accessor ../core/JSONSupport ../core/kebabDictionary ../core/screenUtils ../core/lang ../core/Error ../support/arcadeUtils dojo/_base/lang ../Color ./support/utils ./support/AuthoringInfo".split(" "),function(K,L,M,u,A,x,C,t,n,l,N,O){var v=u({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),B=u({widthAndDepth:"width-and-depth"}),P=u({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",
millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"}),D=(u({classedSize:"classed-size",classedColor:"classed-color",univariateColorSize:"univariate-color-size"}),u({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),u({percentTotal:"percent-of-total"}),Math.PI);
return K([L,M],{declaredClass:"esri.renderers.Renderer",properties:{authoringInfo:{type:O,value:null,json:{write:!0}},requiredFields:{dependsOn:["visualVariables"],get:function(){var a=Object.create(null);return this.collectRequiredFields(a),Object.keys(a)}},type:{type:String,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}},visualVariables:{json:{read:{source:["visualVariables","rotationType","rotationExpression"],reader:function(a,b){return this._readVariables(a,b)}},write:function(a,b,c,d){var e=
[];a.forEach(function(a,b){"size"===a.type?e.push(this._writeSizeInfo(a,d,b)):"color"===a.type?e.push(this._writeColorInfo(a,d,b)):"opacity"===a.type?e.push(this._writeOpacityInfo(a,d,b)):"rotation"===a.type&&e.push(this._writeRotationInfo(a,d,b))},this);b.visualVariables=e}}}},constructor:function(){this._cache={}},_rotationRE:/^\[([^\]]+)\]$/i,_viewScaleRE:/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,_visualVariablesSetter:function(a){var b=this._cache;this.visualVariables&&this.visualVariables.forEach(function(a,
d){b.hasOwnProperty(d)&&(b[d]=null)},this);a&&a.some(function(a){return!!a.target})&&a.sort(function(a,b){return a.target===b.target?0:a.target?1:-1});a&&a.forEach(function(a,d){"color"===a.type?b[d]=this._processColorInfo(a):"opacity"===a.type?b[d]=this._processOpacityInfo(a):"size"===a.type?b[d]=this._processSizeInfo(a):"rotation"===a.type&&(b[d]=this._processRotationInfo(a))},this);this._set("visualVariables",a)},getSymbol:function(a,b){},getVisualVariableValues:function(a,b){var c,d=this.visualVariables;
return d&&(c=d.map(function(c){var d,e=c.type,f=e+"Info";switch(b=n.mixin({},b),b[f]=c,e){case "size":d=this.getSize(a,b);break;case "color":d=this.getColor(a,b);break;case "opacity":d=this.getOpacity(a,b);break;case "rotation":d=this.getRotationAngle(a,b)}return{variable:c,value:d}},this).filter(function(a){return null!=a.value},this)),c},hasVisualVariables:function(a,b){return a?!!this.getVisualVariablesForType(a,b):!!(this.getVisualVariablesForType("size",b)||this.getVisualVariablesForType("color",
b)||this.getVisualVariablesForType("opacity",b)||this.getVisualVariablesForType("rotation",b))},getVisualVariablesForType:function(a,b){var c,d=this.visualVariables;return d&&(c=d.filter(function(c){return c.type===a&&("string"==typeof b?c.target===b:!1===b?!c.target:!0)}),c&&0===c.length&&(c=void 0)),c},getSize:function(a,b){var c=this._getVarInfo(b&&b.sizeInfo,"size"),d=c.variable,c=this._cache[c.cacheKey],e=null;if(d)var h=d.minSize,e=d.maxSize,h="object"==typeof h&&h?this._getSize(a,h,c&&c.minSize,
b):h,e="object"==typeof e&&e?this._getSize(a,e,c&&c.maxSize,b):e,e=this._getSize(a,d,c&&c.root,b,[h,e]);return e},getSizeRangeAtScale:function(a,b){var c,d=this._getVarInfo(a,"size"),e=this._cache[d.cacheKey],h={scale:b};if(a=d.variable,a&&b)if(b=a.minSize,a=a.maxSize,b="object"==typeof b&&b?this._getSize({},b,e&&e.minSize,h):b,e="object"==typeof a&&a?this._getSize({},a,e&&e.maxSize,h):a,null!=b||null!=e)b>e&&(b=e=b),c={minSize:b,maxSize:e};return c},getColor:function(a,b){var c=this._getVarInfo(b&&
b.colorInfo,"color");return this._getColorComponent(a,c.variable,this._cache[c.cacheKey],b)},getOpacity:function(a,b){var c=this._getVarInfo(b&&b.opacityInfo,"opacity");return this._getColorComponent(a,c.variable,this._cache[c.cacheKey],b,!0)},getRotationAngle:function(a,b){var c=this._getVarInfo(b&&b.rotationInfo,"rotation"),d=c.variable,e=this._cache[c.cacheKey],h=d.axis||"heading",c="heading"===h&&"arithmetic"===d.rotationType?90:0,h="heading"===h&&"arithmetic"===d.rotationType?-1:1,d=d.field,
e=e&&e.compiledFunc,p=a.attributes,f=0;return(d||e)&&(e?f=t.executeFunction(e,t.createExecContext(a,t.getViewInfo(b))):n.isFunction(d)?f=d.apply(this,arguments):p&&(f=p[d]||0),f="number"!=typeof f||isNaN(f)?null:c+h*f),f},collectRequiredFields:function(a){var b=[];this.visualVariables&&(b=b.concat(this.visualVariables));b.forEach(function(b){b&&(b.field&&(a[b.field]=!0),b.normalizationField&&(a[b.normalizationField]=!0),b.valueExpression&&t.extractFieldNames(b.valueExpression).forEach(function(b){a[b]=
!0}))})},_getVarInfo:function(a,b){var c;a&&a.type===b&&this.visualVariables?(c=this.visualVariables.indexOf(a),a=this.visualVariables[c]):this.visualVariables&&(a=(a=this.getVisualVariablesForType(b))&&a[0],c=this.visualVariables.indexOf(a));return{variable:a,cacheKey:c}},_readSizeInfo:function(a){return a.axis&&(a.axis=B.fromJSON(a.axis)),a.valueUnit&&(a.valueUnit=P.fromJSON(a.valueUnit)),a},_readColorInfo:function(a){return a&&(a.colors&&a.colors.forEach(function(b,c){n.isArray(b)?a.colors[c]=
l.fromJSON(b):a.colors[c]=new l(b)}),a.stops&&a.stops.forEach(function(b,c){b.color&&n.isArray(b.color)?a.stops[c].color=l.fromJSON(b.color):b.color&&(a.stops[c].color=new l(b.color))})),a},_readOpacityInfo:function(a){var b;return a&&(b=n.mixin({},a),b.transparencyValues&&(b.opacityValues=b.transparencyValues.map(function(a){return 1-a/100}),delete b.transparencyValues),b.stops&&(b.stops=b.stops.map(function(a){return a=n.mixin({},a),a.opacity=1-a.transparency/100,delete a.transparency,a}))),b},
_readVariables:function(a,b){a&&(a=a.map(function(a){return a=x.clone(a),a.type=v.fromJSON(a.type),"size"===a.type?a=this._readSizeInfo(a):"color"===a.type?a=this._readColorInfo(a):"opacity"===a.type&&(a=this._readOpacityInfo(a)),a},this));var c=b.rotationType;if(b=b.rotationExpression)c={type:"rotation",rotationType:c},(b=b.match(this._rotationRE))&&b[1]&&(c.field=b[1],a||(a=[]),a.push(c));return a},_createCache:function(a){var b=a&&a.valueExpression,c=t.createSyntaxTree(b),c=t.createFunction(c),
d=!(!a||!a.expression)||this._viewScaleRE.test(b);return{ipData:this._interpolateData(a),hasExpr:!!b,compiledFunc:c,isScaleDriven:d}},_processColorInfo:function(a){return a&&(a.colors&&a.colors.forEach(function(b,c){b instanceof l||(a.colors[c]=new l(b))}),a.stops&&a.stops.forEach(function(b,c){!b.color||b.color instanceof l||(a.stops[c].color=new l(b.color))}),this._sortStops(a.stops)),this._createCache(a)},_processOpacityInfo:function(a){return this._sortStops(a&&a.stops),this._createCache(a)},
_processSizeInfo:function(a){return a.stops&&Array.isArray(a.stops)?a.stops=this._processSizeInfoStops(a.stops):(a.minSize=a.minSize&&this._processSizeInfoSize(a.minSize),a.maxSize=a.maxSize&&this._processSizeInfoSize(a.maxSize)),{root:this._createCache(a),minSize:this._createCache(a.minSize),maxSize:this._createCache(a.maxSize)}},_processSizeInfoSize:function(a){return"object"==typeof a?a.stops=this._processSizeInfoStops(a.stops):a=A.toPt(a),a},_processSizeInfoStops:function(a){return a&&Array.isArray(a)&&
(a.forEach(function(a){a.size=A.toPt(a.size)}),this._sortStops(a)),a},_sortStops:function(a){a&&Array.isArray(a)&&a.sort(function(a,c){return a.value-c.value})},_processRotationInfo:function(a){return this._createCache(a)},_getSize:function(a,b,c,d,e){var h=a.attributes,p=b.field,f=b.stops,g=0,l=c&&c.hasExpr,w=c&&c.compiledFunc,u=c&&c.ipData,x=c&&c.isScaleDriven,F="number"==typeof a,m=F?a:null;if(p||x||l){var q,v=d&&d.scale,k=e?e[0]:b.minSize,r=e?e[1]:b.maxSize,y=b.minDataValue,G=b.maxDataValue,A=
b.valueUnit||"unknown",H=b.valueRepresentation,C=b.scaleBy,B=b.normalizationField,E=h?parseFloat(h[B]):void 0,z=d&&d.shape;if(x?m=null==v?this._getAverageValue(b):v:"number"!=typeof m&&(l?m=t.executeFunction(w,t.createExecContext(a,t.getViewInfo(d))):n.isFunction(p)?m=p.apply(this,arguments):h&&(m=h[p])),null==m||B&&!F&&(isNaN(E)||0===E))return null;if(isNaN(E)||F||(m/=E),f){var I,J,r=this._lookupData(m,u);q=r[0];k=r[1];q===k?g=f[q].size:(I=f[q].size,J=f[k].size,g=I+(J-I)*r[2])}else null!=k&&null!=
r&&null!=y&&null!=G?y>=m?g=k:m>=G?g=r:(q=(m-y)/(G-y),"area"===C&&z)?(f=(g="circle"===z)?D*Math.pow(k/2,2):k*k,f+=q*((g?D*Math.pow(r/2,2):r*r)-f),g=g?2*Math.sqrt(f/D):Math.sqrt(f)):g=k+q*(r-k):"unknown"===A?null!=k&&null!=y?(k&&y?(q=m/y,g="circle"===z?2*Math.sqrt(q*Math.pow(k/2,2)):"square"===z||"diamond"===z||"image"===z?Math.sqrt(q*Math.pow(k,2)):q*k):g=m+(k||y),g=k>g?k:g,null!=r&&g>r&&(g=r)):g=m:(f=(d&&d.resolution?d.resolution:1)*N.meterIn[A],"area"===H?(g=Math.sqrt(m/D)/f,g*=2):(g=m/f,("radius"===
H||"distance"===H)&&(g*=2)),null!=k&&k>g&&(g=k),null!=r&&g>r&&(g=r))}else b&&(g=f&&f[0]&&f[0].size,null==g&&(g=b.minSize));return g=isNaN(g)?0:g},_getAverageValue:function(a){var b,c,d=a.stops;return d?(b=d[0].value,c=d[d.length-1].value):(b=a.minDataValue||0,c=a.maxDataValue||0),(b+c)/2},_getColorComponent:function(a,b,c,d,e,h){var p,f=a.attributes,g=b&&b.field,l="number"==typeof a,w=l?a:null,u=c&&c.hasExpr,x=c&&c.compiledFunc,v=c&&c.ipData;if(g||u){var m=b.normalizationField,q=f?parseFloat(f[m]):
void 0;"number"!=typeof w&&(u?w=t.executeFunction(x,t.createExecContext(a,t.getViewInfo(d))):n.isFunction(g)?w=g.apply(this,arguments):f&&(w=f[g]));null==w||m&&!l&&(isNaN(q)||0===q)||(isNaN(q)||l||(w/=q),p=e?this._getOpacity(w,b,v):this._getColor(w,b,v))}else b&&(f=b.stops,e?(p=f&&f[0]&&f[0].opacity,null==p&&(p=b.opacityValues&&b.opacityValues[0])):p=f&&f[0]&&f[0].color||b.colors&&b.colors[0]);return h&&(h.data=w,h.value=p),h||p},_interpolateData:function(a){var b;if(a)if(a.colors||a.opacityValues){var c=
(a.colors||a.opacityValues).length,d=a.minDataValue,e=(a.maxDataValue-d)/(c-1);b=[];for(a=0;c>a;a++)b[a]=d+a*e}else a.stops&&(b=a.stops.map(function(a){return a.value}));return b},_getOpacity:function(a,b,c){var d;a=this._lookupData(a,c);if(b=b||this.opacityInfo,a){var e,h;c=a[0];var p=a[1];c===p?d=this._getOpacValue(b,c):(e=this._getOpacValue(b,c),h=this._getOpacValue(b,p),d=e+(h-e)*a[2])}return d},_getOpacValue:function(a,b){return a.opacityValues?a.opacityValues[b]:a.stops[b].opacity},_getColor:function(a,
b,c){var d;a=this._lookupData(a,c);if(b=b||this.colorInfo,a)d=a[0],c=a[1],d=d===c?this._getColorObj(b,d):l.blendColors(this._getColorObj(b,d),this._getColorObj(b,c),a[2]),d=new l(d);return d},_getColorObj:function(a,b){return a.colors?a.colors[b]:a.stops[b].color},_lookupData:function(a,b){var c;if(b){var d=0,e=b.length-1;b.some(function(b,c){return b>a?(e=c,!0):(d=c,!1)});c=[d,e,(a-b[d])/(b[e]-b[d])]}return c},_processForContext:function(a,b,c){if(b&&"web-scene"===b.origin){var d=null!=a.expression,
e=null!=a.valueExpressionTitle&&"rotation"===a.type;b.messages&&(d&&b.messages.push(new C("property:unsupported",a.type+"VisualVariable.expression is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:c+".expression",context:b})),e&&b.messages.push(new C("property:unsupported",a.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:c+".valueExpressionTitle",
context:b})));d&&delete a.expression;e&&delete a.valueExpressionTitle}else"size"===a.type&&this._convertExpressionToArcade(a)},_writeRotationInfo:function(a,b,c){return a&&(a=n.mixin({},a),this._processForContext(a,b,"visualVariables["+c+"]"),a.type=v.toJSON(a.type),a=x.fixJson(a,!0)),a},_convertExpressionToArcade:function(a){a&&a.expression&&(a.valueExpression="$view.scale")},_writeSizeInfo:function(a,b,c){if(a){a=n.mixin({},a);this._processForContext(a,b,"string"==typeof c?c:"visualVariables["+
c+"]");var d=a.minSize,e=a.maxSize;d&&(a.minSize="number"==typeof d?d:this._writeSizeInfo(d,b,"visualVariables["+c+"].minSize"));e&&(a.maxSize="number"==typeof e?e:this._writeSizeInfo(e,b,"visualVariables["+c+"].maxSize"));b=a.legendOptions;c=a.axis;a.type=v.toJSON(a.type);c&&(a.axis=B.toJSON(c));b&&(a.legendOptions=n.mixin({},b),b=b.customValues,b&&(a.legendOptions.customValues=b.slice(0)));a.stops&&(a.stops=a.stops.map(function(a){return a=n.mixin({},a),null===a.label&&delete a.label,a}));a=x.fixJson(a,
!0)}return a},_writeColorInfo:function(a,b,c){return a&&(a=n.mixin({},a),this._processForContext(a,b,"visualVariables["+c+"]"),a.type=v.toJSON(a.type),a.colors&&(a.colors=a.colors.map(function(a){return l.toJSON(a)})),a.stops&&(a.stops=a.stops.map(function(a){return a=n.mixin({},a),a.color&&(a.color=l.toJSON(a.color)),null===a.label&&delete a.label,a})),a.legendOptions&&(a.legendOptions=n.mixin({},a.legendOptions)),a=x.fixJson(a,!0)),a},_writeOpacityInfo:function(a,b,c){var d;return a&&(d=n.mixin({},
a),this._processForContext(d,b,"visualVariables["+c+"]"),d.type=v.toJSON(d.type),d.opacityValues&&(d.transparencyValues=d.opacityValues.map(function(a){return Math.max(0,Math.min(Math.round(100*(1-a)),100))}),delete d.opacityValues),d.stops&&(d.stops=d.stops.map(function(a){a=n.mixin({},a);return a.transparency=Math.max(0,Math.min(Math.round(100*(1-a.opacity)),100)),delete a.opacity,null===a.label&&delete a.label,a})),d.legendOptions&&(d.legendOptions=n.mixin({},d.legendOptions)),d=x.fixJson(d,!0)),
d}})});