//>>built
define("require exports dojo/_base/lang ../../../core/promiseUtils ../../../tasks/support/GenerateRendererParameters ./support/utils ../support/utils ../../../layers/support/fieldUtils".split(" "),function(x,y,p,f,q,d,k,m){function r(a){if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))return f.reject(d.createError("histogram:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var b=p.mixin({},a);b.normalizationType=d.getNormalizationType(b);
a=[0,1,2];var e=k.createLayerAdapter(b.layer,a);return b.layer=e,e?e.load().then(function(){var a=b.valueExpression||b.sqlExpression,c=b.field,l=c?e.getField(c):null,g=!b.classificationMethod||"equal-interval"===b.classificationMethod,c=k.getFieldsList({field:c,normalizationField:b.normalizationField,valueExpression:b.valueExpression});if(c=d.verifyBasicFieldValidity(e,c,"histogram:invalid-parameters"))return f.reject(c);if(l){if(a=d.verifyFieldType(e,l,"histogram:invalid-parameters",t))return f.reject(a);
if(m.isDateField(l)){if(b.normalizationType)return f.reject(d.createError("histogram:invalid-parameters","Normalization is not allowed for date fields"));if(!g)return f.reject(d.createError("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed for date fields"))}}else if(a){if(b.normalizationType)return f.reject(d.createError("histogram:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified"));if(!g)return f.reject(d.createError("histogram:invalid-parameters",
"'classificationMethod' other than 'equal-interval' is not allowed when 'valueExpression' or 'sqlExpression' is specified"))}return b}):f.reject(d.createError("histogram:invalid-parameters","'layer' must be one of these types: "+k.getLayerTypeLabels(a).join(", ")))}function u(a,b,e){var h=[],c=a.classBreakInfos,f=c[0].minValue,g=c[c.length-1].maxValue;return c.forEach(function(a){h.push([a.minValue,a.maxValue])}),{min:f,max:g,intervals:h,sqlExpr:d.getFieldExpr(e,a.normalizationTotal),excludeZerosExpr:b,
normTotal:a.normalizationTotal}}function n(a,b){var e=a.layer,f=d.getSQLFilterForNormalization(a);b=new q({classificationDefinition:d.createCBDefn(a,a.numBins||v),where:d.mergeWhereClauses(f,b)});return e.generateRenderer(b).then(function(b){return u(b,f,a)})}function w(a){var b=a.layer,e=a.minValue,h=a.maxValue,c=b.supportsSQLExpression,l=null!=e&&null!=h,g=!a.classificationMethod||"equal-interval"===a.classificationMethod;return a.valueExpression||a.sqlExpression||c&&g?b.histogram(a):a.normalizationType||
!g?n(a).then(function(b){if(l){if(e>b.max||h<b.min)return f.reject(d.createError("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));var c=d.getFieldExpr(a,b.normTotal),c=d.getRangeExpr(c,e,h);return g?k.getBins({layer:a.layer,field:a.field,numBins:a.numBins},{min:e,max:h,sqlExpr:b.sqlExpr,excludeZerosExpr:b.excludeZerosExpr}):n(a,c).then(function(b){return k.getBins({layer:a.layer,field:a.field,numBins:a.numBins},b)})}return k.getBins({layer:a.layer,
field:a.field,numBins:a.numBins},b)}):b.histogram(a)}var t=[].concat(m.numericTypes).concat("date"),v=10;return function(a){return r(a).then(function(a){return w(a)})}});