//>>built
define("require exports dojo/_base/lang ../../../core/promiseUtils ./support/utils ../support/utils ../../../tasks/support/UniqueValueDefinition ../../../tasks/support/GenerateRendererParameters ../../../layers/support/fieldUtils".split(" "),function(y,z,l,f,h,k,n,p,q){function r(a){if(!a||!a.layer||!a.field&&!a.valueExpression)return f.reject(h.createError("unique-values:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required"));var b=l.mixin({},a);a=[0,1,2];var c=k.createLayerAdapter(b.layer,
a);return b.layer=c,c?c.load().then(function(){var a=k.getFieldsList({field:b.field,valueExpression:b.valueExpression});return(a=h.verifyBasicFieldValidity(c,a,"unique-values:invalid-parameters"))?f.reject(a):b}):f.reject(h.createError("unique-values:invalid-parameters","'layer' must be one of these types: "+k.getLayerTypeLabels(a).join(", ")))}function t(a){return a.layer.uniqueValues(a).then(function(b){return m(a,b,u)})}function v(a){var b=a.layer,c=a.field,d=new n;d.attributeField=c;var e=new p;
return e.classificationDefinition=d,b.generateRenderer(e).then(function(d){var g={},e=b.getField(c),f=-1<q.numericTypes.indexOf(e&&e.type);return d.uniqueValueInfos.forEach(function(a){var b=a.value;null!=b&&""!==b&&("string"!=typeof b||""!==l.trim(b)&&"\x3cnull\x3e"!==b.toLowerCase())||(b=null);null==g[b]?g[b]={count:a.count,data:f&&b?Number(b):b}:g[b].count+=a.count}),m(a,{count:g},w)})}function m(a,b,c){var d=b.count;b=a.field;c=a.layer;c=(b?c.getField(b):null)&&c.getFieldDomain(b);b=[];a.returnAllCodedValues&&
c&&"coded-value"===c.type&&c.codedValues.forEach(function(a){a=a.code;d.hasOwnProperty(a)||(d[a]={data:a,count:0})});for(var e in d)a=d[e],b.push({value:a.data,count:a.count,label:a.label});return{uniqueValueInfos:b}}function x(a){return t(a).otherwise(function(b){return a.field?v(a):b})}var u="service-query",w="service-generate-renderer";return function(a){return r(a).then(function(a){return x(a)})}});