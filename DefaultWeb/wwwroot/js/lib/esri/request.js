//>>built
define("require dojo/_base/config dojo/Deferred dojo/_base/lang dojo/_base/url dojo/request dojo/io-query ./config ./core/Error ./core/global ./core/sniff ./core/lang ./core/urlUtils ./core/deferredUtils ./core/promiseUtils ./core/requireUtils dojo/has!host-browser?./core/request/script dojo/has!host-webworker?./core/workers/request".split(" "),function(S,T,w,u,L,F,G,U,H,V,n,A,g,W,r,X,Y,M){function Z(a){var c=G.objectToQuery(a.content);if(c&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+c),2E3<a.url.length){if(!g.isDataProtocol(a.url))return r.reject(u.mixin(Error(),
{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));if(3E6<a.url.length)return r.reject(u.mixin(Error(),{message:"When using responseType 'image', data URL length cannot exceed 3000000 characters."}))}var b=new Image;a.allowImageDataAccess&&(a.withCredentials?b.crossOrigin="use-credentials":b.crossOrigin="anonymous");var e=!1,d=new w(function(a){e=!0;b.onload=b.onerror=b.onabort=null;b.src=""}),c=function(a){b.onload=b.onerror=b.onabort=null;e||d.reject(Error("Unable to load the resource"))};
return b.onload=function(){b.onload=b.onerror=b.onabort=null;e||d.resolve(this)},b.onerror=c,b.onabort=c,b.alt="",b.src=a.url,d.promise}function I(a){return a=new L(a),(a.host+(a.port?":"+a.port:"")).toLowerCase()}function aa(){return J?J:J=X.when(S,"./identity/IdentityManager").then(function(a){k=a})}function ba(a,c){var b=!!a.useProxy,e=a.method||"auto",d=A.isDefined(a.crossOrigin)?a.crossOrigin:l.useCors;a=u.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));var h=a.content,p=a.url;
a._token&&(a.content=a.content||{},a.content.token=a._token);var q,C=0;p&&(q=G.objectToQuery(h),C=q.length+p.length+1,n("esri-url-encodes-apostrophe")&&(C=q.replace(/'/g,"%27").length+p.length+1));a.timeout=A.isDefined(a.timeout)?a.timeout:l.timeout;a.handleAs=a.handleAs||"json";try{var t,D,x=d&&g.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),N=g.hasSameOrigin(a.urlObj,g.appUrl)||x,y="post"===e||!!a.body||C>l.maxUrlLength,m=!N&&-1!==a.handleAs.indexOf("json")&&a.callbackParamName&&
!a.body,z=!!g.getProxyRule(a.url)||l.forceProxy||b||("image"!==a.handleAs||a.allowImageDataAccess)&&(!m||y)&&!N;if(z&&(g.isBlobProtocol(a.url)||g.isDataProtocol(a.url))&&(z=!1),(n("host-browser")||n("host-webworker"))&&z)if(t=g.getProxyUrl(p,d),D=t.path,t._xo&&(x=!0),!y&&D.length+1+C>l.maxUrlLength&&(y=!0),a.url=D+"?"+p,y)a.content=u.mixin(t.query||{},h);else{var O=G.objectToQuery(u.mixin(t.query||{},h));O&&(a.url+=(-1===p.indexOf("?")?"?":"\x26")+O);a.content=null}if(m&&!y&&!z&&n("host-browser"))return a=
B?B(a):a,a.jsonp=a.callbackParamName,a.query=a.content,Y.get(a.url,a);var f=a.headers;if(!n("host-browser")&&!n("host-webworker")||f&&f.hasOwnProperty("X-Requested-With")||(f=a.headers=f||{},f["X-Requested-With"]=null),n("host-browser")&&c){var K=a.content&&a.content.token;K&&(c.set?c.set("token",K):c.append("token",K));a.contentType=!1}if(x&&!a.hasOwnProperty("withCredentials")&&"with-credentials"===l.useCors){var b=z?D:p,r=g.getCorsConfig(b);if(r&&r.hasOwnProperty("withCredentials"))r.withCredentials&&
(a.withCredentials=!0);else if(k){var v=k.findServerInfo(b);v&&v.webTierAuth&&(a.withCredentials=!0)}}return a=B?B(a):a,"image"===a.handleAs?Z(a):y?(a.body?(a.data=c||a.body,a.query=a.content):a.data=a.content,delete a.body,delete a.content,!z&&n("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+ca++),F.post(a.url,a)):(a.query=a.content,delete a.content,F.get(a.url,a))}catch(da){return a=new w,a.reject(da),a.promise}}function ea(a){var c=l.corsStatus;try{var b=
I(a.url);if(l.corsDetection&&l.useCors&&n("esri-cors")&&a.url&&-1!==a.url.toLowerCase().indexOf("/rest/services")&&!g.hasSameOrigin(a.urlObj,g.appUrl)&&!g.canUseXhr(a.urlObj)){if(c[b])return c[b];var e=new w;c[b]=e.promise;var d=a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info";return F.get(d,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*l.corsDetectionTimeout}).then(function(c){c?(g.canUseXhr(a.url)||l.corsEnabledServers.push(b),e.resolve()):e.reject()},
function(a){e.reject()}),e.promise}}catch(h){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return fa}function v(a,c,b,e){function d(a){a&&(b._token=a.token,b._ssl=a.ssl)}function h(a){a._pendingDfd=ba(b,t);var c=!!a._pendingDfd.response;(a._pendingDfd.response||a._pendingDfd).then(function(a){if(!c||!a.data)return a;var b=a.getHeader("Content-Type");if(b&&(b=b.toLowerCase(),-1===b.indexOf("text/plain")&&-1===b.indexOf("application/json")))return a;b=a.data;
if(b instanceof ArrayBuffer&&750>=b.byteLength)b=new Blob([b]);else if(!(b instanceof Blob&&750>=b.size))return a;var m=new w,d=new FileReader;return d.readAsText(b),d.onloadend=function(){if(!d.error)try{var b=JSON.parse(d.result);b.error&&(Object.isExtensible(a)||(a=u.mixin({},a)),a._jsonData=b)}catch(ha){}m.resolve(a)},m.promise}).then(function(b){var d=c?b.data:b,m=c?b.getHeader.bind(b):P;if(d&&(b=c&&b._jsonData||d,b.error||"error"===b.status))throw d=u.mixin(Error(),b.error||b),d.getHeader=m,
d;a.resolve({data:d,url:e.url,requestOptions:e.requestOptions,getHeader:m});a._pendingDfd=null}).otherwise(function(c){var d,m,f;if(c&&(d=c.code,m=c.subcode,f=c.messageCode,f=f&&f.toUpperCase()),c&&403==d&&(4==m||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl)return b._ssl=b._sslFromServer=!0,void v(a,!0,b,e)}else if(c&&415==c.status){if(d=b.url,m=l.corsStatus,f=g.getCorsConfig(d,!0),-1<f&&l.corsEnabledServers.splice(f,1),f=new w,
f.reject({log:!!T.isDebug}),m[I(d)]=f.promise,!b._err415)return b._err415=1,void v(a,!0,b,e)}else if(n&&"no-prompt"!==b.authMode&&k._errorCodes&&-1!==k._errorCodes.indexOf(d)&&!k._isPublic(b.url)&&(403!=d||Q&&-1===Q.indexOf(f)&&(!A.isDefined(m)||2==m&&b._token)))return void ga(a,b,e,E("request:server",c,e));a.reject(E("request:server",c,e));a._pendingDfd=null})}var p,q=b.body,n=b.useIdentity,t=null,r=q instanceof FormData;(r||q&&q.elements)&&(t=r?q:new FormData(q));var x=!!(-1!==b.url.toLowerCase().indexOf("token\x3d")||
b.content&&b.content.token||t&&t.get&&t.get("token")||q&&q.elements&&q.elements.token);return c||(!n||x||b._token||k._isPublic(b.url)||("immediate"===b.authMode?p=k.getCredential(b.url).then(d):"no-prompt"===b.authMode?p=k.checkSignInStatus(b.url).then(d).otherwise(function(){}):d(k.findCredential(b.url))),a.then(function(a){if((/\/sharing\/rest\/accounts\/self/i.test(b.url)||/\/sharing\/rest\/portals\/self/i.test(b.url))&&!x&&!b._token&&a.user&&a.user.username){var c=l.corsEnabledServers,d=g.getCorsConfig(b.url,
!0),e={host:I(b.url),withCredentials:!0};if(-1===d)c.push(e);else{var h=c[d];"object"==typeof h?h.withCredentials=!0:c.splice(d,1,e)}}if(c=b._credential){var f;(d=(d=k.findServerInfo(c.server))&&d.owningSystemUrl)&&(d=d.replace(/\/?$/,"/sharing"),f=k.findCredential(d,c.userId),f&&-1===k._getIdenticalSvcIdx(d,f)&&f.resources.splice(0,0,d))}return a}).always(function(a){if(delete b._credential,a){var c=!!b._ssl;a instanceof H?a.details.ssl=c:a.ssl=c}})),p?p.then(function(){h(a)}).otherwise(function(b){a.reject(b)}):
h(a),a.promise}function ga(a,c,b,e){a._pendingDfd=k.getCredential(c.url,{error:e,token:c._token});a._pendingDfd.then(function(d){c._token=d.token;c._credential=d;c._ssl=c._sslFromServer||d.ssl;v(a,!0,c,b)}).otherwise(function(b){a.reject(b);a._pendingDfd=null})}function E(a,c,b){var e="Error",d={url:b.url,requestOptions:b.requestOptions,getHeader:P};if(c instanceof H)return c.details?(c.details=A.clone(c.details),c.details.url=b.url,c.details.requestOptions=b.requestOptions):c.details=d,c;if(c){var h=
c.response;b=h&&h.getHeader;var h=h&&h.status,g=c.message;b=c.getHeader||b;g&&(e=g);b&&(d.getHeader=b);d.httpStatus=(A.isDefined(c.httpCode)?c.httpCode:c.code)||h;d.subCode=c.subcode;d.messageCode=c.messageCode;"string"==typeof c.details?d.messages=[c.details]:d.messages=c.details}a=new H(a,e,d);return c&&"cancel"===c.dojoType&&(a.dojoType="cancel"),a}function R(a,c){if(M&&V.invokeStaticMessage)return M.execute(a,c);var b=u.mixin({},c),e={url:a,requestOptions:u.mixin({},c)};if(b.content=b.query,delete b.query,
b.preventCache=!!b.cacheBust,delete b.cacheBust,b.handleAs=b.responseType,delete b.responseType,"array-buffer"===b.handleAs&&(b.handleAs="arraybuffer"),"image"===b.handleAs){if(n("host-webworker")||n("host-node"))return r.reject(E("request:invalid-parameters",Error("responseType 'image' is not supported in Web Workers or Node environment"),e));b.preventCache&&(b.content=b.content||{},b.content["request.preventCache"]=Date.now());b.method="auto"}else if(g.isDataProtocol(a))return r.reject(E("request:invalid-parameters",
Error("Data URLs are not supported for responseType \x3d "+b.handleAs),e));var d=l.useIdentity;"anonymous"===b.authMode&&(d=!1);b.useIdentity=d;b.url=g.normalize(a);b.urlObj=new L(b.url);var h=W.makeDeferredCancellingPending();return ea(b).always(function(){return d&&!k?aa():void 0}).always(function(){v(h,!1,b,e)}),h.promise}var B,k,J,l=U.request,Q=["COM_0056","COM_0057"],ca=0,P=function(){return null},fa=(new w).resolve();return R.setRequestPreCallback=function(a){B=a},R});