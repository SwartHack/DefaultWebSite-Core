//>>built
define("../core/kebabDictionary ../core/urlUtils ../core/promiseUtils ../geometry/Polygon ../request dojo/_base/lang dojo/dom-construct dojox/gfx/canvas ./Geoprocessor ./support/PrintTemplate ./support/printTaskUtils ./Task".split(" "),function(r,x,C,D,E,m,F,y,G,H,t,I){function w(b){return!(!b||!b.path)}var z={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},A=r({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),J=r({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape",
"A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"}),K=r({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"});return I.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},
_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},_gpServerUrl:null,_is11xService:!1,_data:null,properties:{mode:{readonly:!0,value:"sync"},_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new G(this.url,{updateDelay:this.updateDelay})}},url:{value:null,type:String},updateDelay:{value:1E3,type:Number}},execute:function(b,d){var h=this.url.replace(/\/Export.*/,"");return C.resolve().then(function(){return this._gpServerUrl===h?{data:this._data}:(this._gpServerUrl=h,E(h,{query:{f:"json"}}))}.bind(this)).then(function(a){this._data=
a.data;this._is11xService=!!this._data.cimVersion;a=this._setPrintParams(b);this.mode===this._data.executionType?this._data.executionType:K.fromJSON(this._data.executionType);return this._geoprocessor["async"===this.mode?"submitJob":"execute"](a,d).then(this._handleExecuteResponse)}.bind(this))},_createOperationalLayers:function(b,d){var h,a,l,c,k=[],g=b.map.allLayers.filter(function(a){return a.parent&&"group"===a.parent.type&&!a.parent.visible?!1:!0}).items;for(h=0;h<g.length;h++)if(a=g[h],a.loaded&&
a.visible)switch(c={id:a.id,title:this._legendLayerNameMap[a.id]||a.title,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0,url:a.url&&x.normalize(a.url),token:a.token},l=a.declaredClass){case "esri.layers.ImageryLayer":var e={bandIds:a.bandIds,compressionQuality:a.compressionQuality,format:a.format,interpolation:a.interpolation};a.mosaicRule&&(e.mosaicRule=a.mosaicRule.toJSON());a.renderingRule&&(e.renderingRule=a.renderingRule.toJSON());k.push(m.mixin(c,e));this._legendLayers&&this._legendLayers.push({id:a.id});
break;case "esri.layers.OpenStreetMapLayer":m.mixin(c,{type:"OpenStreetMap"});k.push(c);break;case "esri.layers.GraphicsLayer":m.mixin(c,this._createFeatureCollectionJSON(a));k.push(c);this._legendLayers&&this._legendLayers.push({id:a.id});break;case "esri.layers.VectorTileLayer":if(this._is11xService){c={id:a.id,tiyle:a.title,type:"VectorTileLayer",layerType:"VectorTileLayer",styleUrl:a.url&&x.normalize(a.url),opacity:a.opacity,visibility:a.visible};k.push(c);break}c.type="image";c.url&&delete c.url;
var n=d.exportOptions&&d.exportOptions.dpi||96;l=d.exportOptions&&d.exportOptions.width%2===b.width%2;var f=d.exportOptions&&d.exportOptions.height%2===b.height%2,q={format:"png",pixelRatio:n/96,rotation:0},e=this._vtlExtent||b.extent.clone();"MAP_ONLY"!==d.layout||!d.preserveScale||d.outScale&&d.outScale!==b.scale||96!==n||l&&f||(q.area={x:0,y:0,width:b.width,height:b.height},l||(q.area.width+=1),f||(q.area.height+=1),this._vtlExtent)||(n=b.toMap({x:q.area.width,y:q.area.height}),e.ymin=n.y,e.xmax=
n.x,this._vtlExtent=e);c.extent=e.clone()._normalize(!0).toJSON();e=b.whenLayerView(a);e.isResolved()&&e.then(function(a){a=a.takeScreenshot(q,b);a.isResolved()?a.then(function(a){"data:image/png;base64,"===a.dataURL.substr(0,22)&&(c.imageData=a.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise");c.imageData&&k.push(c)});break;case "esri.layers.MapImageLayer":var p={id:a.id,subLayerIds:[]},u=[],t=b.scale,v=function(a){var b=0===t,c=0===
a.minScale||t<=a.minScale,d=0===a.maxScale||t>=a.maxScale;a.visible&&(b||c&&d)&&(a.sublayers?a.sublayers.forEach(v):(b=a.toExportImageJSON().drawingInfo,c=a.toJSON(),c.layerDefinition.drawingInfo=b,u.unshift(c),p.subLayerIds.push(a.id)))};a.sublayers&&a.sublayers.forEach(v);m.mixin(c,{layers:u,visibleLayers:p.subLayerIds});k.push(c);this._legendLayers.push(p);break;case "esri.layers.KMLLayer":this._is11xService?(c={},a.write(c,{origin:"web-map"}),c.showLabels=d.showLabels,k.push(c)):b.whenLayerView(a).then(function(b){b.allVisibleMapImages.forEach(function(b,
c){c={id:a.id+"_image"+c,type:"image",title:a.id,minScale:a.minScale||0,maxScale:a.maxScale||0,opacity:a.opacity,extent:b.extent.toJSON()};"data:image/png;base64,"===b.href.substr(0,22)?c.imageData=b.href.substr(22):c.url=b.href;k.push(c)});b=b.allVisiblePoints.concat(b.allVisiblePolylines).concat(b.allVisiblePolygons);var c={id:a.id};m.mixin(c,this._createFeatureCollectionJSON(null,b));k.push(c)}.bind(this));break;case "esri.layers.WMSLayer":u=[];v=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(v):
a.name&&u.unshift(a.name))};a.sublayers&&a.sublayers.forEach(v);m.mixin(c,{type:"wms",transparentBackground:a.imageTransparency,visibleLayers:u,version:a.version});k.push(c);break;case "esri.layers.WMTSLayer":e=a.activeLayer;m.mixin(c,{type:"wmts",layer:e.id,style:e.styleId,format:e.imageFormat,tileMatrixSet:e.tileMatrixSetId});k.push(c);break;case "esri.layers.WebTileLayer":e=a.urlTemplate.replace(/\$\{/g,"{");m.mixin(c,{type:"WebTiledLayer",urlTemplate:e,credits:a.copyright});a.subDomains&&0<a.subDomains.length&&
(c.subDomains=a.subDomains);k.push(c);break;case "esri.layers.CSVLayer":if(this._is11xService){c={};a.write(c,{origin:"web-map"});k.push(c);break}case "esri.layers.StreamLayer":case "esri.layers.FeatureLayer":n=(e=a.renderer)&&!e.hasVisualVariables()&&!a.featureReduction&&!e.valueExpression&&"esri.layers.CSVLayer"!==l;l="esri.layers.FeatureLayer"===l&&a.source&&a.source.length||"esri.layers.StreamLayer"===l;if(!this._is11xService&&!n||l){var B;b.whenLayerView(a).then(function(a){return a.queryGraphics&&
a.queryGraphics()||a.featuresView.graphics}).then(function(a){B=a.map(function(a){return a.geometry.hasZ=!1,a})});m.mixin(c,this._createFeatureCollectionJSON(a,B))}else c={},a.write(c,{origin:"web-map"}),c.layerDefinition&&c.layerDefinition.drawingInfo&&c.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(c.layerDefinition.drawingInfo.renderer);e.visualVariables&&e.visualVariables[0]&&e.visualVariables[0].maxSize&&"number"!=typeof e.visualVariables[0].maxSize&&e.visualVariables[0].minSize&&
"number"!=typeof e.visualVariables[0].minSize&&(e=e.getSizeRangeAtScale(e.visualVariables[0],b.scale),c.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=e.minSize,c.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=e.maxSize);k.push(c);this._legendLayers&&this._legendLayers.push({id:a.id});break;case "esri.layers.MapNotesLayer":var r=[];a.featureCollections.map(function(a){var b=a.source.toArray();a=this._createFeatureCollectionJSON(a,b).featureCollection;r=r.concat(a.layers)}.bind(this));
m.mixin(c,{featureCollection:{layers:r}});k.push(c);break;default:k.push(c)}b.graphics&&b.graphics.length&&(c=this._createFeatureCollectionJSON({},b.graphics))&&k.push(c);return k},_createFeatureCollectionJSON:function(b,d){var h=t.createPolygonLayer(),a=t.createPolylineLayer(),l=t.createPointLayer(),c=t.createMultipointLayer(),k=t.createPointLayer();if(k.layerDefinition.name="textLayer",delete k.layerDefinition.drawingInfo,b&&("esri.layers.FeatureLayer"===b.declaredClass||"esri.layers.StreamLayer"===
b.declaredClass?h.layerDefinition.name=a.layerDefinition.name=l.layerDefinition.name=c.layerDefinition.name=this._legendLayerNameMap[b.id]||b.get("arcgisProps.title")||b.title:"esri.layers.GraphicsLayer"===b.declaredClass&&(d=b.graphics.items)),b&&b.renderer&&!m.isFunction(b.get("renderer.field"))){var g=b.renderer.toJSON();h.layerDefinition.drawingInfo.renderer=g;a.layerDefinition.drawingInfo.renderer=g;l.layerDefinition.drawingInfo.renderer=g;c.layerDefinition.drawingInfo.renderer=g}else delete h.layerDefinition.drawingInfo,
delete a.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete c.layerDefinition.drawingInfo;var e=b&&b.fields,g=b&&b.renderer,n=[];g&&!m.isFunction(b.get("renderer.field"))&&("class-breaks"===g.type?(e||(e=[{name:g.field,type:"esriFieldTypeDouble"}],g.normalizationField&&e.push({name:g.normalizationField,type:"esriFieldTypeDouble"})),g.field&&n.push(g.field),g.normalizationField&&n.push(g.normalizationField)):"unique-value"===g.type&&(e||(e=[{name:g.field,type:"esriFieldTypeString"}],
g.field2&&e.push({name:g.field2,type:"esriFieldTypeString"}),g.field3&&e.push({name:g.field3,type:"esriFieldTypeString"})),g.field&&n.push(g.field),g.field2&&n.push(g.field2),g.field3&&n.push(g.field3)));e&&(h.layerDefinition.fields=e,a.layerDefinition.fields=e,l.layerDefinition.fields=e,c.layerDefinition.fields=e);for(var f,e=d&&d.length,q=0;e>q;q++){var p=d[q]||d.getItemAt(q);if(!1!==p.visible&&p.geometry&&(f=p.toJSON(),f.hasOwnProperty("popupTemplate")&&delete f.popupTemplate,f.geometry&&f.geometry.z&&
delete f.geometry.z,!f.symbol||!f.symbol.outline||"esriCLS"!==f.symbol.outline.type||this._is11xService)){if(f.symbol&&f.symbol.outline&&f.symbol.outline.color&&f.symbol.outline.color[3]&&!this._is11xService&&(f.symbol.outline.color[3]=255),b&&b.renderer&&!f.symbol&&(m.isFunction(b.renderer.field)||b.renderer.compiledFunc||b.renderer.hasVisualVariables()||b.renderer)){var g=b.renderer,u=g.getSymbol(p);if(!u)continue;f.symbol=u.toJSON();g.hasVisualVariables()&&t.applyVisualVariables(f.symbol,{renderer:g,
graphic:p,symbol:u})}if(f.symbol&&(f.symbol.angle||delete f.symbol.angle,f.symbol.path?f.symbol=this._convertSvgToPictureMarkerSymbolJson(f.symbol):f.symbol.text&&delete f.attributes),b&&b.renderer&&"simple"===b.renderer.type)delete f.attributes;else if(n.length){var r={};n.forEach(function(a){f.attributes&&f.attributes.hasOwnProperty(a)&&(r[a]=f.attributes[a])});f.attributes=r}"polygon"===p.geometry.type?h.featureSet.features.push(f):"polyline"===p.geometry.type?a.featureSet.features.push(f):"point"===
p.geometry.type?f.symbol&&f.symbol.text?k.featureSet.features.push(f):l.featureSet.features.push(f):"multipoint"===p.geometry.type?c.featureSet.features.push(f):"extent"===p.geometry.type&&(f.geometry=D.fromExtent(p.geometry).toJSON(),h.featureSet.features.push(f))}}b=[h,a,c,l,k].filter(function(a){return 0<a.featureSet.features.length});return b.forEach(function(a){a.featureSet.features.every(function(a){return a.symbol})&&(a.featureSet.features.forEach(function(a){delete a.attributes}),delete a.layerDefinition.drawingInfo);
a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(a.layerDefinition.drawingInfo.renderer)},this),{featureCollection:{layers:b}}},_convertSvgToPictureMarkerSymbolJson:function(b){this._canvasParent||(this._canvasParent=F.create("div"),this._canvasSurface=y.createSurface(this._canvasParent,200,200));var d=this._canvasSurface.createObject(y.Path,b.path).setFill(b.color).setStroke(b.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);
var h=this._canvasSurface.rawNode.getContext("2d"),d=d.getBoundingBox(),a=Math.ceil(d.width+d.x),l=Math.ceil(d.height+d.y),c=h.getImageData(d.x,d.y,a,l);h.canvas.width=a;h.canvas.height=l;h.putImageData(c,0,0);return{type:"esriPMS",imageData:h.canvas.toDataURL("image/png").substr(22),angle:-b.angle,contentType:"image/png",height:b.size?b.size:l-d.y,width:b.size?b.size:a-d.x,xoffset:b.xoffset,yoffset:b.yoffset}},_convertSvgRenderer:function(b){var d=b.type;if("simple"===d&&w(b.symbol))return void(b.symbol=
this._convertSvgToPictureMarkerSymbolJson(b.symbol));if("unique-value"===d||"class-breaks"===d)d=b["unique-value"===d?"uniqueValueInfos":"classBreakInfos"],w(b.defaultSymbol)&&(b.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(b.defaultSymbol)),d&&d.forEach(function(b){w(b)&&(b.symbol=this._convertSvgToPictureMarkerSymbolJson(b.symbol))},this)},_getPrintDefinition:function(b,d){var h=b.view,a=h.map,l=h.spatialReference,c={operationalLayers:this._createOperationalLayers(h,d)};b=this._vtlExtent||
b.extent||h.extent;return l&&l.isWrappable&&(b=b.clone()._normalize(!0),l=b.spatialReference),c.mapOptions={extent:b&&b.toJSON(),spatialReference:l&&l.toJSON(),showAttribution:d.attributionVisible},this._vtlExtent=null,h.rotation&&(c.mapOptions.rotation=-h.rotation),d.preserveScale&&(c.mapOptions.scale=d.outScale||h.scale),a.timeExtent&&(c.mapOptions.time=[a.timeExtent.startTime.getTime(),a.timeExtent.endTime.getTime()]),c},_handleExecuteResponse:function(b){return"sync"===this.mode?b.results&&b.results[0]&&
b.results[0].value:this._geoprocessor.getResultData(b.jobId,"Output_File").then(function(b){return b.value})},_setPrintParams:function(b){var d=b.template||new H;null==d.showLabels&&(d.showLabels=!0);var h,a=d.exportOptions;if(a){h={dpi:a.dpi};var l=J.toJSON(d.layout);if("map_only"===l.toLowerCase()||""===l)h.outputSize=[a.width,a.height]}var c;if(a=d.layoutOptions){var k,g;"Miles"===a.scalebarUnit||"Kilometers"===a.scalebarUnit?(k="Kilometers",g="Miles"):("Meters"===a.scalebarUnit||"Feet"===a.scalebarUnit)&&
(k="Meters",g="Feet");c={titleText:a.titleText,authorText:a.authorText,copyrightText:a.copyrightText,customTextElements:a.customTextElements,scaleBarOptions:{metricUnit:A.toJSON(k),metricLabel:z[k],nonMetricUnit:A.toJSON(g),nonMetricLabel:z[g]}}}k=null;a&&a.legendLayers&&(k=a.legendLayers.map(function(a){this._legendLayerNameMap[a.layerId]=a.title;var b={id:a.layerId};return a.subLayerIds&&(b.subLayerIds=a.subLayerIds),b},this));a=this._getPrintDefinition(b,d);b.outSpatialReference&&(a.mapOptions.spatialReference=
b.outSpatialReference.toJSON());m.mixin(a,{exportOptions:h,layoutOptions:c});m.mixin(a.layoutOptions,{legendOptions:{operationalLayers:null!=k?k:this._legendLayers}});d={Web_Map_as_JSON:JSON.stringify(a),Format:d.format,Layout_Template:l};return b.extraParameters&&m.mixin(d,b.extraParameters),d}})});