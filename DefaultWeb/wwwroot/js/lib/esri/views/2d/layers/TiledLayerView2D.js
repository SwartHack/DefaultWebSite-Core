//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/ObjectPool ../../../core/Error ../../../core/promiseUtils ./LayerView2D ../tiling/TileInfoView ../tiling/TileKey ../tiling/TileQueue ../tiling/TileStrategy ../engine/Bitmap ../engine/BitmapSource ../engine/BitmapContainer ../engine/Canvas2DContainer ../engine/Tiled ../../layers/RefreshableLayerView".split(" "),function(A,B,e,k,f,l,g,m,n,p,q,r,
t,u,v,w,x,y,z){var h=function(d){function b(a){a=d.call(this,a)||this;return a.key=new q(0,0,0,0),a}return e(b,d),b.prototype.acquire=function(a){},b.prototype.release=function(){this.key.set(0,0,0,0)},b.pool=new l(b,!0),b}(y(u));return function(d){function b(){var a=null!==d&&d.apply(this,arguments)||this;return a._tileStrategy=null,a._tileInfoView=null,a._fetchQueue=null,a._tileRequests=new Map,a.container=new x,a.layer=null,a}return e(b,d),b.prototype.initialize=function(){var a,c=this.layer.tileInfo;
(c=c&&c.spatialReference)||(a=new g("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));c.equals(this.view.spatialReference)||(a=new g("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}));a&&this.addResolvingPromise(m.reject(a))},b.prototype.hitTest=function(a,c){return null},b.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=
a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")},b.prototype.attach=function(){var a=this;this._tileContainer=new w;this.container.addChild(this._tileContainer);this._tileInfoView=new p(this.layer.tileInfo,this.layer.fullExtent);this._fetchQueue=new r({tileInfoView:this._tileInfoView,process:function(c){return a.fetchTile(c)}});this._tileStrategy=new t({cachePolicy:"keep",acquireTile:function(c){return a.acquireTile(c)},releaseTile:function(c){return a.releaseTile(c)},
tileInfoView:this._tileInfoView})},b.prototype.detach=function(){this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=this._tileInfoView=this._tileContainer=null},b.prototype.moveStart=function(){this.requestUpdate()},b.prototype.viewChange=function(){this.requestUpdate()},b.prototype.moveEnd=function(){this.requestUpdate()},b.prototype.doRefresh=function(){var a=this;this.updateRequested||this.suspended||(this._fetchQueue.reset(),
this._tileStrategy.tiles.forEach(function(c){return a._enqueueTileFetch(c)}),this.notifyChange("updating"))},b.prototype.isUpdating=function(){var a=!0;return this._tileRequests.forEach(function(c){a=a&&c.isFulfilled()}),!a},b.prototype.getTileBounds=function(a,c){return this._tileStrategy.tileInfoView.getTileBounds(a,c)},b.prototype.getTileCoords=function(a,c){return this._tileStrategy.tileInfoView.getTileCoords(a,c)},b.prototype.getTileResolution=function(a){return this._tileStrategy.tileInfoView.getTileResolution(a)},
b.prototype.acquireTile=function(a){var c=h.pool.acquire();return c.key.set(a),this._tileInfoView.getTileCoords(c.coords,c.key),c.resolution=this._tileInfoView.getTileResolution(c.key),b=this._tileInfoView.tileInfo.size,c.width=b[0],c.height=b[1],this._enqueueTileFetch(c),this.requestUpdate(),c;var b},b.prototype.releaseTile=function(a){var c=this,b=this._tileRequests.get(a);b&&!b.isFulfilled()&&b.cancel();this._tileRequests["delete"](a);this._tileContainer.removeChild(a);a.once("detach",function(){h.pool.release(a);
c.requestUpdate()});this.requestUpdate()},b.prototype.fetchTile=function(a){var c=this,b=this.layer.tilemapCache;if(b){var d=a.level,e=a.row,f=a.col;return b.fetchAvailabilityUpsample(d,e,f,a).then(function(){return c._fetchImage(a)}).otherwise(function(){return a.level=d,a.row=e,a.col=f,c._fetchImage(a)})}return this._fetchImage(a)},b.prototype._enqueueTileFetch=function(a){var c=this;if(!this._fetchQueue.has(a.key)){var b=this._fetchQueue.push(a.key).then(function(b){a.source=b;a.once("attach",
function(){return c.requestUpdate()});c._tileContainer.addChild(a);c.requestUpdate()});this._tileRequests.set(a,b)}},b.prototype._fetchImage=function(a){var b=this;return this.layer.fetchTile(a.level,a.row,a.col,{timestamp:this.refreshTimestamp}).then(function(c){c=v.pool.acquire(c);return c.coords=b.getTileCoords(c.coords,a),c.resolution=b.getTileResolution(a),c})},b=k([f.subclass("esri.views.2d.layers.TiledLayerView2D")],b)}(f.declared(n,z))});