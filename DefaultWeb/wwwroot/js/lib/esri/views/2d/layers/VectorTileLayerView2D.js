//>>built
require({cache:{"esri/views/2d/tiling/TileInfoViewPOT":function(){define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ./TileKey ./TileInfoView".split(" "),function(w,x,t,u,l,r){return function(n){function q(){return null!==n&&n.apply(this,arguments)||this}return t(q,n),q.prototype.getTileParentId=function(b){b=l.pool.acquire(b);var d=0===b.level?null:l.getId(b.level-1,b.row>>1,b.col>>1,b.world);return l.pool.release(b),d},q.prototype.getTileIdAtParent=
function(b,d){d=l.pool.acquire(d);var e=this._infoByLevel[d.level];if(b.resolution<e.resolution)throw l.pool.release(d),Error("Cannot calculate parent tile. destination LOD's resolution "+b.resolution+" is not a parent resolution of "+e.resolution);if(b.resolution===e.resolution)return b=d.id,l.pool.release(d),b;e=d.level-b.level;if(0>e)throw l.pool.release(d),Error("Wrong way...!");b=l.getId(b.level,d.row>>e,d.col>>e,d.world);return l.pool.release(d),b},q}(r)})},"esri/views/vectorTiles/VectorTileContainer":function(){define("require exports ../../core/tsSupport/extendsHelper dojo/has ../../core/promiseUtils ../../core/libs/gl-matrix/vec3 ../../core/libs/gl-matrix/mat4 ../2d/engine/Container ./renderers/Renderer ./GeometryUtils".split(" "),
function(w,x,t,u,l,r,n,q,b,d){return function(e){function p(){var a=e.call(this)||this;return a.isInitialized=!1,a._displayWidth=0,a._displayHeight=0,a._pointToCallbacks=new Map,a._tileCoordinateScale=r.create(),a._orientationVec=r.create(),a._displayScale=r.create(),a._orientationVec.set([0,0,1]),a._defaultTransform=n.create(),a}return t(p,e),p.prototype.initialize=function(a,v,c,h){this._renderer=new b;this._renderer.initialize(a,v);this._tileInfoView=h;this._tileInfo=c;this.isInitialized=!0},p.prototype.destroy=
function(){this._renderer&&(this._renderer.dispose(),this._renderer=null)},p.prototype.hittest=function(a,b){var c=this,h=[a,b];return l.create(function(a,b){c._pointToCallbacks.set(h,{resolve:a,reject:b});c.requestRender()},function(){c._pointToCallbacks.has(h)&&c._pointToCallbacks["delete"](h)})},p.prototype.prepareChildrenRenderParameters=function(a){var b=a.state;return b&&this._tileInfo&&this.isInitialized?(a.displayLevel=this._tileInfo.scaleToZoom(b.scale),a.requiredLevel=this._tileInfoView.getClosestInfoForScale(b.scale).level,
a.renderer=this._renderer,a):a},p.prototype.renderChildren=function(a){var b=this;if(0!==this.children.length&&this.isInitialized&&a&&a.state){this.sortChildren(function(a,c){return a.key.level-c.key.level});for(var c=this.children.length,h=1;c>=h;h++){var d=this.children[h-1];d.attached&&(d.stencilData.reference=h,d.stencilData.mask=255)}this._updateTilesTransform(a.state,this._tileInfoView.getClosestInfoForScale(a.state.scale).level,this.children);c=a.context;if(c.setDepthWriteEnabled(!0),this._renderer.setStateParams(a.state,
a.devicePixelRatio,a.displayLevel),this._renderer.drawClippingMasks(c,this.children),c.setStencilWriteMask(0),c.setBlendFunctionSeparate(1,771,1,771),c.setStencilOp(7680,7680,7681),c.setDepthFunction(515),c.setBlendingEnabled(!1),c.setStencilTestEnabled(!0),c.setDepthTestEnabled(!0),c.setDepthWriteEnabled(!0),a.drawphase=0,e.prototype.renderChildren.call(this,a),c.setDepthWriteEnabled(!1),c.setBlendingEnabled(!0),a.drawphase=1,e.prototype.renderChildren.call(this,a),a.drawphase=2,e.prototype.renderChildren.call(this,
a),c.setStencilTestEnabled(!1),c.setDepthTestEnabled(!1),u("esri-vector-tiles-debug"))for(h=0,d=this.children;h<d.length;h++){var g=d[h];g.attached&&g.visible&&this._renderer.renderTileInfo(c,g)}0<this._pointToCallbacks.size&&(this._pointToCallbacks.forEach(function(c,f){c.resolve(b._hitTest(a,f[0],f[1]))}),this._pointToCallbacks.clear());this._renderer.needsRedraw()&&this.requestRender()}},p.prototype.removeAllChildren=function(){for(var a=0;a<this.children.length;a++)this.children[a].dispose();
e.prototype.removeAllChildren.call(this)},p.prototype._hitTest=function(a,b,c){var d=this._tileInfoView.getClosestInfoForScale(a.state.scale).level,e=[0,0];a.state.toMap(e,[b,c]);var g=a.state.clone(),m=g.viewpoint.clone(),f=m.targetGeometry;f.x=e[0];f.y=e[1];m.targetGeometry=f;g.viewpoint=m;g.size=[3,3];this._renderer.setStateParams(g,a.devicePixelRatio,a.displayLevel);return(a=this._renderer.hitTest({budget:a.budget,devicePixelRatio:a.devicePixelRatio,stationary:a.stationary,opacity:a.opacity,context:a.context,
displayLevel:a.displayLevel,requiredLevel:a.requiredLevel,renderer:a.renderer,layerOpacity:a.layerOpacity,state:g,drawphase:3},b,c,this.children,d,3,this._updateTilesTransform.bind(this)))&&0!==a.length?a[0]:null},p.prototype._updateTilesTransform=function(a,b,c){var d=1/a.width,e=1/a.height,g=[0,0];this._calculateRelativeViewProjMat(this._tileInfo.lodAt(b).resolution,a.resolution,a.rotation,this._tileInfo.size[1],4096,a.width,a.height,this._defaultTransform);for(var m=0;m<c.length;m++){var f=c[m];
a.toScreen(g,f.coords);g[1]=a.height-g[1];f.tileTransform.displayCoord[0]=2*g[0]*d-1;f.tileTransform.displayCoord[1]=2*g[1]*e-1;f.key.level===b&&4096===f.coordRange?f.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this._tileInfo.lodAt(f.key.level).resolution,a.resolution,a.rotation,this._tileInfo.size[1],f.coordRange,a.width,a.height,f.tileTransform.transform)}},p.prototype._calculateRelativeViewProjMat=function(a,b,c,e,l,g,m,f){var h=.125;512!==e&&4096!==l&&
(h=e/l);a=a/b*h;this._tileCoordinateScale.set([a,a,1]);(g!==this._displayWidth||m!==this._displayHeight)&&(this._displayScale.set([2/g,-2/m,1]),this._displayWidth=g,this._displayHeight=m);n.identity(f);n.scale(f,f,this._tileCoordinateScale);n.rotate(f,f,-c*d.C_DEG_TO_RAD,this._orientationVec);n.scale(f,f,this._displayScale);n.transpose(f,f)},p}(q)})},"*noref":1}});
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper dojo/has ../../../core/Logger ../../../core/accessorSupport/decorators ../../../core/HandleRegistry ../../../core/promiseUtils ../../../Graphic ./LayerView2D ../engine/StageGL ../tiling/TileInfoViewPOT ../tiling/TileStrategy ../tiling/TileKey ../tiling/TileQueue ../../../views/vectorTiles/TileHandler ../../../views/vectorTiles/VectorTileContainer ../../../views/vectorTiles/VectorTileDisplayObject ../../support/screenshotUtils".split(" "),function(w,
x,t,u,l,r,n,q,b,d,e,p,a,v,c,h,z,g,m,f){var A=r.getLogger("esri.views.2d.layers.VectorTileLayerView2D");return function(e){function k(){var a=null!==e&&e.apply(this,arguments)||this;return a._handles=new q,a._fetchQueue=null,a._tileRequests=new Map,a.container=new p,a}return t(k,e),k.prototype.hitTest=function(a,b){var y=this;return this._vectorTileContainer.hittest(a,b).then(function(a){var b=y._tileHandler.getStyleRepository().layers;if(null===a||0>a||a>=b.length)return null;a=new d({attributes:{layerId:a,
layerName:b[a].id}});return a.layer=y.layer,a})},k.prototype.update=function(a){if(this._vectorTileContainer&&this._vectorTileContainer.isInitialized){if(a.devicePixelRatio!==this._tileHandler.devicePixelRatio)return void this._start();this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();for(var b=0,c=this._vectorTileContainer.children;b<c.length;b++)this._tileHandler.updateTile(c[b],a);this.notifyChange("updating")}},k.prototype.attach=function(){l("esri-webgl")?
this._start():A.error("WebGL is required but not supported!")},k.prototype.detach=function(){this._stop()},k.prototype.moveStart=function(){this.requestUpdate()},k.prototype.viewChange=function(){this.requestUpdate()},k.prototype.moveEnd=function(){this.requestUpdate()},k.prototype.destroy=function(){this.container.dispose();this._vectorTileContainer.destroy();this._tileHandler.destroy()},k.prototype.takeScreenshot=function(a,c){return this.container?(a=f.adjustScreenshotSettings(a,c),this.container.takeScreenshot(a)):
b.reject("Could not find an object capable of capturing screenshot!")},k.prototype.isUpdating=function(){var a=!0;return this._tileRequests.forEach(function(b){a=a&&b.isFulfilled()}),!a},k.prototype.acquireTile=function(a){var b=this,d=c.pool.acquire();d.set(a.level,a.row,a.col,a.world);a=this._tileHandler.getRefKey(d);var e=this.updateParameters.state.rotation,f=this._tileHandler.getStyleRepository(),g=m.pool.acquire(d,a,this.layer.tileInfo,f,this._tileHandler.glyphMosaic,e);a=this._fetchQueue.push(g.key).then(function(a){g.setData(a.tileData,
a.workerId,a.connection);g.once("attach",function(){return b.requestUpdate()});b._vectorTileContainer.addChild(g);b.notifyChange("updating")});return this._tileRequests.set(d.id,a),this.notifyChange("updating"),g},k.prototype.releaseTile=function(a){var b=a.key.id,c=this._tileRequests.get(b);c.isFulfilled()||c.cancel();this._tileRequests["delete"](b);this._vectorTileContainer.removeChild(a);this.requestUpdate();a.once("detach",function(){return m.pool.release(a)});this.notifyChange("updating")},k.prototype._stop=
function(){this._handles.removeAll();this._tileStrategy&&this._tileStrategy.destroy();this._vectorTileContainer&&(this._vectorTileContainer.removeAllChildren(),this.container.removeChild(this._vectorTileContainer));this._tileHandler&&this._tileHandler.stop();m.pool.prune();this._vectorTileContainer=this._tileHandler=this._tileStrategy=this._tileInfoView=null},k.prototype._start=function(){var b=this;this._stop();this._handles.add(this.watch("layer.currentStyleInfo",function(){return b.attach()}));
this._vectorTileContainer=new g;this.container.addChild(this._vectorTileContainer);this._tileInfoView=new a(this.layer.tileInfo,this.layer.fullExtent);this._tileStrategy=new v({cachePolicy:"keep",acquireTile:function(a){return b.acquireTile(a)},releaseTile:function(a){return b.releaseTile(a)},tileInfoView:this._tileInfoView});this._fetchQueue=new h({tileInfoView:this._tileInfoView,process:function(a){return b._getTileData(a)}});this._tileHandler=new z(this.layer,function(){return b.requestUpdate()},
window.devicePixelRatio||1,!0,this._tileInfoView);this._tileHandler.start().then(function(){b._vectorTileContainer.initialize(b._tileHandler.spriteMosaic,b._tileHandler.glyphMosaic,b.layer.tileInfo,b._tileInfoView);b.requestUpdate()})},k.prototype._getTileData=function(a){return this._tileHandler.getTileData(a,this.updateParameters.state.rotation)},k=u([n.subclass("esri.views.2d.layers.VectorTileLayerView2D")],k)}(n.declared(e))});