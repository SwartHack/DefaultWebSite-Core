//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/ObjectPool ../../../core/HandleRegistry ./LayerView2D ../engine/Bitmap ../engine/BitmapSource ../engine/BitmapContainer ../engine/Canvas2DContainer ../engine/Tiled ../../../geometry/support/webMercatorUtils ../tiling/TileStrategy ../tiling/TileKey ../tiling/TileInfoView ../tiling/TileQueue ../../layers/RefreshableLayerView".split(" "),function(D,
E,h,k,g,l,m,n,p,q,r,t,u,v,w,x,y,z,A){var B=function(e){function c(a){a=e.call(this,a)||this;return a.key=new x(0,0,0,0),a}return h(c,e),c.prototype.acquire=function(a){},c.prototype.release=function(){this.key.set(0,0,0,0)},c.pool=new l(c,!0),c}(u(p)),C=[102113,102100,3857,3785,900913];return function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;return a._handles=new m,a._tileStrategy=null,a._tileInfoView=null,a._fetchQueue=null,a._tileRequests=new Map,a.container=new t,a.layer=null,
a}return h(c,e),c.prototype.hitTest=function(a,d){return null},c.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")},c.prototype.attach=function(){var a,d=this,b=this.layer.activeLayer;b.tileMatrixSetId?a=b.tileMatrixSet:(a=this._getTileMatrixSetBySpatialReference(b),b.tileMatrixSetId=a.id);var c=a.tileInfo.spatialReference,f=b.fullExtent&&b.fullExtent.clone();c.isWebMercator?f=v.geographicToWebMercator(f):
c.isWGS84||(f=a.fullExtent);this._tileContainer=new r;this.container.addChild(this._tileContainer);this._tileInfoView=new y(a.tileInfo,f);this._fetchQueue=new z({tileInfoView:this._tileInfoView,process:function(a){return d.fetchTile(a)}});this._tileStrategy=new w({cachePolicy:"keep",acquireTile:function(a){return d.acquireTile(a)},releaseTile:function(a){return d.releaseTile(a)},tileInfoView:this._tileInfoView});this._handles.add(b.watch("styleId",function(a){d._refresh()}));this._handles.add(this.layer.watch("activeLayer",
function(a){if(!a.tileMatrixSetId){var b=d._getTileMatrixSetBySpatialReference(d.layer.activeLayer);a.tileMatrixSetId=b.id}d._refresh()}))},c.prototype.detach=function(){this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=this._tileInfoView=this._tileContainer=null},c.prototype.moveStart=function(){this.requestUpdate()},c.prototype.viewChange=function(){this.requestUpdate()},c.prototype.moveEnd=
function(){this.requestUpdate()},c.prototype.doRefresh=function(){this.updateRequested||this.suspended||this._refresh()},c.prototype.isUpdating=function(){var a=!0;return this._tileRequests.forEach(function(d){a=a&&d.isFulfilled()}),!a},c.prototype.getTileBounds=function(a,d){return this._tileStrategy.tileInfoView.getTileBounds(a,d)},c.prototype.getTileCoords=function(a,d){return this._tileStrategy.tileInfoView.getTileCoords(a,d)},c.prototype.getTileResolution=function(a){return this._tileStrategy.tileInfoView.getTileResolution(a)},
c.prototype.acquireTile=function(a){var d=this,b=B.pool.acquire();b.key.set(a);this._tileInfoView.getTileCoords(b.coords,b.key);b.resolution=this._tileInfoView.getTileResolution(b.key);a=this._tileInfoView.tileInfo.size;b.width=a[0];b.height=a[1];a=this._fetchQueue.push(b.key).then(function(a){b.source=a;b.once("attach",function(){return d.requestUpdate()});d._tileContainer.addChild(b)});return this._tileRequests.set(b,a),this.requestUpdate(),b},c.prototype.releaseTile=function(a){var d=this._tileRequests.get(a);
d.isFulfilled()||d.cancel();this._tileRequests["delete"](a);this._tileContainer.removeChild(a);this.requestUpdate()},c.prototype.fetchTile=function(a){var d=this;return this.layer.fetchTile(a.level,a.row,a.col).then(function(b){b=q.pool.acquire(b);return b.coords=d.getTileCoords(b.coords,a),b.resolution=d.getTileResolution(a),b})},c.prototype._refresh=function(){var a=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(d){if(d.source){d.source=null;var b=a._fetchQueue.push(d.key).then(function(b){d.source=
b;d.requestRender();a.notifyChange("updating")});a._tileRequests.set(d,b)}});this.notifyChange("updating")},c.prototype._getTileMatrixSetBySpatialReference=function(a){var d=this.view.spatialReference,b=d.wkid,c=a.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===b});return!c&&d.isWebMercator&&(c=a.tileMatrixSets.find(function(a){return-1<C.indexOf(a.tileInfo.spatialReference.wkid)})),c},k([g.property({dependsOn:["updateRequested","attached"]})],c.prototype,"updating",void 0),
c=k([g.subclass("esri.views.2d.layers.WMTSLayerView2D")],c)}(g.declared(n,A))});