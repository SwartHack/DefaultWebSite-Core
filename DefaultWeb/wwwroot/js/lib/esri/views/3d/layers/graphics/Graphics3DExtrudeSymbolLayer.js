//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ../../../../geometry/Polygon ../../../../geometry/Point ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/lib/Util ./earcut/earcut ./graphicUtils".split(" "),function(M,oa,Y,Z,aa,
H,ba,ca,da,N,O,ea,fa,ga,ha,ia,ja,ka){function la(d,e,b,a,c,k,f,v,w,l,m,t,g,ma){var n=b.length/3,C=0;m+=2*a.count;var h=a.index,y=a.count,p=w,u=m;q.set(g,r);var x=0<t?1:-1,h=3*h,z=p;g=3*z;for(var A=p+y,p=3*A,D=0;y>D;++D)ma&&(r[0]=d[h+0],r[1]=d[h+1],r[2]=d[h+2],q.normalize(r)),c[g+0]=d[h+0],c[g+1]=d[h+1],c[g+2]=d[h+2],k[g+0]=e[h+0],k[g+1]=e[h+1],k[g+2]=e[h+2],f[g+0]=-x*r[0],f[g+1]=-x*r[1],f[g+2]=-x*r[2],v[z]=0,c[p+0]=d[h+0]+t*r[0],c[p+1]=d[h+1]+t*r[1],c[p+2]=d[h+2]+t*r[2],k[p+0]=e[h+0],k[p+1]=e[h+1],
k[p+2]=e[h+2],f[p+0]=x*r[0],f[p+1]=x*r[1],f[p+2]=x*r[2],v[A]=t,g+=3,p+=3,h+=3,z+=1,A+=1;h=0;g=3*u;p=3*(u+n);g=3*(u+n);p=3*u;d=P;e=Q;0>t&&(d=Q,e=P);for(D=0;n>D;++D)l[g+0]=b[h+d[0]],l[g+1]=b[h+d[1]],l[g+2]=b[h+d[2]],l[p+0]=b[h+e[0]]+y,l[p+1]=b[h+e[1]]+y,l[p+2]=b[h+e[2]]+y,g+=3,p+=3,h+=3;w+=2*a.count;m=m+2*n-(2*a.count+2*n);R(c,k,v,f,C,a.pathLengths[0],a.count,w,l,m,t);w+=4*a.pathLengths[0];m+=2*a.pathLengths[0];C+=a.pathLengths[0];for(b=1;b<a.pathLengths.length;++b)R(c,k,v,f,C,a.pathLengths[b],a.count,
w,l,m,t),w+=4*a.pathLengths[b],m+=2*a.pathLengths[b],C+=a.pathLengths[b]}function K(d,e,b,a,c,k,f){a[k]=a[f];f*=3;k*=3;d[k+0]=d[f+0];d[k+1]=d[f+1];d[k+2]=d[f+2];e[k+0]=e[f+0];e[k+1]=e[f+1];e[k+2]=e[f+2];b[k+0]=c[0];b[k+1]=c[1];b[k+2]=c[2]}function R(d,e,b,a,c,k,f,v,w,l,m){var t=c,g=c+1,r=c+f,n=c+f+1,C=v,h=v+1,y=v+2*k;v=v+2*k+1;0>m&&(t=c+f+1,n=c);l*=3;for(var p=0;k>p;++p){p===k-1&&(0<m?(g=c,n=c+f):(g=c,t=c+f));var u=d,x=t,z=g,A=r,D=I,x=3*x,z=3*z,A=3*A;q.set3(u[x++],u[x++],u[x++],L);q.set3(u[z++],u[z++],
u[z++],S);q.set3(u[A++],u[A++],u[A++],T);q.subtract(S,L,U);q.subtract(T,L,V);q.cross(V,U,D);q.normalize(D,D);K(d,e,a,b,I,C,t);K(d,e,a,b,I,h,g);K(d,e,a,b,I,y,r);K(d,e,a,b,I,v,n);w[l++]=C;w[l++]=y;w[l++]=v;w[l++]=C;w[l++]=v;w[l++]=h;t++;g++;r++;n++;C+=2;h+=2;y+=2;v+=2}}function na(d,e,b,a){var c=a.setAltitude;J.spatialReference=b.spatialReference;for(var k=d.getGeometryRecords(),f=k.length,v="absolute-height"!==e.mode,w=0,l=0;f>l;l++){var m=k[l].geometry,t=k[l].transformation,g=m.getData();E[0]=t[12];
E[1]=t[13];E[2]=t[14];m.invalidateBoundingInfo();for(var g=g.getVertexAttr(),m=g[F.POSITION].data,t=g[F.SIZE].data,g=g.mapPos.data,q=m.length/3,n=0,r=0,h=!1,y=0,p=0;q>p;p++){J.x=g[r];J.y=g[r+1];J.z=g[r+2];G[0]=m[n];G[1]=m[n+1];G[2]=m[n+2];var u=H.computeElevation(b,J,e,a,v?W:null);v&&(y+=W.terrainElevation);B[0]=m[n]+E[0];B[1]=m[n+1]+E[1];B[2]=m[n+2]+E[2];c(u+t[n/3],B);m[n]=B[0]-E[0];m[n+1]=B[1]-E[1];m[n+2]=B[2]-E[2];u=.01/a.unitInMeters;(Math.abs(G[0]-m[n])>u||Math.abs(G[1]-m[n+1])>u||Math.abs(G[2]-
m[n+2])>u)&&(h=!0);r+=3;n+=3}h&&d.geometryVertexAttrsUpdated(l);w+=y/q}return w/f}var F=ia.VertexAttrConstants,q=N.vec3d,X=N.mat4d,B=q.create(),r=q.create(),P=[0,2,1],Q=[0,1,2],J=new ca,W={verticalDistanceToGround:0,terrainElevation:0};M=function(d){function e(){return null!==d&&d.apply(this,arguments)||this}return Y(e,d),e.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var b=ka.validateSymbolLayerSize(this._getSymbolSize());if(b)return this._logWarning(b),void this.reject()}var b=
this._getStageIdHint(),a=this._getMaterialOpacityAndColor(),c=q.create(a),a=a[3],c={diffuse:c,ambient:c,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new ha(c,b+"_3dlinemat");this._context.stage.add(O.ModelContentType.MATERIAL,this._material);this.resolve()},e.prototype.destroy=function(){d.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&this._context.stage.remove(O.ModelContentType.MATERIAL,this._material.getId())},e.prototype.createGraphics3DGraphic=
function(b,a){var c=this._validateGeometry(b.geometry);if("polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for extrude symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",k="graphic"+b.uid,f=this._getVertexOpacityAndColor(a,Float32Array,255),e=this.getGraphicElevationContext(b);return this._createAs3DShape(b,c,a,f,e,k,b.uid)},e.prototype.layerPropertyChanged=function(b,a,c){if("opacity"===b)return a=this._getMaterialOpacity(),
c=1>a||this._isPropertyDriven("opacity"),this._material.setParameterValues({opacity:a,transparent:c}),!0;if("elevationInfo"===b){this._updateElevationContext();for(var k in a){var f=a[k];if(b=c(f))f=this.getGraphicElevationContext(f.graphic),b.needsElevationUpdates=H.needsElevationUpdates3D(f.mode),b.elevationContext.set(f)}return!0}return!1},e.prototype._getExtrusionSize=function(b){var a;return a=b.size&&this._isPropertyDriven("size")?H.getSingleSizeDriver(b.size,2):this._getSymbolSize(),a/=this._context.renderCoordsHelper.unitInMeters},
e.prototype._getSymbolSize=function(){return this.symbol.size||1},e.prototype._createAs3DShape=function(b,a,c,k,f,e,d){var l=b.geometry;"extent"===l.type&&(l=ba.fromExtent(l));b=l[a];var m=l.hasZ,v=[],g=[],r=[],n=q.create(),w=Array(6),h=this._context.renderSpatialReference===da.SphericalECEFSpatialReference,y=this._getExtrusionSize(c),p=q.create();h||this._context.renderCoordsHelper.worldUpAtPosition(null,p);c=H.getGeometryVertexData3D(b,m,l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,
this._context.renderCoordsHelper,f);if(this._logGeometryCreationWarnings(c,b,a,"ExtrudeSymbol3DLayer"),0<b.length){var u=c.geometryData.polygons,x=c.eleVertexData,z=c.vertexData;a=z.length/3;var A=new Float64Array(18*a),D=new Float64Array(18*a),E=new Float64Array(18*a),F=new Float64Array(6*a),B=0;a=function(a){var b=u[a],c=b.count,d=b.index;if(G._context.clippingExtent&&(H.computeBoundingBox(x,d,c,w),H.boundingBoxClipped(w,G._context.clippingExtent)))return"continue";var f=new Float64Array(x.buffer,
3*d*A.BYTES_PER_ELEMENT,3*c),m=b.holeIndices.map(function(a){return a-d}),f=ja(f,m,3);if(0<f.length){H.chooseOrigin(z,d,c,n);var m=new Uint32Array(6*c+2*f.length),l=6*c,q=new Float64Array(A.buffer,3*B*A.BYTES_PER_ELEMENT,3*l),t=new Float64Array(D.buffer,3*B*D.BYTES_PER_ELEMENT,3*l),C=new Float64Array(E.buffer,3*B*E.BYTES_PER_ELEMENT,3*l),I=new Float64Array(F.buffer,1*B*F.BYTES_PER_ELEMENT,1*l);la(z,x,f,b,q,C,t,I,0,m,0,y,p,h);H.subtractCoordinates(q,0,l,n);B+=6*c;b=G._createExtrudeGeometry(m,{positions:q,
elevation:C,normals:t,heights:I},k);a=new fa(b,e+"path"+a);a.singleUse=!0;v.push(a);g.push([G._material]);a=X.identity();X.translate(a,n,a);r.push(a)}};var G=this;for(b=0;b<u.length;++b)a(b);if(0<v.length)return d=new ea({geometries:v,materials:g,transformations:r,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicId:d},idHint:e}),d=new aa(this,d,v,null,null,na,f),d.alignedTerrainElevation=c.terrainElevation,d.needsElevationUpdates=H.needsElevationUpdates3D(f.mode),d}return null},e.prototype._createExtrudeGeometry=
function(b,a,c){for(var d=b.length,f=new Uint32Array(d),e=0;d>e;e++)f[e]=0;d={};e={};return d[F.POSITION]=b,d[F.NORMAL]=b,d[F.COLOR]=f,e[F.POSITION]={size:3,data:a.positions},e[F.NORMAL]={size:3,data:a.normals},e[F.COLOR]={size:4,data:c},e[F.SIZE]={size:1,data:a.heights},a.elevation&&(e.mapPos={size:3,data:a.elevation},d.mapPos=b),new ga(e,d)},e}(Z);var I=q.create(),L=q.create(),S=q.create(),T=q.create(),U=q.create(),V=q.create(),G=q.create(),E=q.create();return M});