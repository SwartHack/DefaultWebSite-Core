//>>built
define("require exports ../../support/earthUtils ../../support/projectionUtils ../../support/intersectionUtils ../../support/mathUtils ../../support/aaBoundingBox ../../support/aaBoundingRect ../../lib/glMatrix".split(" "),function(l,F,g,r,m,t,p,y,c){var z=-.3*g.earthRadius;l=.5*Math.PI;var A=l/Math.PI*180,B=l*g.earthRadius,C=.9*g.earthRadius,E=function(){function a(){this.extent=Array(4);this.planes=Array(4);this.maxSpan=0;this.center={origin:c.vec3d.create(),direction:c.vec3d.create()};for(var b=
0;4>b;b++)this.extent[b]={origin:c.vec3d.create(),originLength:0,direction:c.vec3d.create(),cap:{next:null,direction:c.vec3d.create()}},this.planes[b]=c.vec4d.create();this.planes[4]=c.vec4d.create()}return a.prototype.toRenderBoundingExtent=function(b,n,f,u){y.center(b,e);e[2]=u;r.computeLinearTransformation(f,e,h,n);c.mat4d.inverse(h,v);p.set(d,p.NEGATIVE_INFINITY);for(var a=0,w=D;a<w.length;a++)for(var k=w[a],g=k.x0,l=k.x1,m=k.y0,k=k.y1,q=0;5>q;q++){var x=q/4;e[0]=t.lerp(b[g],b[l],x);e[1]=t.lerp(b[m],
b[k],x);e[2]=u;r.vectorToVector(e,f,e,n);c.mat4d.multiplyVec3(v,e);p.expand(d,e)}c.mat4d.multiplyVec3(h,c.vec3d.set3(d[0],d[1],d[2],this.extent[0].origin));c.mat4d.multiplyVec3(h,c.vec3d.set3(d[3],d[1],d[2],this.extent[1].origin));c.mat4d.multiplyVec3(h,c.vec3d.set3(d[3],d[4],d[2],this.extent[2].origin));c.mat4d.multiplyVec3(h,c.vec3d.set3(d[0],d[4],d[2],this.extent[3].origin))},a.prototype.update=function(b,n,f,a,d,e){d=this.extent;this.toRenderBoundingExtent(b,f,a,e);c.vec3d.add(d[0].origin,d[2].origin,
this.center.origin);c.vec3d.scale(this.center.origin,.5);n(this.center.origin,this.center.direction);for(f=0;4>f;f++)a=d[f],n(a.origin,a.direction),a.originLength=c.vec3d.length(a.origin),e=d[3===f?0:f+1],a.cap.next=e.origin,c.vec3d.direction(e.origin,a.origin,a.cap.direction),this._computePlane(a.cap.direction,a.direction,a.origin,this.planes[f]);this._computePlane(d[1].cap.direction,d[0].cap.direction,d[0].origin,this.planes[4]);this.maxSpan=Math.max(Math.abs(b[0]-b[2]),Math.abs(b[1]-b[3]))},a.prototype.isVisibleInFrustumGlobal=
function(b){if(0>c.vec3d.dot(this.center.direction,b.direction))return!0;for(var a=0;4>a;a++)if(0>c.vec3d.dot(this.extent[a].direction,b.direction))return!0;return!1},a.prototype.isVisibleInFrustum=function(b,a,c){if("global"===b.viewingMode){if(this.maxSpan>(b.spatialReference.isWGS84?A:B))return!0;if(a.altitude>=C)return this.isVisibleInFrustumGlobal(a)}for(b=0;b<this.extent.length;b++)if(c=this.extent[b],m.frustumRay(a.planes,c.origin,null,c.direction)||m.frustumLineSegment(a.planes,c.origin,c.cap.next,
c.cap.direction))return!0;for(b=0;b<a.lines.length;b++)if(c=a.lines[b],m.frustumLineSegment(this.planes,c.origin,c.endpoint,c.direction))return!0;return!1},a.prototype._computePlane=function(b,a,d,e){c.vec3d.cross(b,a,e);e[3]=-c.vec3d.dot(e,d)},a}();g=function(){function a(){this.frustumVisibilityDirty=this.frustumVisibility=!0;this.extent=null;this.extentEngine=new E;this.extentEngineDirty=!0;this.renderSREqualsViewSR=null;this._isVisibleBelowSurface=!1;this.layerView=null}return a.prototype.initialize=
function(b){this.layerView=b;this.renderSREqualsViewSR=b.view.renderSpatialReference.equals(b.view.spatialReference)},a.prototype.destroy=function(){this.extentEngine=this.extent=this.layerView=null},a.prototype.needsIdleUpdate=function(){return this.frustumVisibilityDirty},a.prototype.canResume=function(){return this.frustumVisibility},a.prototype.setExtent=function(b){this.extent=b;this.frustumVisibilityDirty=this.extentEngineDirty=!0},a.prototype.viewChange=function(){this.frustumVisibilityDirty=
!0},a.prototype.elevationBoundsChange=function(){this.extentEngineDirty=this.frustumVisibilityDirty=!0},Object.defineProperty(a.prototype,"isVisibleBelowSurface",{set:function(b){this._isVisibleBelowSurface=b;this.extentEngineDirty=this.frustumVisibilityDirty=!0},enumerable:!0,configurable:!0}),a.prototype.idleUpdate=function(b){b.done()||this.frustumVisibilityDirty&&(this.updateSuspendFrustumVisible(),this.frustumVisibilityDirty=!1)},a.prototype.updateExtentEngine=function(){if(this.extentEngineDirty){this.extentEngineDirty=
!1;var b,a=this.layerView.view,c=a.renderCoordsHelper.worldUpAtPosition.bind(a.renderCoordsHelper);if(this._isVisibleBelowSurface)b=z;else{b=a.basemapTerrain.getElevationBounds();var d=b[0];b=d-Math.max(1,(b[1]-d)*(1.2-1))}this.extentEngine.update(this.extent,c,a.renderSpatialReference,a.spatialReference,this.renderSREqualsViewSR,b)}},a.prototype.updateSuspendFrustumVisible=function(){if(!this.extent)return void(this.frustumVisibility=!0);this.updateExtentEngine();var a=this.extentEngine.isVisibleInFrustum(this.layerView.view,
this.layerView.view.frustum,this._isVisibleBelowSurface);a!==this.frustumVisibility&&(this.frustumVisibility=a,this.layerView._notifySuspendedChange())},a}();var D=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],e=c.vec3d.create(),h=c.mat4d.create(),v=c.mat4d.create(),d=p.create();return g});