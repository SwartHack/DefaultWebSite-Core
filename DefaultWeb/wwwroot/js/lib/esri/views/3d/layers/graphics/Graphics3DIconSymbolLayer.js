//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/_base/lang dojo/when dojo/errors/CancelError ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./SignedDistanceFunctions ../support/FastSymbolUpdates ./graphicUtils ../../../../core/screenUtils ../../../../core/sniff ../../../../core/Error ../../../../symbols/support/symbolUtils ../../../../Color ../../../../geometry/Polygon ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial ../../../../core/urlUtils".split(" "),
function(z,ga,I,A,J,K,x,L,M,N,m,q,v,O,r,P,B,Q,R,S,T,y,w,U,C,V,W,D,X){function Y(g){var b,a=t,c=a*n;switch("primitive:"===g.substring(0,10)&&(g=g.substring(10)),g){case u.PRIM_CIRCLE:b=q.computeSignedDistancefieldCicle(a,c);break;case u.PRIM_SQUARE:b=q.computeSignedDistancefieldSquare(a,c,!1);break;case u.PRIM_KITE:b=q.computeSignedDistancefieldSquare(a,c,!0);break;case u.PRIM_CROSS:b=q.computeSignedDistancefieldCrossAndX(a,c,!1);break;case u.PRIM_X:b=q.computeSignedDistancefieldCrossAndX(a,c,!0)}return new W(b,
"sdf_"+g,{mipmap:!1,wrapClamp:!0,width:t,height:t,components:4})}var Z=y.vec3d;z=y.vec4d;var E=y.mat4d.identity(),F=[0,0,1],aa=[0,0,0,0],G=[0,0,0],ba=[1,1,1],H="center bottom top left right bottom-left bottom-right top-left top-right".split(" "),t=128,n=.5,ca=[n/2,n/2,1-n/2,1-n/2],u={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"},da=[t*n,t*n];x=function(g){function b(){var a=null!==g&&g.apply(this,arguments)||this;return a._elevationOptions={supportsOffsetAdjustment:!0,
supportsOnTheGround:!0},a}return I(b,g),b.prototype._prepareResources=function(){var a=this.symbol,c=Math.round(null!=a.size?r.pt2px(a.size):16);this._size=null;this._symbolTextureRatio=1;this._primitive=null;var f=this._getStageIdHint();if(!this._isPropertyDriven("size")){var d=O.validateSymbolLayerSize(c);if(d)return this._logWarning(d),void this.reject()}this._isPropertyDriven("size")&&64>c&&(c=64);var b=a.resource||{primitive:"circle",href:void 0},d={anchorPos:this._getAnchorPos(a)},e=this.symbolContainer;
if(this._hasVisibleVerticalOffset(e)){var e=e.verticalOffset,h=e.minWorldLength,p=e.maxWorldLength;d.verticalOffset={screenLength:r.pt2px(e.screenLength),minWorldLength:h||0,maxWorldLength:null!=p?p:1/0}}if(this._context.screenSizePerspectiveEnabled&&(d.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),b.href)this._outlineSize=this._getOutlineSize(a,null),d.color=this._getFillColor(a,null),d.outlineColor=this._getOutlineColor(a),d.outlineSize=this._outlineSize,d.textureIsSignedDistanceField=
!1,this._prepareImageResources(c,d,f);else{b=b.primitive||"circle";e="primitive:"+b;if(this._primitive=b,this._outlineSize=this._getOutlineSize(a,b),d.color=this._getFillColor(a,b),d.outlineColor=this._getOutlineColor(a),d.outlineSize=this._outlineSize,("cross"===b||"x"===b)&&0===d.outlineSize)return void this.reject();this.texture=this._context.sharedResources.textures.acquire(e,Y);this._textureURI=e;d.textureIsSignedDistanceField=!0;d.distanceFieldBoundingBox=ca;d.textureId=this.texture.getId();
this._size=[c,c];this._symbolTextureRatio=1/n;this._createMaterialsAndAddToStage(d,this._context.stage,f);this.resolve()}},b.prototype._getOutlineSize=function(a,c){var f=0;return f=a.outline&&null!=a.outline.size?r.pt2px(a.outline.size):"cross"===c||"x"===c?1.5:0,Math.max(f,0)},b.prototype._getOutlineColor=function(a){var c=this._getLayerOpacity();if(a.outline&&null!=a.outline.color){var f=R.toUnitRGB(a.outline.color);return[f[0],f[1],f[2],a.outline.color.a*c]}return[0,0,0,c]},b.prototype._getFillColor=
function(a,c){return"cross"===c||"x"===c?aa:this._getMaterialOpacityAndColor()},b.prototype._getAnchorPos=function(a){return-1<H.indexOf(a.anchor)?a.anchor:"center"},b.prototype._prepareImageResources=function(a,c,f){var d=this,b=Q.getIconHref(this.symbolContainer,this.symbol);if(!P("esri-canvas-svg-support")&&X.isSVG(b))return this._logWarning("IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)"),void this.reject(new B("SVG Not Supported","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)"));
J(this._context.sharedResources.textures.acquire(b,null,a),function(b){if(!d.isRejected()){var e=b.params,p=e.width/e.height;a?1<p?d._size=[a,Math.round(a/p)]:d._size=[Math.round(a*p),a]:d._size=[e.width,e.height];c.textureId=b.getId();d._createMaterialsAndAddToStage(c,d._context.stage,f);d.resolve()}},function(a){a instanceof K?d.reject():(a="IconSymbol3DLayer failed to load (Request for icon resource failed: "+b+")",d._logWarning(a),d.reject(new B("Request Failed",a)))});this._textureURI=b},b.prototype._createMaterialsAndAddToStage=
function(a,c,b){this._fastUpdates=v.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&A.mixin(a,this._fastUpdates.materialParameters);var d=A.mixin({},a);d.verticalOffset=null;d.screenSizePerspective=null;d.occlusionTest=!1;d.shaderPolygonOffset=0;this._drapedMaterial=new D(d,b+"_iconDraped");c.add(w.ModelContentType.MATERIAL,this._drapedMaterial);a.occlusionTest=!0;this._material=new D(a,b+
"_icon");c.add(w.ModelContentType.MATERIAL,this._material)},b.prototype.destroy=function(){g.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._material.getId()),this._material=null);this._drapedMaterial&&(this._context.stage.remove(w.ModelContentType.MATERIAL,this._drapedMaterial.getId()),this._drapedMaterial=null);this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=
null)},b.prototype._getGeometry=function(a){a=this._validateGeometry(a.geometry);return"extent"===a.type?m.placePointOnPolygon(S.fromExtent(a)):"polyline"===a.type?m.placePointOnPolyline(a):"polygon"===a.type?m.placePointOnPolygon(a):"point"===a.type?a:(this._logWarning("unsupported geometry type for icon symbol: "+a.type),null)},b.prototype._getScaleFactor=function(a){if(this._isPropertyDriven("size")&&a.size){for(var c=0;3>c;c++){var b=a.size[c];b&&"symbolValue"!==b&&"proportional"!==b&&(a.size[c]=
r.pt2px(b))}c=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/c;if(isFinite(+a.size[2]))return+a.size[2]/c}return 1},b.prototype.createGraphics3DGraphic=function(a,c){var b=this._getGeometry(a);if(null===b)return null;var d="graphic"+a.uid,l=this._getVertexOpacityAndColor(c),e=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(e=this._getScaleFactor(c));e*=this._symbolTextureRatio;c=[this._size[0]*
e,this._size[1]*e];e=this.getGraphicElevationContext(a);return"on-the-ground"===e.mode?this._createAsOverlay(a,b,l,c,e,d,a.uid):this._createAs3DShape(a,b,l,c,e,d,a.uid)},b.prototype.layerPropertyChanged=function(a,c,b){if("opacity"===a)return c=this._getFillColor(this.symbol,this._primitive),this._drapedMaterial.setParameterValues({color:c}),this._material.setParameterValues({color:c}),c=this._getOutlineColor(this.symbol),this._drapedMaterial.setParameterValues({outlineColor:c}),this._material.setParameterValues({outlineColor:c}),
!0;if("elevationInfo"===a){a=this._elevationContext.mode;this._updateElevationContext();var d=this._elevationContext.mode;if("on-the-ground"===a&&"on-the-ground"===d)return!0;if(a!==d&&("on-the-ground"===a||"on-the-ground"===d))return!1;a=m.needsElevationUpdates2D(d)||"absolute-height"===d;for(var f in c){var e=c[f];(d=b(e))&&!d.isDraped()&&(e=this.getGraphicElevationContext(e.graphic),d.needsElevationUpdates=a,d.elevationContext.set(e))}return!0}return!1},b.prototype.applyRendererDiff=function(a,
c,b,d){for(var f in a.diff)switch(f){case "visualVariables":if(!v.updateFastSymbolUpdatesState(this._fastUpdates,c,this._fastVisualVariableConvertOptions()))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},b.prototype.setDrawOrder=function(a,c,b){this._drapedMaterial&&(this._drapedMaterial.setRenderPriority(a),b[this._drapedMaterial.getId()]=!0)},b.prototype._defaultElevationInfoNoZ=
function(){return ea},b.prototype._createAs3DShape=function(a,c,b,d,l,e,h){var f=this,g=this._getFastUpdateAttrValues(a);a=g?function(a){return v.evaluateModelTransform(f._fastUpdates.materialParameters,g,a)}:null;b=C.createPointGeometry(F,null,b,d,fa,null,g);b=[new U(b,e)];e=m.createStageObjectForPoint.call(this,c,b,[[this._material]],null,null,l,e,this._context.layer.uid,h,!0,a);if(null===e)return null;var k=new L(this,e.object,b,null,null,N.perObjectElevationAligner,l);return k.alignedTerrainElevation=
e.terrainElevation,k.needsElevationUpdates=m.needsElevationUpdates2D(l.mode)||"absolute-height"===l.mode,k.getScreenSize=this._createScreenSizeGetter(d,a),k.calculateRelativeScreenBounds=function(a){return f._material.calculateRelativeScreenBounds(k.getScreenSize(),1,a)},m.extendPointGraphicElevationContext(k,c,this._context.elevationProvider),k},b.prototype._createAsOverlay=function(a,b,f,d,g,e,h){var c=this;this._drapedMaterial.setRenderPriority(this._symbolLayerOrder);h=Z.create();T.pointToVector(b,
h,this._context.overlaySR);h[2]=this._getDrapedZ();if((b=this._context.clippingExtent)&&!m.pointInBox2D(h,b))return null;var l=this._getFastUpdateAttrValues(a);a=l?function(a){return v.evaluateModelTransform(c._fastUpdates.materialParameters,l,a)}:null;f=C.createPointGeometry(F,h,f,d,null,null,l);b=new V(f);b.material=this._drapedMaterial;b.center=h;b.bsRadius=0;b.transformation=E;b.name=e;b.uniqueName=e+"#"+f.id;var k=new M(this,[b],null,null,null,g);return k.getScreenSize=this._createScreenSizeGetter(d,
a),k.calculateRelativeScreenBounds=function(a){return c._drapedMaterial.calculateRelativeScreenBounds(k.getScreenSize(),1,a)},k},b.prototype._createScreenSizeGetter=function(a,b){var c=this._outlineSize+2;if(this._fastUpdates.enabled){var d=a[0]/this._symbolTextureRatio,g=a[1]/this._symbolTextureRatio;return function(a){void 0===a&&(a=Array(2));var e=b(E);return a[0]=e[0]*d+c,a[1]=e[5]*g+c,a}}var e=a[0]/this._symbolTextureRatio+c,h=a[1]/this._symbolTextureRatio+c;return function(a){return void 0===
a&&(a=Array(2)),a[0]=e,a[1]=h,a}},b.prototype._supportsShaderVisualVariables=function(){return!0},b.prototype._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1],b=[a,a,a],f=r.px2pt(1),a=a*f;return{modelSize:b,symbolSize:[a,a,a],unitInMeters:f,transformation:{anchor:G,scale:ba,rotation:G}}},b.prototype._hasVisibleVerticalOffset=function(a){return this.symbolContainer&&"point-3d"===this.symbolContainer.type&&this.symbolContainer.hasVisibleVerticalOffset()},
b.PRIMITIVE_SIZE=da,b.VALID_ANCHOR_STRINGS=H,b}(x);var ea={mode:"relative-to-ground",offset:0},fa=z.createFrom(0,0,0,1);return x});