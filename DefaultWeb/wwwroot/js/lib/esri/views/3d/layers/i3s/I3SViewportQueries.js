//>>built
define("require exports ../../lib/glMatrix ./I3SUtil ../../webgl-engine/lib/Util ../../support/projectionUtils ../graphics/featureExpressionInfoUtils ../graphics/ElevationContext ../graphics/Graphics3DSymbolCommonCode ../../../../geometry/Point".split(" "),function(w,x,m,q,r,n,p,t,u,v){var g=m.vec3d,k=m.vec4d;return function(){function e(a,b,c,f,d,g,e,l,h){void 0===h&&(h={});this._computedMbs=a;this.indexSR=b;this._renderCoordsHelper=c;this.extent=d;this.errorMetricPreference=g;this.elevationProvider=
e;this.options=h;this.fp=[];this.maxLodLevel=2;this._tmp1=[0,0,0];this._tmp2=[0,0,0];this._tmp3=[0,0,0];this._tmp0=[0,0,0];this.supportedMetrics=["screenSpaceRelative","maxScreenThreshold","removedFeatureDiameter","distanceRangeFromDefaultCamera"];this.screenspaceErrorBias=h.screenspaceErrorBias||1;this.progressiveLoadFactor=h.progressiveLoadFactor||1;this.enableLoD=!h.disableLod;for(a=0;8>a;++a)this.fp[a]=k.create();r.matrix2frustumPlanes(f.viewMatrix,f.projectionMatrix,this.fp);this.engineSR=this._renderCoordsHelper.spatialReference;
this._screenSizeFactor=1/f.perPixelRatio;this._camPos=f.eye;l?(this._elevationContext=new t,this._elevationContext.featureExpressionInfoContext=p.createContext(p.extractExpressionInfo(l,!1)),this._elevationContext.mixinApi(l)):this._elevationContext=null;this.tmpPoint=new v({x:0,y:0,z:0,spatialReference:b})}return e.prototype.computedMbs=function(a){var b=this._computedMbs[a.id];return null==b&&(b=k.createFrom(0,0,0,-1),this._computedMbs[a.id]=b),0>b[3]&&(k.set(a.mbs,b),this._elevationContext&&1E5>
a.mbs[3]&&(this.tmpPoint.x=b[0],this.tmpPoint.y=b[1],this.tmpPoint.z=b[2],b[2]=u.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),n.mbsToMbs(b,this.indexSR,b,this.engineSR)),b},e.prototype.isNodeVisible=function(a){a=this.computedMbs(a);return this.isMBSinExtent(a)&&this.isMBSVisible(a)},e.prototype.isMBSinExtent=function(a){return this.extent?0!==q.intersectBoundingBoxWithMbs(this.extent,a):!0},e.prototype.isMBSVisible=function(a){var b=
a[0],c=a[1],f=a[2];a=a[3];var d=this.fp;return d[0][0]*b+d[0][1]*c+d[0][2]*f+d[0][3]<=a&&d[1][0]*b+d[1][1]*c+d[1][2]*f+d[1][3]<=a&&d[2][0]*b+d[2][1]*c+d[2][2]*f+d[2][3]<=a&&d[3][0]*b+d[3][1]*c+d[3][2]*f+d[3][3]<=a&&d[4][0]*b+d[4][1]*c+d[4][2]*f+d[4][3]<=a&&d[5][0]*b+d[5][1]*c+d[5][2]*f+d[5][3]<=a},e.prototype.calcScreenSpaceSize=function(a,b){a=this.computedMbs(a);var c=a[3];a=g.dist2(a,this._camPos)-c*c;return 0>a?.5*Number.MAX_VALUE:b/Math.sqrt(a)*this._screenSizeFactor},e.prototype.calcCameraDistance=
function(a){a=this.computedMbs(a);return Math.max(0,g.dist(a,this._camPos)-a[3])},e.prototype.calcAngleDependentLoD=function(a){a=this.computedMbs(a);var b=a[3];a=(Math.abs(a[0]*(a[0]-this._camPos[0])+a[1]*(a[1]-this._camPos[1])+a[2]*(a[2]-this._camPos[2]))/g.length(a)+b)/g.dist(a,this._camPos);return Math.min(1,a)},e.prototype.hasLOD=function(a){return null!=a.lodSelection},e.prototype.hasFeatures=function(a){return null!=a.featureData},e.prototype.getDistancePlanarMode=function(a,b,c){var f=a[0]-
b[0],d=a[1]-b[1];a=a[2]-b[2];f=f+f+d*d;if(c*c>=f)return Math.abs(a);c=Math.sqrt(f)-c;return Math.sqrt(a*a+c*c)},e.prototype.getDistanceGlobeMode=function(a,b,c){var f=g.length(b),d=g.length(a)-f;g.scale(a,g.dot(a,b)/g.length2(a),this._tmp0);var e=g.dist2(b,this._tmp0);if(c*c>=e)return Math.abs(d);b=g.scale(b,1/f,this._tmp0);f=g.scale(b,f-c*c/2/f,this._tmp1);e=g.subtract(a,f,this._tmp2);e=g.subtract(e,g.scale(b,g.dot(b,e),this._tmp3),this._tmp2);f=g.add(f,g.scale(e,c/g.length(e),this._tmp2),this._tmp2);
c=g.dist(a,f);2E5<=d&&(a=g.subtract(a,f,this._tmp1),a=g.dot(a,b)/g.length(a),.08>a&&(a=1E-4),c/=a);return c},e.prototype.getDistance=function(a,b,c){return this.engineSR===n.SphericalECEFSpatialReference?this.getDistanceGlobeMode(a,b,c):this.getDistancePlanarMode(a,b,c)},e.prototype._selectErrorMetric=function(a){if(this.errorMetricPreference)for(var b=0;b<this.errorMetricPreference.length;b++)for(var c=0;c<a.length;c++){if(a[c].metricType===this.errorMetricPreference[b])return a[c]}else for(b=0;b<
a.length;b++)if(0<=this.supportedMetrics.indexOf(a[b].metricType))return a[b];return null},e.prototype.getLodLevel=function(a){if(a.lodSelection&&0<a.lodSelection.length){if(!1===this.hasFeatures(a))return 0;if(null==a.children||0===a.children.length)return this.maxLodLevel;var b=this.enableLoD?this._selectErrorMetric(a.lodSelection):null;if(null!=b){if(1>this.progressiveLoadFactor){var c=this.screenspaceErrorBias;return this.evaluateLODmetric(a,this.progressiveLoadFactor*this.screenspaceErrorBias,
b)?this.evaluateLODmetric(a,c,b)?2:1:0}return this.evaluateLODmetric(a,this.screenspaceErrorBias,b)?this.maxLodLevel:0}}return 0},e.prototype.evaluateLODmetric=function(a,b,c){return"screenSpaceRelative"===c.metricType?(a=this.computedMbs(a),a=2*this.getDistance(this._camPos,a,a[3])/this._screenSizeFactor,c.maxError*b<=a):"maxScreenThreshold"===c.metricType?(b=this.calcScreenSpaceSize(a,a.mbs[3]*b),this.options.angleDependentLoD&&(b*=this.calcAngleDependentLoD(a)),b<c.maxError):"removedFeatureDiameter"===
c.metricType?10>this.calcScreenSpaceSize(a,c.maxError)*b:"distanceRangeFromDefaultCamera"===c.metricType?this.calcCameraDistance(a)>c.maxError*b:!1},e.prototype.distToPOI=function(a,b){a=this.computedMbs(a);return g.dist(a,b)-a[3]},e.prototype.distCameraToPOI=function(a){return g.dist(this._camPos,a)},e}()});