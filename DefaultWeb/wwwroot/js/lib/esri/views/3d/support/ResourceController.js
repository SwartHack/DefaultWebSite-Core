//>>built
define("../../../core/declare ../../../core/Scheduler ../../../core/HandleRegistry ./StreamDataSupplier ./StreamDataLoader ./PreallocArray ../webgl-engine/lib/Util".split(" "),function(g,n,p,q,r,t,l){function e(b){this.budget=this.begin=0;this.performance=b;this.enabled=!0}var k=l.assert,f={TERRAIN:"terrain",SCENE:"scene",SYMBOLOGY:"symbols"},h=new t(20);e.prototype.now=function(){return this.performance.now()};e.prototype.reset=function(b){this.begin=this.now();this.budget=this.enabled?b:Number.MAX_VALUE};
e.prototype.done=function(){return this.enabled&&this.elapsed()>=this.budget};e.prototype.remaining=function(){return Math.max(this.budget-this.elapsed(),0)};e.prototype.elapsed=function(){return this.now()-this.begin};g=g(null,{constructor:function(b,c,a){a=a||l.performance;this._clients=[];this._frameWorker=null;this._budget=new e(a);this._idleFrameWorkers=[];this._idleFrameWorkerRobin=0;this._idleUpdatesStartFired=!1;this._lastTargetChangeTime=a.now();this.navigationTimeout=300;this.animatingFrameTimeBudget=
10;this.idleFrameWorkerBudget=30;this.idleFrameTimeBudget=50;a={};for(var d in f)a[f[d]]=0;a[f.TERRAIN]=15;a[f.SCENE]=20;a[f.SYMBOLOGY]=5;this._maxGpuMemory=500;this.streamDataLoader=new r(a);this._cameraListeners=new p;this._cameraListeners.add([b.watch("state.camera",this._cameraChangedHandler.bind(this),!0)]);c||(c=n);this._frameTask=c.addFrameTask({update:this._frameUpdate.bind(this)});this._view=b;this.stats={frameUpdateTime:new m,idleUpdateTime:new m};this.frameUpdateNavigation=null},destroy:function(){this._frameTask.remove();
this._frameTask=null;this._cameraListeners.remove();this.streamDataLoader.destroy();this.streamDataLoader=null},setEnableBudget:function(b){this._budget.enabled=!!b},registerClient:function(b,c,a){return this._clients.push({client:b,type:c}),"function"==typeof b.setMaxGpuMemory&&b.setMaxGpuMemory(this._maxGpuMemory),new q(c,this.streamDataLoader,a)},deregisterClient:function(b){for(var c=0;c<this._clients.length;c++)if(this._clients[c].client===b)return this._clients[c]=this._clients[this._clients.length-
1],void this._clients.pop();console.warn("deregistering an unregistered client.")},setMaxGpuMemory:function(b){this._maxGpuMemory=b;for(var c=0;c<this._clients.length;c++){var a=this._clients[c].client;"function"==typeof a.setMaxGpuMemory&&a.setMaxGpuMemory(b)}},registerIdleFrameWorker:function(b,c){var a=this._idleFrameWorkers.some(function(a){return a.client===b});k(!a,"Can only register idle frame workers once per client/layer");k(!c.idleFrame||c.needsUpdate,"needsUpdate has to be specified if idleFrame is specified");
this._idleFrameWorkers.push({client:b,callbacks:c});this._isIdle()&&this._idleUpdatesStartFired&&c.idleBegin&&c.idleBegin.call(b)},deregisterIdleFrameWorker:function(b){for(var c=this._idleFrameWorkers,a=0;a<c.length;a++){var d=c[a];if(d.client===b)return this._idleUpdatesStartFired&&d.callbacks.idleEnd&&d.callbacks.idleEnd.call(b),c[a]=c[c.length-1],void c.pop()}},registerFrameWorker:function(b){k(!this._frameWorker,"Only one (non-idle) per-frame worker supported at the moment");this._frameWorker=
b},deregisterFrameWorker:function(){this._frameWorker=null},_cameraChangedHandler:function(){this._lastTargetChangeTime=this._budget.now();this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._callWorkersNoScheduling("idleEnd"))},_frameUpdate:function(b){var c=this._isIdle()?this.idleFrameWorkerBudget:this.animatingFrameTimeBudget;this._budget.reset(c-b.spendInFrame);this._view.stateManager&&this._view.stateManager.step(b.deltaTime/1E3);this._view.inputManager&&this._view.inputManager._pinchNavigation&&
this._view.inputManager._pinchNavigation.momentum.doFrameUpdate(b.deltaTime);this._frameWorker&&(this._frameWorker(this._budget),this.stats.frameUpdateTime.addSample(this._budget.elapsed()));this._isIdle()&&(this._idleUpdatesStartFired||(this._callWorkersNoScheduling("idleBegin"),this._idleUpdatesStartFired=!0),this._budget.reset(this.idleFrameTimeBudget-this._budget.elapsed()),3<this._budget.remaining()&&(this._callWorkersStrictScheduling("idleFrame",this._budget),this.stats.idleUpdateTime.addSample(this._budget.elapsed())))},
_isIdle:function(){return this._budget.now()-this._lastTargetChangeTime>this.navigationTimeout},_callWorkersNoScheduling:function(b){for(var c=this._idleFrameWorkers,a=0;a<c.length;a++){var d=c[a];d.callbacks[b]&&d.callbacks[b].call(d.client)}},_callWorkersStrictScheduling:function(b,c){var a,d,e,f=this._idleFrameWorkers,g=f.length;h.clear();d=0;for(e=this._idleFrameWorkerRobin;g>d;d++)a=f[e++%g],a.callbacks.needsUpdate&&a.callbacks.needsUpdate.call(a.client)&&(0===h.length&&(this._idleFrameWorkerRobin=
e),h.push(a));a=c.now();for(d=a+c.remaining();0<h.length&&d>a;)c.reset((d-a)/h.length),a=h.pop(),a.callbacks[b].call(a.client,c),a=c.now()}});g.ClientType=f;var m=function(){this.addSample=function(b){this.min=Math.min(this.min,b);this.max=Math.max(this.max,b);this.total+=b;this.numSamples++};this.getAverage=function(){return this.total/this.numSamples};this.reset=function(){this.numSamples=this.total=0;this.min=Number.MAX_VALUE;this.max=-Number.MAX_VALUE};this.reset()};return g});