//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/ObjectPool ../../../core/Logger ../../../core/watchUtils ../../../core/HandleRegistry ../../../geometry/Point ../lib/glMatrix ../support/aaBoundingRect ../support/Evented ../support/mathUtils ../support/PreallocArray ../support/projectionUtils ../support/PromiseLightweight ../support/ResourceController ./OverlayManager ./PlanarTile ./SphericalTile ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./TileGeometryFactory ./TilemapOnlyTile ./tileUtils ./tileUtils".split(" "),
function(G,la,P,p,h,Q,B,R,S,T,U,V,W,x,y,X,Y,Z,D,H,aa,ba,ca,da,I,ea,e,fa,q,ga,ha,z,J){function K(e,c){return e[0]===c[0]&&e[1]===c[1]&&e[2]===c[2]}function L(e){return e&&("cancel"===e||"cancel"===e.dojoType)}function M(e,c){var a=!1;c=c||e;var b=0;for(e=e.children;b<e.length;b++){var d=e[b];if(d){for(var f in d.layerInfo)for(var k in d.layerInfo[f]){var g=d.layerInfo[f][k].upsampleFromTile;if(g&&g.tile===c)return!0}a=a||M(d,c)}}return a}var N=x.vec3d,E=x.vec4d,O=x.mat4d,A=q.weakAssert,t=T.getLogger("esri.views.3d.terrain.TerrainSurface");
G=function(x){function c(){var a=x.call(this)||this;a.defaultTileBackground=e.DEFAULT_TILE_BACKGROUND;a.hideSkirtsDistanceFromExtentMargin=ia;a.hideSkirtsMinimumCameraTilt=ja;a._clippingExtent=null;a._dataExtent=null;a._elevationBounds=[0,0];a._rootExtent=[0,0,0,0];a._iteratorPool=new S(J.IteratorPreorder);a._postorderIterator=new J.IteratorPostorder;a.visible=!1;a.suspended=!1;a._pendingUpdates=!1;a._lvPendingUpdates=!1;a._updateNextFrame=0;a._vectorTileLayerRequests=0;a._curOverlayOpacity=1;a._curEyePos=
N.create();a._curSplitLimits=[0,0,0,0,0,0];a._curFrustumPlanes=Array(6);a._viewProjectionMatrix=O.identity();a.tilemapStats={tilemapRequestsSent:0,tilemapRequestsPending:0,tilemapRequestErrors:0,fullTilemaps:0,emptyTilemaps:0,tilesRequested:0,tileRequestsSent:0,tileRequestErrors:0,tilesNotPresent:0};a._layerViews=[[],[]];a._layerIndexByLayerViewId=[{},{}];a._basemapLayerViewHandles={};a._handles=new V;a._frameUpdateLowerPrio=new Z(500);a._topLevelTilemapOnlyTiles=Array(e.TILEMAP_SIZE_EXP+1);a.loaded=
!1;a.maxTextureScale=1.2;a.rootTiles=null;for(var b=0;b<a._topLevelTilemapOnlyTiles.length;b++)a._topLevelTilemapOnlyTiles[b]=new ha([b-e.TILEMAP_SIZE_EXP,0,0]);for(b=0;6>b;b++)a._curFrustumPlanes[b]=E.create();return a}return P(c,x),c.prototype.normalizeCtorArgs=function(a,b){return this._view=a,this._stage=a._stage,this._set("manifold",b),{}},c.prototype.initialize=function(){var a=this;this.tilePool="planar"===this.manifold?ca.Pool:da.Pool;this._renderer=new fa(this.manifold,null,this._view.pointsOfInterest);
this._renderer.loaded=this._setLoaded.bind(this);this._renderer.updateTileBackground(this.tileBackground);this._renderer.install(this._view._stage);this._set("overlayManager",new ba({terrainSurface:this,view:this._view}));this._handles.add(this.watch("overlayManager.hasHighlights",this._handleHasHighlights.bind(this)),"overlayManager");var b={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?
new I.SurfaceExtentHelperGlobal(b):new I.SurfaceExtentHelperLocal(b);this._handles.add(U.init(this.extentHelper,"stencilEnabledExtents",function(b){a._renderer.setStencilEnabledLayerExtents(b)}),"extentHelper");b=this._view.defaultsFromMap?new R({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(a){return a.layers}}):this._view.map.allLayers;b=new ea({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});
this._set("tilingSchemeLogic",b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._streamDataSupplier=this._view.resourceController.registerClient(this,aa.ClientType.TERRAIN);b={needsUpdate:this._needsIdleUpdate,idleFrame:this._idleUpdate};this._view.resourceController.registerFrameWorker(this._frameUpdate.bind(this));
this._view.resourceController.registerIdleFrameWorker(this,b);this._viewChangeUpdate=this._viewChangeUpdate.bind(this);this._handles.add([this._view.on("resize",this._viewChangeUpdate),this._view.watch("state.camera",this._viewChangeUpdate,!0),this._view.watch("qualitySettings.tiledSurface.lodBias",this._viewChangeUpdate),this._view.watch("clippingArea",this._clippingChanged.bind(this))],"view");this._handles.add(this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),"allLayerViews");
this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),removed:[],moved:[],target:this._view.allLayerViews});this._updateClippingExtent();this.notifyChange("extent")},c.prototype.destroy=function(){this._handles.destroy();this._removeAllTiles();this.tilingSchemeLogic.destroy();this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;for(var a in this._basemapLayerViewHandles)this._unregisterTiledLayerView(a);this._view.resourceController.deregisterFrameWorker();
this._view.resourceController.deregisterIdleFrameWorker(this);this._view.resourceController.deregisterClient(this);this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._renderer.destroy(this._stage);this._streamDataSupplier=this._stage=this._view=this._renderer=null},Object.defineProperty(c.prototype,"cullBackFaces",{set:function(a){this._renderer.setCullBackFaces(a);this._set("cullBackFaces",a)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,
"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"frontMostTransparent",{set:function(a){this._renderer.setFrontMostTransparent(a);this._set("frontMostTransparent",a)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"opacity",{set:function(a){this._renderer.setOpacity(a);this._set("opacity",a)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},
enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.setRenderOrder(a);this._set("renderOrder",a)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"skirts",{set:function(a){this._renderer.setDrawSkirts(a);this._set("skirts",a)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"tileBackground",{set:function(a){a!==this.tileBackground&&this._renderer.updateTileBackground(a);this._set("tileBackground",a)},enumerable:!0,
configurable:!0}),Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&this._renderer.setVelvetOverground(a);this._set("velvetOverground",a)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"wireframe",{set:function(a){this._renderer.setWireframe(a);this._set("wireframe",a);this._view._stage.setRenderParams({earlyOcclusionPixelDraw:a})},enumerable:!0,configurable:!0}),c.prototype.setVisibility=function(a){a!==this.visible&&(this.visible=
a,this._renderer.setVisibility(a),this.setUpdatesDisabled(!a),a&&this._viewChangeUpdate())},c.prototype.isVisible=function(){return this.visible&&this.ready},c.prototype.isSeeThrough=function(){return this._renderer.isTransparent()},c.prototype.setUpdatesDisabled=function(a){(this.suspended=a)||this._viewChangeUpdate()},c.prototype.intersect=function(a,b,d){this._renderer.intersect(a,b,d)},c.prototype.getElevation=function(a){if(!this.ready)return null;var b=this.rootTiles;if(0===b[0].layerInfo[e.LayerClass.ELEVATION].length)return null;
if(a instanceof W){if(!D.pointToVector(a,w,this.tilingScheme.spatialReference))return t.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;a=w}for(var d,f=0;f<b.length;f++){var c=b[f];if(z.isPosWithinTile(c,a)){for(;c&&!c.renderData;)b=0,a[0]>.5*(c.extent[0]+c.extent[2])&&(b+=1),a[1]<.5*(c.extent[1]+c.extent[3])&&(b+=2),c=c.children[b];d=(b=c.renderData)&&b.geometryState?b.geometryState.samplerData:null;break}}return d?ga.elevationSampler(a[0],
a[1],d):null},c.prototype.getElevationBounds=function(){return this._elevationBounds},c.prototype.getScale=function(a){if(this.tilingScheme){if(!D.pointToVector(a,w,this.spatialReference))return t.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;if(this.rootTiles)for(var b=0;b<this.rootTiles.length;b++)if(a=this.rootTiles[b],z.isPosWithinTile(a,w)){for(;a.children[0];)b=0,w[0]>a.children[0].extent[2]&&(b+=1),w[1]<a.children[0].extent[1]&&
(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.lij[0])}}return 1E100},c.prototype.queryVisibleScaleRange=function(a,b,d,c){b=b?this.tilingScheme.levelAtScale(b):0;d=d?this.tilingScheme.levelAtScale(d):1/0;var f=this._getLodBias();this._renderer.queryVisibleLevelRange(a,b+f,d+f,c)},c.prototype._setLoaded=function(){this.loaded||this._set("loaded",!0)},c.prototype._updateTilingSchemeAndExtent=function(){var a=this.tilingSchemeLogic.extent,b=this.tilingSchemeLogic.tilingScheme,d=!1;a&&
!y.equals(a,this._dataExtent)&&(d=!0,this._dataExtent?y.set(this._dataExtent,a):this._dataExtent=y.create(a));b!==this.tilingScheme&&(A(!!b,"tiling scheme cannot be reset to undefined"),d=!0,this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",b),this._updateClippingExtent(),b&&(this._updateTiledLayers(),this._renderer.setTileSize(b.pixelSize[0]),this.overlayManager.setSpatialReference(b.spatialReference,"spherical"===this.manifold)));d&&this._updateRootTiles()},c.prototype._acquireTile=
function(a,b,d,c){var f=this.tilePool.acquire();return C[0]=a,C[1]=b,C[2]=d,f.init(C,c,this,this.tilingScheme),f},c.prototype._releaseTile=function(a){a.dispose();a.parent=null;a.parentSurface=null;this.tilePool.release(a)},c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,d=this.tilingScheme;if(b&&d){var c=w,k=d.rootTilesInExtent(b,c,1/0);if(this.rootTiles){if(k.length>F)return void t.warn(e.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);var b=this.rootTiles.map(function(a){return a.lij}),
g=B.difference(b,k,K);if(0<g.removed.length||0<g.added.length){var m=this.rootTiles.filter(function(b){return-1<B.findIndex(g.removed,K.bind(null,b.lij))?(a._purgeChildTiles(b),a._purgeTile(b),!1):!0});g.added.forEach(function(b){b=a._acquireTile(0,b[1],b[2],null);m.push(b);a._loadTile(b)});this._set("rootTiles",m);this._renderer.setRootTiles(this.rootTiles)}}else k.length>F&&(t.warn(e.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),k=d.rootTilesInExtent(b,c,F)),this._set("rootTiles",k.map(function(b){b=a._acquireTile(0,
b[1],b[2],null);return a._loadTile(b),b})),this._renderer.setRootTiles(this.rootTiles);B.equals(c,this._rootExtent)||(this._rootExtent=E.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.setVisibility(!0);this._viewChangeUpdate();this.overlayManager.setOverlayDirty();this.notifyChange("ready")}},c.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateOverlayOpacity(this._curEyePos),
this._updateTiles(this.rootTiles))},c.prototype._updateTiles=function(a){var b=this._iteratorPool.acquire();b.reset(a);var d,c,k=this._curSplitLimits,g=this._curFrustumPlanes,m=this._curEyePos;for(z.hasVisibleSiblings(a)?(d=this._elevationBounds[0],c=this._elevationBounds[1]):(d=1/0,c=-(1/0));!b.done;){a=b.next();a.updateClippingStatus(this._clippingExtent);var l=!0;if(a.updateVisibility(g,m)){a.updateScreenDepth(this._viewProjectionMatrix);a.renderData&&(d=Math.min(a.elevationBounds[0],d),c=Math.max(a.elevationBounds[1],
c));var r=a.shouldSplit(k,m);r===n.SPLIT?(a.pendingUpdates&=~n.MERGE,a.renderData?(l=!1,a.pendingUpdates|=n.SPLIT,b.skip()):l=!1):(a.pendingUpdates&=~n.SPLIT,r===n.VSPLITMERGE&&a.updateAgents(e.LayerClass.ELEVATION),b.skip())}else b.skip();if(l&&!a.renderData){a.pendingUpdates|=n.MERGE;a.pendingUpdates&=~n.SPLIT;l=this._iteratorPool.acquire();for(l.reset(a);!l.done;)r=l.next(),r.updateVisibility(g,m),r.visible&&r.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(l)}0!==a.pendingUpdates&&
(this._pendingUpdates=!0)}this._iteratorPool.release(b);isFinite(d)&&isFinite(c)&&(this._elevationBounds[0]!==d||this._elevationBounds[1]!==c)&&(this._elevationBounds[0]=d,this._elevationBounds[1]=c,this.emit("elevation-bounds-change",null))},c.prototype._updateViewDependentParameters=function(){var a=this._view.state.camera,b=Math.tan(.5*a.fovX),d=Math.tan(.5*a.fovY),c=this.tilingScheme.pixelSize,k=Math.pow(2,-this._getLodBias());this._curSplitLimits[0]=b;this._curSplitLimits[1]=c[0]/a.width*this.maxTextureScale*
k;this._curSplitLimits[2]=d;this._curSplitLimits[3]=c[1]/a.height*this.maxTextureScale*k;this._curSplitLimits[4]=this.tilingScheme.getMaxLod();this._curSplitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias;a.copyFrustumPlanes(this._curFrustumPlanes);O.multiply(a.projectionMatrix,a.viewMatrix,this._viewProjectionMatrix);N.set(a.eye,this._curEyePos);q.autoUpdateSkirtsVisibility(this,this._curEyePos)},c.prototype._setLayerViewsUpdating=function(){for(var a=0;a<e.LayerClass.LAYER_CLASS_COUNT;a++)for(var b=
this._layerViews[a],d=0;d<b.length;d++)b[d]._evaluateUpdatingState(this._pendingUpdates)},c.prototype._frameUpdateTraversal=function(a){if(!this.suspended){this._frameUpdateLowerPrio.clear();var b=this._renderer.resourceCounter.numTileTexturesComposited,d=this._iteratorPool.acquire();d.reset(this.rootTiles);for(var c=!1,k=!1;!d.done&&(1<a.remaining()||!c)&&this._renderer.resourceCounter.numTileTexturesComposited-b<ka;){var g=d.next();g.pendingUpdates&n.MERGE?(this._mergeTile(g),g.pendingUpdates&=
~n.MERGE,c=!0,d.skip()):g.pendingUpdates&n.SPLIT?(this._splitTile(g),g.pendingUpdates&=~n.SPLIT,c=!0,d.skip()):0<g.pendingUpdates&&this._frameUpdateLowerPrio.push(g);0!==g.pendingUpdates&&(k=!0)}return this._pendingUpdates=k||!d.done,this._iteratorPool.release(d),c}},c.prototype._updateTileGeometry=function(a){this._renderer._updateTileGeometry(a);u.spatialReference=this.spatialReference;u.tile=a;u.extent=a.extent;this.emit("elevation-change",u)},c.prototype._updateTileTexture=function(a){this._renderer.updateTileTexture(a)},
c.prototype._frameUpdate=function(a){if(this.rootTiles){for(var b=this._frameUpdateTraversal(a);(1<a.remaining()||!b)&&0<this._frameUpdateLowerPrio.length;){var d=this._frameUpdateLowerPrio.pop();d.pendingUpdates&n.DECODE_ELEVATION?(this._decodeElevation(d),d.pendingUpdates&=~n.DECODE_ELEVATION,b=!0):d.pendingUpdates&n.UPDATE_GEOMETRY?(this._renderer.updateTileGeometryNeedsUpdate(d),this._updateTileGeometry(d),b=!0,d.pendingUpdates&=~n.UPDATE_GEOMETRY):d.pendingUpdates&n.UPDATE_TEXTURE&&(this._updateTileTexture(d),
d.pendingUpdates&=~n.UPDATE_TEXTURE,b=!0);0!==d.pendingUpdates&&(this._pendingUpdates=!0)}0<this._frameUpdateLowerPrio.length&&(this._pendingUpdates=!0);(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)&&(this._pendingUpdates=!0);this._pendingUpdates!==this._lvPendingUpdates&&(this._pendingUpdates||20===++this._updateNextFrame)&&(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,this._updateNextFrame=0)}},c.prototype._needsIdleUpdate=function(){return this.isVisible()&&
this.overlayManager&&this.overlayManager.overlaysNeedUpdate()},c.prototype._idleUpdate=function(){this.overlayManager.updateOverlay();this._updateOverlayOpacity(this._curEyePos)},c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=[0,0,0,0],b=null;return D.extentToBoundingRect(this._view.clippingArea,a,this.spatialReference)&&(b=a),B.equals(b,this._clippingExtent)?!1:(this._clippingExtent=b,this._renderer.clippingExtent=b,this.notifyChange("extent"),this.overlayManager.setOverlayDirty(),
!0)},c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()},c.prototype._getLodBias=function(){return Math.round(this._view.qualitySettings.tiledSurface.lodBias)},c.prototype._getLodBiasCorrectedScale=function(a){var b=this.tilingScheme.levels;a=Y.clamp(a-this._getLodBias(),0,b.length-1);return b[a].scale},c.prototype._cancelTilemapRequests=function(a){for(var b=0;b<e.LayerClass.LAYER_CLASS_COUNT;b++){var d=a.layerInfo[b];if(d)for(var c=0;c<d.length;c++){var k=
d[c];k.tilemapRequest&&(k.tilemapRequest.cancel(),k.tilemapRequest=null)}}},c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){a._purgeChildTiles(b);a._purgeTile(b)}),this._set("rootTiles",null),this.notifyChange("ready"));for(var b=0;b<this._topLevelTilemapOnlyTiles.length;b++)this._cancelTilemapRequests(this._topLevelTilemapOnlyTiles[b]);this.setVisibility(!1)},c.prototype._purgeChildTiles=function(a){var b=this._postorderIterator;for(b.reset(a);!b.done;){for(var d=
b.next(),c=0;4>c;c++)d.children[c]=null;d!==a&&this._purgeTile(d)}},c.prototype._purgeTile=function(a){a.unload(this._renderer);this._cancelTilemapRequests(a);a.parent=null;this._releaseTile(a)},c.prototype._splitTile=function(a){var b=a.lij[0]+1,d=2*a.lij[1],c=2*a.lij[2];a.children[0]=this._createTile(b,d,c,a);a.children[1]=this._createTile(b,d,c+1,a);a.children[2]=this._createTile(b,d+1,c,a);a.children[3]=this._createTile(b,d+1,c+1,a);a.unload(this._renderer);v.spatialReference=this.spatialReference;
v.extent=a.extent;v.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",v)},c.prototype._createTile=function(a,b,d,c){A(!!c,"_createTile sanity check");a=this._acquireTile(a,b,d,c);if(a.updateClippingStatus(this._clippingExtent),a.updateVisibility(this._curFrustumPlanes,this._curEyePos),a.visible)a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._curSplitLimits,this._curEyePos)===n.SPLIT&&(a.pendingUpdates|=n.SPLIT,this._pendingUpdates=!0);return this._loadTile(a),a},
c.prototype._mergeTile=function(a){A(!a.renderData,"_mergeTile sanity check");this._loadTile(a);this._purgeChildTiles(a);v.spatialReference=this.spatialReference;v.extent=a.extent;v.scale=this._getLodBiasCorrectedScale(a.lij[0]);this.emit("scale-change",v)},c.prototype._loadTile=function(a){a.load(this._renderer);this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(a,a.renderData,this._curOverlayOpacity);u.spatialReference=this.spatialReference;u.tile=
a;u.extent=a.extent;this.emit("elevation-change",u)},c.prototype._handleHasHighlights=function(a){this._renderer.setNeedsHighlight(a)},c.prototype._decodeElevation=function(a){var b=e.LayerClass.ELEVATION,c=a.layerInfo[b];if(c)for(var f=0;f<c.length;f++){var k=c[f];if(k.pendingUpdates&=~n.DECODE_ELEVATION,k.rawData){var g=a.decodeElevationData(k.rawData);if(k.rawData=null,g){k.data=g;var k=a.lij[0],m=this._iteratorPool.acquire();for(m.reset(a);!m.done;){var l=m.next();l.findElevationBoundsForLayer(f,
k);l.computeElevationBounds()}this._iteratorPool.release(m);a.dataArrived(f,b,g);this._updateTiles(a)}}}},c.prototype._handleLayerViewChanges=function(a){var b=this,c=!1;a.added.forEach(function(a){var d=a.layer;q.isTiledLayerView(a)?(b._registerTiledLayer(a),d.loaded&&(c=!0)):a.supportsDraping&&b.overlayManager&&b.overlayManager.registerLayerView(a)});a.removed.forEach(function(a){q.isTiledLayerView(a)?(c=!0,b._unregisterTiledLayerView(a.uid)):a.supportsDraping&&b.overlayManager&&b.overlayManager.unregisterLayerView(a)});
(c=c||0<a.moved.filter(q.isTiledLayerView).length)&&this._updateTiledLayers()},c.prototype._registerTiledLayer=function(a){var b=this,c=[];c.push(a.watch("suspended",function(){b._updateTiledLayers()}));c.push(a.watch("fullOpacity",function(){return b._updateTileTextures()}));a.on("data-changed",function(){var c=q.isElevationLayerView(a)?e.LayerClass.ELEVATION:e.LayerClass.MAP,d=b._layerIndexByLayerViewId[c][a.uid];null!=d&&b._invalidateLayerData(d,c)});this._basemapLayerViewHandles[a.uid]=c},c.prototype._unregisterTiledLayerView=
function(a){var b=this._basemapLayerViewHandles[a];if(b){for(var c=0;c<b.length;c++)b[c].remove();delete this._basemapLayerViewHandles[a]}},c.prototype._updateTiledLayers=function(){var a=this;if(this.tilingScheme){var b=this._view.allLayerViews,c=[[],[]],f=e.LayerClass,k=null,g=y.create(y.NEGATIVE_INFINITY);b.forEach(function(b){var d=b.layer;if(b.layer&&b&&!b.suspended&&q.isTiledLayerView(b)){var r=b.fullExtent;if(r){if(!a.tilingScheme.compatibleWith(b.tileInfo))return void t.warn("Terrain: tiling scheme of layer "+
d.id+" is incompatible with other tiled layers, will not be drawn");y.expand(g,r);q.isElevationLayerView(b)?c[f.ELEVATION].push(b):(b.maxDataLevel!==1/0&&(null===k||b.maxDataLevel>k)&&(k=b.maxDataLevel),c[f.MAP].push(b))}else t.warn("Terrain: Map or elevation layer does not have fullExtent: "+d.id)}},this);for(var b=function(a){var b=m._layerViews[a],d=c[a];d.reverse();var k=b.length!==d.length,g=d.length,l=Array(g),r=Array(b.length);m._layerIndexByLayerViewId[a]={};for(var e=0;g>e;e++){m._layerIndexByLayerViewId[a][d[e].uid]=
e;var h=b.indexOf(d[e]);l[e]=h;e!==h&&(k=!0);-1<h&&(r[h]=e)}if(k){m._topLevelTilemapOnlyTiles.forEach(function(b){return b.modifyLayers(r,l,a)});b=m._postorderIterator;if(m.rootTiles)for(b.reset(m.rootTiles);!b.done;)b.next().modifyLayers(r,l,a);if(m._layerViews[a]=d,m.rootTiles){for(b.reset(m.rootTiles);!b.done;)d=b.next(),d.restartAgents(a),a===f.ELEVATION&&d.computeElevationBounds();m._updateTiles(m.rootTiles)}}},m=this,l=0;l<f.LAYER_CLASS_COUNT;l++)b(l);this.tilingScheme.levels.length-1<k&&(this.tilingScheme.ensureMaxLod(k),
this._viewChangeUpdate())}},c.prototype._hasFixedExtent=function(){return!!this._clippingExtent},c.prototype.layerViewByIndex=function(a,b){return this._layerViews[b][a]},c.prototype.numLayers=function(a){return this._layerViews[a].length},c.prototype.numTotalLayers=function(){return this._layerViews.reduce(function(a,b){return b.length+a},0)},c.prototype._updateTileTextures=function(){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)a.next().updateTexture();this._iteratorPool.release(a)},
c.prototype._invalidateLayerData=function(a,b){var c=this._iteratorPool.acquire();for(c.reset(this.rootTiles);!c.done;)c.next().removeLayerAgent(a,b);for(c.reset(this.rootTiles);!c.done;)c.next().invalidateLayerData(a,b);this._iteratorPool.release(c)},c.prototype.requestTileData=function(a,b,c){var d=this;this.tilemapStats.tilesRequested++;var k=this.layerViewByIndex(b,c),g=k.layer;if(g.tilemapCache){var m=this.getTilemapTile(a),l=m.layerInfo[c][b];if(!l.tilemap){l.tilemapRequest||(l.tilemapRequest=
this.requestTilemap(m,b,c,k,g));var e,h=new H.Promise(function(){e&&e.cancel()});return l.tilemapRequest.always(function(){if(l.tilemapRequest=null,!h.isCancelled()){var b=d._layerIndexByLayerViewId[c][k.uid];null!=b&&(m.tileDataAvailable(a,b,c)?(e=d._requestTileData(a,b,c,k),e.then(function(){return h.resolve()})):(d.tilemapStats.tilesNotPresent++,d._dispatchDataEvent(a,"dataMissing",c,k,{notInTilemap:!0}),h.reject()))}}),h}if(!m.tileDataAvailable(a,b,c))return this.tilemapStats.tilesNotPresent++,
this._dispatchDataEvent(a,"dataMissing",c,k,{notInTilemap:!0}),b=new H.Promise,b.reject(),b}return this._requestTileData(a,b,c,k)},c.prototype._requestTileData=function(a,b,c,f){return this.tilemapStats.tileRequestsSent++,c===e.LayerClass.ELEVATION?this._requestElevationTileData(a,b,c,f):this._requestMapTileData(a,b,c,f)},c.prototype._requestElevationTileData=function(a,b,c,f){function d(b){var d=l._layerIndexByLayerViewId[c][f.uid];null!=d?(d=a.layerInfo[c][d],d.rawData=b,a.pendingUpdates|=n.DECODE_ELEVATION,
d.pendingUpdates|=n.DECODE_ELEVATION,l._pendingUpdates=!0):t.warn("TerrainSurface: received data from unknown layer %d %s",c,a.lij.toString())}function g(b){L(b)||(l.tilemapStats.tileRequestErrors++,l._dispatchDataEvent(a,"dataMissing",c,f,b))}var m,l=this;q.isElevationLayerView(f)?(b=f.layer,q.useFetchTileForLayer(b)?(m=b.fetchTile(a.lij[0],a.lij[1],a.lij[2],e.ELEVATION_NODATA_VALUE),m.then(function(a){return d(a)},g)):(b=f.getTileUrl(a.lij[0],a.lij[1],a.lij[2]),m=this._streamDataSupplier.request(b,
"binary"),m.then(function(a,b){b.url=a;d(b)},g))):A(!1,"_requestElevationTileData can only be called for elevation layer views");return m},c.prototype._requestMapTileData=function(a,b,c,f){function d(b){e._dispatchDataEvent(a,"dataArrived",c,f,b)}function g(b){L(b)||(e._dispatchDataEvent(a,"dataMissing",c,f,b),e.tilemapStats.tileRequestErrors++)}var e=this;if(q.isVectorTileLayerView(f)){var l=f.tileHandler;b=f.schemeHelper.getCompatibleLevelRowCol(a.lij);b=l.getVectorTileWithLRC(b[0],b[1],b[2],0);
b.then(d).otherwise(g).always(function(){e._vectorTileLayerRequests=l.ongoingRequestCount});this._vectorTileLayerRequests=l.ongoingRequestCount}else q.useFetchTileForLayer(f.layer)&&q.isTileLayerView(f)?(b=f.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2]),b.then(d).otherwise(g)):(b=f.getTileUrl(a.lij[0],a.lij[1],a.lij[2]),b=this._streamDataSupplier.request(b,"image"),b.then(function(a,b){return d(b)},g));return b},c.prototype.requestTilemap=function(a,b,c,f,k){var d=this,m=a.lij[0]+e.TILEMAP_SIZE_EXP,
l=a.lij[1]<<e.TILEMAP_SIZE_EXP,h=a.lij[2]<<e.TILEMAP_SIZE_EXP;return this.tilemapStats.tilemapRequestsSent++,this.tilemapStats.tilemapRequestsPending++,k.tilemapCache.fetchTilemap(m,l,h,{timeout:6E3}).then(function(e){d.tilemapStats.tilemapRequestsPending--;b=d._layerIndexByLayerViewId[c][f.uid];null!=b&&(a.layerInfo[c][b].tilemap=e)}).otherwise(function(a){d.tilemapStats.tilemapRequestsPending--;d.tilemapStats.tilemapRequestErrors++})},c.prototype.getTilemapTile=function(a){var b=a.lij[0];return b>
e.TILEMAP_SIZE_EXP?z.getTileNLevelsUp(a,e.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[b]},c.prototype._dispatchDataEvent=function(a,b,c,f,e){f=this._layerIndexByLayerViewId[c][f.uid];null!=f?a[b](f,c,e):t.warn("TerrainSurface: received data from unknown layer")},c.prototype._updateTileOverlayParams=function(){if(this.rootTiles){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(b,
b.renderData,this._curOverlayOpacity)}this._iteratorPool.release(a);this._renderer.setNeedsRender()}},c.prototype._updateOverlayOpacity=function(a){if(this.overlayManager&&(a=this.overlayManager.updateOpacity(a),!isNaN(a))){if(a!==this._curOverlayOpacity&&this.rootTiles){var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.renderData&&c.renderData.overlayTexId&&(c.renderData.overlayOpacity=a)}this._iteratorPool.release(b)}this._curOverlayOpacity=a;this._renderer.setNeedsRender()}},
c.prototype.getStats=function(){var a=0,b=0,c=0,f=[],e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var g=e.next();if(a++,g.renderData&&(b++,g.visible))c++,g=g.lij[0],f[g]=null!=f[g]?f[g]+1:1}return this._iteratorPool.release(e),{numNodes:a,numLeaves:b,numVisible:c,numVisiblePerLevel:f}},c.prototype.getMemoryUsage=function(){var a=0,b=0,c=0,f=0,k=0,g=0,m=this._iteratorPool.acquire();m.reset(this.rootTiles);for(var l=this.tilingScheme.pixelSize,l=l[0]*l[1]*4;!m.done;){var h=m.next(),
n=M(h),p;for(p in h.layerInfo[e.LayerClass.MAP]){var q=h.layerInfo[e.LayerClass.MAP][p].data,t=q&&q.descriptor?1.3*q.descriptor.width*q.descriptor.height*4:0,q=q&&!q.descriptor?l:0;h.renderData||n?(a+=q,f+=t):(b+=q,k+=t)}for(p in h.layerInfo[e.LayerClass.ELEVATION])q=h.layerInfo[e.LayerClass.ELEVATION][p].data,a+=q?l:0;h.renderData&&(n=h.renderData.texture,f+=n&&n.descriptor?1.3*n.descriptor.width*n.descriptor.height*4:0,h=h.renderData.geometryInfo.geometry,g+=h.data.estimateGpuMemoryUsage(),c+=2*
h.data.getIndices("terrain").length,c+=4*h.data.getAttribute("terrain").data.length)}return this._iteratorPool.release(m),{cpuVisibleImageData:a,cpuInvisibleImageData:b,cpuGeometryData:c,gpuVisibleImageData:f,gpuInvisibleImageData:k,gpuGeometryData:g}},c.prototype.getTile=function(a){var b=a.split("/").map(function(a){return+a});if(0===b[0])return this.rootTiles.forEach(function(a){return a.lij[1]===b[1]&&a.lij[2]===b[2]?a:void 0}),null;var c,e=Math.pow(2,b[0]),k=Math.floor(b[1]/e),g=Math.floor(b[2]/
e);if(this.rootTiles.some(function(a){return a.lij[1]===k&&a.lij[2]===g?(c=a,!0):!1}),c){for(e=1<<b[0]-1;c.lij[0]<b[0];){var h=b[1]&e?2:0;if(0<(b[2]&e)&&h++,!c.children[h])return console.log("Tile "+a+" doesn't exist, smallest ancestor is "+z.tile2str(c)),null;c=c.children[h];e>>=1}return A(c.lij[0]===b[0]&&c.lij[1]===b[1]&&c.lij[2]===b[2],"not the right tile?"),c}return null},c.prototype.hasPendingUpdates=function(){if(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)return!0;
var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)if(0<a.next().pendingUpdates)return this._iteratorPool.release(a),!0;return this._iteratorPool.release(a),!1},c.prototype.setBorders=function(a){this._renderer.setBorders(a)},c.prototype.setDisableRendering=function(a){this._renderer.setDisableRendering(a)},p([h.property({value:!1})],c.prototype,"cullBackFaces",null),p([h.property({readOnly:!0})],c.prototype,"extent",null),p([h.property({value:!1})],c.prototype,"frontMostTransparent",
null),p([h.property({readOnly:!0})],c.prototype,"loaded",void 0),p([h.property({value:1})],c.prototype,"opacity",null),p([h.property({readOnly:!0})],c.prototype,"overlayManager",void 0),p([h.property({readOnly:!0})],c.prototype,"manifold",void 0),p([h.property()],c.prototype,"maxTextureScale",void 0),p([h.property({readOnly:!0})],c.prototype,"ready",null),p([h.property({value:1})],c.prototype,"renderOrder",null),p([h.property({readOnly:!0})],c.prototype,"rootTiles",void 0),p([h.property({value:!0})],
c.prototype,"skirts",null),p([h.property({readOnly:!0,aliasOf:"tilingScheme.spatialReference"})],c.prototype,"spatialReference",void 0),p([h.property({value:e.DEFAULT_TILE_BACKGROUND})],c.prototype,"tileBackground",null),p([h.property({readOnly:!0})],c.prototype,"tilingScheme",void 0),p([h.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0),p([h.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],c.prototype,"tilingSchemeDone",
void 0),p([h.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0),p([h.property({value:!0})],c.prototype,"velvetOverground",null),p([h.property({value:!1})],c.prototype,"wireframe",null),c=p([h.subclass("esri.views.3d.terrain.TerrainSurface")],c)}(h.declared(Q,X.Evented));var ia=1.2,ja=80/180*Math.PI,F=e.MAX_ROOT_TILES,ka=12,n=e.TileUpdateTypes,w=E.create(),C=[0,0,0],u={spatialReference:null,tile:null,extent:null},v={spatialReference:null,extent:null,scale:0};return G});