//>>built
define(["require","exports","./UpsampleInfo","./tileUtils"],function(z,A,f,v){function m(b,a,h,d,e,k,t){return!b.parent||t>p?null:(d*=.5,e*=.5,k*=.5,1&b.lij[2]&&(e+=.5),0===(1&b.lij[1])&&(k+=.5),b.parent.hasLayerData(a,h))?(a=f.Pool.acquire(),a.init(b.parent,e,k,d),a):m(b.parent,a,h,d,e,k,t+1)}var p=6,g=Error("Abstract method called on TileAgentBase");return function(){function b(){}return b.prototype.init=function(a,b,d,e){this.tile=a;this.layerIdx=b;this.layerClass=d;this.suspended=e;this._tileLayerInfo=
a.getLayerInfo(b,d);this._dataRequested=null;a=this._findAncestorWithData();return a?(this._setUpsamplingTile(a.tile),f.Pool.release(a)):(this._tileLayerInfo.upsampleFromTile&&f.Pool.release(this._tileLayerInfo.upsampleFromTile),this._tileLayerInfo.upsampleFromTile=null),this._requestNext(!0)},b.prototype.dispose=function(){this._dataRequested&&(this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this),this._dataRequested=null);this._tileLayerInfo=this.tile=null},b.prototype.setSuspension=
function(a){a!==this.suspended&&(this.suspended=a,a?this._dataRequested&&(this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this),this._dataRequested=null):this._tileLayerInfo.data||this.update())},b.prototype.update=function(){var a=this._findAncestorWithData();return a&&this._tileLayerInfo.upsampleFromTile&&a.tile!==this._tileLayerInfo.upsampleFromTile.tile?this._setUpsamplingTile(a.tile):a&&f.Pool.release(a),this._requestNext()},b.prototype.dataArrived=function(a){throw g;},
b.prototype.dataMissing=function(a){this._dataRequested=null;this._tileLayerInfo.disposeData();this._requestNext()},b.prototype._agentDone=function(){this.tile.agentDone(this.layerIdx,this.layerClass);this.dispose()},b.prototype._requestNext=function(a){if(void 0===a&&(a=!1),this.suspended)return!0;var b=this._findNextDownload();if(this._dataRequested){if(b===this._dataRequested)return!0;this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this);this._dataRequested=null}b?b.requestLayerData(this.layerIdx,
this.layerClass,this)&&(this._dataRequested=b):a||this._agentDone();return!!this._dataRequested},b.prototype._findNextDownload=function(){for(var a,h=this.layerIdx,d=this.layerClass,e=this.tile.parentSurface.layerViewByIndex(h,d),k=e.minDataLevel,f=e.maxDataLevel,g=this._desiredMinLevelDelta(),m=b.START_LOADING_LEVEL_DELTA+g,p=this._scaleRangeEnabled,c=this.tile,q=0,w=c.lij[0],x=this._tileLayerInfo.upsampleFromTile?this._tileLayerInfo.upsampleFromTile.tile.lij[0]:-1,r=this.tile.parentSurface,y=r.tilemapStats,
l=r.getTilemapTile(c),u=!1;c&&(!p||v.fallsWithinLayer(c,e.layer,!1))&&c.lij[0]>=k;){var n=c.layerInfo[d][h];if(n.data&&q>=g){c.lij[0]>x&&this._setUpsamplingTile(c);n.dataInvalidated&&(a=c);break}if(l&&!l.tileDataAvailable(c,h,d))u=!0;else if(c.lij[0]<=f&&!n.data&&!n.dataMissing&&(a=c,q>=m))break;(c=c.parent)&&l&&(l=l.parent||r.getTilemapTile(c));q++}return a&&w-a.lij[0]<g&&this._tileLayerInfo.upsampleFromTile&&(a=null),!a&&u&&y.tilesNotPresent++,a},b.prototype._findAncestorWithData=function(){return m(this.tile,
this.layerIdx,this.layerClass,1,0,0,0)},b.prototype._desiredMinLevelDelta=function(){throw g;},b.prototype._setUpsamplingTile=function(a){throw g;},b.prototype._unsetUpsamplingTile=function(){this._tileLayerInfo.upsampleFromTile&&f.Pool.release(this._tileLayerInfo.upsampleFromTile);this._tileLayerInfo.upsampleFromTile=null},b.START_LOADING_LEVEL_DELTA=4,b.AGENT_DONE=new b,b}()});