//>>built
define("./terrainUtils ./tileUtils ./TerrainConst ./ElevationData ./TilePerLayerInfo ./ElevationTileAgent ./MapTileAgent ../support/mathUtils ../lib/glMatrix ../../../core/arrayUtils".split(" "),function(C,y,k,D,E,z,u,A,e,F){var l=e.vec3d,q=e.vec2d,v=e.vec4d,H=e.mat4d,G=C.weakAssert,w=l.create(),f=v.create(),r=v.create(),I=l.create(),m=u.AGENT_DONE,t=k.LayerClass.LAYER_CLASS_COUNT,B=k.LayerClass.MAP,n=k.LayerClass.ELEVATION,p=k.TileUpdateTypes;e=function(a,b,c){this.lij=[0,0,0];this.extent=v.create();
this.extentWGS84Rad=v.create();this.centerAtSeaLevel=l.create();this.center=l.create();this.tileUp=I;this.elevationBounds=q.create();this.children=[null,null,null,null];this.layerInfo=Array(t);this.intersectsClippingArea=this.isWithinClippingArea=!0;this.clippingArea=null;this._maxTesselation=0};return e.prototype.init=function(a,b,c,d){this.lij[0]=a[0];this.lij[1]=a[1];this.lij[2]=a[2];d.getExtent(a[0],a[1],a[2],this.extent,this.extentWGS84Rad);this.intersectsClippingArea=this.isWithinClippingArea=
!0;this.clippingArea=null;this.radius=this.edgeLen=0;this.vlevel=a?a[0]:0;b&&b.elevationBounds?q.set(b.elevationBounds,this.elevationBounds):q.set2(0,0,this.elevationBounds);this.parent=b;for(a=0;4>a;a++)this.children[a]=null;this.pendingUpdates=0;this.renderData=null;this.renderOrder=this.screenDepth=0;this.visible=!1;this.parentSurface=c;for(a=0;t>a;a++)if(c){var g;b=c.numLayers(a);this.layerInfo[a]?(g=this.layerInfo[a],g.length=b):(g=Array(b),this.layerInfo[a]=g);for(var e=0;b>e;e++)g[e]=E.makeEmptyLayerInfo(a,
g[e]),a==n&&this.findElevationBoundsForLayer(e,-1)}else this.layerInfo[a]=null;this.computeElevationBounds();this._maxTesselation=Math.min(d.pixelSize[0],k.MAX_TILE_TESSELATION)},e.prototype.dispose=function(){for(var a=0;t>a;a++)for(var b=this.layerInfo[a],c=0;c<b.length;c++)b[c].dispose()},e.prototype.updateScreenDepth=function(a){l.set(this.center,r);r[3]=1;H.multiplyVec4(a,r,r);this.screenDepth=r[2]/r[3]},e.prototype.shouldSplit=function(a,b){var c=this.lij[0];if(1>c)return p.SPLIT;l.subtract(this.center,
b,w);var d=l.length(w),g=this.edgeLen/(a[0]*d*2),d=this.edgeLen/(a[2]*d*2),e=a[1],h=a[3],k=a[4];a=a[5];return e>g?this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],p.VSPLITMERGE):p.NONE:c>=k?(d=c+Math.ceil(-A.log2(e/g)),d!==this.vlevel?(this.vlevel=d,p.VSPLITMERGE):p.NONE):6<c&&(l.scale(this.tileUp,l.dot(this.tileUp,w),f),l.subtract(f,w),l.length2(f)>this.radius*this.radius)&&(l.scale(f,this.radius/l.length(f)),l.add(f,this.center),l.subtract(b,f,f),b=this.elevationBounds[1]-this.elevationBounds[0],
b=Math.min(1,(Math.abs(l.dot(f,this.tileUp))+.5*b+this.curvatureHeight)/l.length(f)),.1/a*h>b*d)?p.NONE:p.SPLIT},e.prototype.decodeElevationData=function(a){var b;if(a instanceof ArrayBuffer)try{b=D.createFromLERC(this.lij,this.extent,a,k.noDataValueOpt)}catch(c){console.warn("Error decoding %s: %s",a.url,c.message)}else b=D.createFromFetchTileResult(this.lij,this.extent,a);return b},e.prototype.getWGS84Extent=function(){return this.extentWGS84Rad.map(A.rad2deg)},e.prototype.load=function(a){for(var b=
0;t>b;b++)this.layerInfo[b]&&this._createOrUpdateAgents(0,b);a.loadTile(this)},e.prototype.unload=function(a){this.renderData&&a.unloadTile(this);for(a=0;t>a;a++)for(var b=this.layerInfo[a],c=0;c<b.length;c++){var d=b[c];d.loadingAgent&&d.loadingAgent!==m&&(d.loadingAgent.dispose(),(a===k.LayerClass.ELEVATION?z:u).Pool.release(d.loadingAgent),d.loadingAgent=null);d.pendingUpdates=0}this.pendingUpdates&=~k.TileUpdateTypes.UPDATE_GEOMETRY;this.pendingUpdates&=~k.TileUpdateTypes.UPDATE_TEXTURE},e.prototype.updateClippingStatus=
function(a){F.equals(a,this.clippingArea)||(a?(this.intersectsClippingArea=this.intersectsExtent(a),this.isWithinClippingArea=this.isWithinExtent(a)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=a,this.renderData&&this.updateGeometry())},e.prototype.updateVisibility=function(a,b,c){a=c||this.isVisible(a,b)&&this.intersectsClippingArea;if(a!==this.visible)for(this.visible=a,b=this.layerInfo[0],c=0;c<b.length;c++){var d=b[c];d.loadingAgent&&d.loadingAgent!==m&&d.loadingAgent.setSuspension(!a)}return a},
e.prototype.getLayerInfo=function(a,b){return this.layerInfo[b][a]},e.prototype.hasLayerData=function(a,b){return(a=this.layerInfo[b][a])&&a.data&&!a.dataInvalidated},e.prototype.tileDataAvailable=function(a,b,c){return(b=this.layerInfo[c][b].tilemap)?"unavailable"!==b.getAvailability(a.lij[1],a.lij[2]):!0},e.prototype.requestLayerData=function(a,b,c){k.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),b,a,c.tile.lij.toString());var d=this.layerInfo[b][a];
if(-1<d.waitingAgents.indexOf(c))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),!0;if(d.data&&!d.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),d.waitingAgents.push(c),setTimeout(c.dataArrived.bind(c,this),0),!0;if(d.pendingUpdates&p.DECODE_ELEVATION)return d.waitingAgents.push(c),!0;if(d.waitingAgents.push(c),
!d.requestPromise){var g=this.parentSurface.requestTileData(this,a,b);if(g.isFulfilled())return!1;a=function(){d.requestPromise===g&&(d.requestPromise=null)};return d.requestPromise=g,g.then(a,a),!!g}return!0},e.prototype.descendants=function(a){a||(a=[]);for(var b=0;4>b;b++){var c=this.children[b];c&&(c.descendants(a),a.unshift(this.children[b]))}return a},e.prototype.isLij=function(a){return this.lij[0]===a[0]&&this.lij[1]===a[1]&&this.lij[2]==a[2]},e.prototype.findByLij=function(a){if(this.isLij(a))return this;
for(var b=0;4>b;b++){var c=this.children[b];if(c&&(c=c.findByLij(a)))return c}return null},e.prototype.unrequestLayerData=function(a,b,c){k.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),b,a,c.tile.lij.toString());var d=this.layerInfo[b][a],g=d.waitingAgents;c=g.indexOf(c);if(G(-1<c,"agent has not requested this piece of map data"),g[c]=g[g.length-1],g.length--,1>g.length)g=d.requestPromise,c=!1,b===B&&(c=this.parentSurface.layerViewByIndex(a,B),c=
C.isVectorTileLayerView(c)),c||G(g||d.rawData,"no pending operations on layerInfo that agents were waiting for"),g&&!g.isFulfilled()&&(g.cancel(),d.requestPromise=null),k.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),b,a)},e.prototype.dataArrived=function(a,b,c){a=this.layerInfo[b][a];a.data=c;a.dataInvalidated=!1;for(c=0;c<a.waitingAgents.length;c++)a.waitingAgents[c].dataArrived(this);a.waitingAgents.length=0},e.prototype.dataMissing=function(a,
b,c){c.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),b,a);a=this.layerInfo[b][a];a.dataMissing=!0;for(b=0;b<a.waitingAgents.length;b++)a.waitingAgents[b].dataMissing(this);a.waitingAgents.length=0},e.prototype.updateTexture=function(a){this.renderData&&(a?this.parentSurface._renderer.updateTileTexture(this):(this.pendingUpdates|=k.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface._pendingUpdates=!0))},e.prototype.invalidateLayerData=function(a,b){this.layerInfo[b][a].invalidateSourceData();
this.restartAgents(b)},e.prototype.computeElevationBounds=function(){q.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var a=this.layerInfo[n],b=!1,c=0;c<a.length;c++){var d=a[c];d.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],d.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],d.elevationBounds[1]),b=!0)}b||q.set2(0,0,this.elevationBounds);this.updateRadiusAndCenter()},e.prototype.updateRadiusAndCenter=function(){l.scale(this.tileUp,
.5*(this.elevationBounds[0]+this.elevationBounds[1]),f);l.add(this.centerAtSeaLevel,f,this.center)},e.prototype.findElevationBoundsForLayer=function(a,b){var c=this.layerInfo[n][a];if(!c.elevationBounds||c.elevationBounds[2]<b)if(b=this.parentSurface.layerViewByIndex(a,n),y.fallsWithinLayer(this,b.layer,!1)){b=!1;if(c.data)q.set(c.data.bounds,f),f[2]=this.lij[0],b=!0;else{for(var d=this.parent,g=0,e=null,h=c.data;d&&(!h||g<k.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(g=this.vlevel-d.lij[0],e=h||e,h=d.layerInfo[n][a].data,
!(!h&&e&&g>=k.ELEVATION_DESIRED_RESOLUTION_LEVEL));)d=d.parent;(h=h||e)&&(h.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],f),f[0]!==1/0&&(f[2]=h.level,b=!0))}b&&(c.elevationBounds?l.set(f,c.elevationBounds):c.elevationBounds=[f[0],f[1],f[2]])}},e.prototype.updateGeometry=function(){this.pendingUpdates|=k.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0},e.prototype.modifyLayers=function(a,b,c){for(var d=b.length,g=this.layerInfo[c],e=Array(d),h=0;h<g.length;h++){var f=
g[h];f.loadingAgent&&f.loadingAgent!==m&&(f.loadingAgent.dispose(),(c===k.LayerClass.ELEVATION?z:u).Pool.release(f.loadingAgent),f.loadingAgent=null);f.waitingAgents.length=0}if(c===B)for(h=0;h<g.length;h++)void 0===a[h]&&g[h].dispose();for(h=0;d>h;h++)a=b[h],e[h]=-1<a?g[a]:E.makeEmptyLayerInfo(c);this.layerInfo[c]=e},e.prototype.restartAgents=function(a){if(this.renderData)if(this._createOrUpdateAgents(0,a),a===n){this.updateGeometry();a=this.layerInfo[a];for(var b=0;b<a.length;b++)a[b].pendingUpdates|=
k.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0}else this.updateTexture(!0)},e.prototype.updateAgents=function(a){if(this.renderData){for(var b=this.layerInfo[a],c=0;c<b.length;c++){var d=b[c];d.loadingAgent===m&&(d.loadingAgent=null)}this._createOrUpdateAgents(0,a)}},e.prototype.removeLayerAgent=function(a,b){a=this.layerInfo[b][a];a.loadingAgent&&a.loadingAgent!==m&&a.loadingAgent.dispose();a.loadingAgent=null},e.prototype.agentDone=function(a,b){var c=this.layerInfo[b],
d=c[a];d.loadingAgent=m;d.data||d.upsampleFromTile||a<c.length-1&&this._createOrUpdateAgents(a+1,b)},e.prototype._createOrUpdateAgents=function(a,b){var c;c=b===n?!1:!this.visible;for(var d=this.layerInfo[b];a<d.length;){var e=d[a],f=!1,h=this.parentSurface.layerViewByIndex(a,b);if(null!==e.loadingAgent&&e.loadingAgent!==m)f=e.loadingAgent.update();else if(e.loadingAgent!==m&&y.fallsWithinLayer(this,h.layer,!1)){var l=b===k.LayerClass.ELEVATION?z:u,x=l.Pool.acquire();(f=x.init(this,a,b,c))?e.loadingAgent=
x:(x.dispose(),l.Pool.release(x),e.loadingAgent=m)}if(f&&!h.isTransparent)break;a++}},e.prototype.geometryState=function(a){var b,c=this._getElevationInfo(a?a.samplerData:null),d=this.lij[0],e=!1;c.samplerData?(b=this.vlevel-d,b=Math.max(d-c.maxTileLevel,k.ELEVATION_DESIRED_RESOLUTION_LEVEL-b),d=this._maxTesselation,b=A.clamp((d>>b)+1,2,d+1)):b=8>d?this._numSubdivisionsAtLevel[d]+1:2;d=this.clippingArea;return(!this.intersectsClippingArea||this.isWithinClippingArea)&&(d=null),a?(a.numVertsPerRow!==
b&&(a.numVertsPerRow=b,e=!0),c.changed&&(a.samplerData=c.samplerData,e=!0),F.equals(a.clippingArea,d)||(a.clippingArea=d,e=!0),a.needsUpdate=e):a={numVertsPerRow:b,samplerData:c.samplerData,needsUpdate:!0,clippingArea:d},a},e.prototype._getElevationInfo=function(a){for(var b=this.layerInfo[n],c=b.length,d=Array(c),e=0,f=0,h=!1,l=0;c>l;l++){var k=b[l];if(k.upsampleFromTile){var k=k.upsampleFromTile.tile,m=k.layerInfo[n][l].data;a&&a[e]===m.samplerData||(h=!0);d[e++]=m.samplerData;f=Math.max(f,k.lij[0])}else k.data&&
(m=this.parentSurface.layerViewByIndex(l,n),y.fallsWithinLayer(this,m.layer,!1)&&(a&&a[e]===k.data.samplerData||(h=!0),d[e++]=k.data.samplerData,f=this.lij[0]))}return a&&a.length!==e&&(h=!0),0<e?d.length=e:d=null,{changed:h,samplerData:d,maxTileLevel:f}},e.prototype.isWithinExtent=function(a){var b=this.extent;return b[0]>=a[0]&&a[2]>=b[2]&&b[1]>=a[1]&&a[3]>=b[3]},e.prototype.intersectsExtent=function(a){var b=this.extent;return b[2]>=a[0]&&a[2]>=b[0]&&b[3]>=a[1]&&a[3]>=b[1]},e});