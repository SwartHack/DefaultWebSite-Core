//>>built
define("require exports ../lib/glMatrix ../../webgl/FramebufferObject ../../webgl/VertexArrayObject ../../webgl/Texture ../../webgl/BufferObject ../../webgl/Util ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/DefaultVertexBufferLayouts ../../vectorTiles/VectorTileDisplayObject ../../vectorTiles/tileRendererHelper3D ./TerrainConst".split(" "),function(E,F,w,x,y,q,z,t,A,B,C,D,r){var m=w.vec2d,u=Array(20),v=[0,0];return function(){function k(e,a,c,b,g){this._gridTex=null;this.tileSize=
256;this._context=e;this.tileSize=a;this._resourceCounter=b;this._setNeedsRender=g;e.extensions.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,e.parameters.maxMaxAnisotropy));a=new Float32Array(20);a[0]=-1;a[1]=-1;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=-1;a[7]=0;a[8]=1;a[9]=0;a[10]=-1;a[11]=1;a[12]=0;a[13]=0;a[14]=1;a[15]=1;a[16]=1;a[17]=0;a[18]=1;a[19]=1;this._vaoQuad=new y(e,A.Default3D,{geometry:B.Pos3Tex},{geometry:z.createVertex(e,35044,a)});this._blendLayersProgram=c.get("blendLayers")}
return k.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);this._gridTex&&(this._gridTex.dispose(),this._gridTex=null);this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null);this._context&&(this._context=null)},k.prototype.updateTileTexture=function(e){for(var a=r.LayerClass.MAP,c=e.layerInfo[a],b=0;b<c.length;b++)c[b].pendingUpdates&=~r.TileUpdateTypes.UPDATE_TEXTURE;if(e.renderData){for(var g,
h,d,f=e.renderData,l=0,k=!0,b=0;b<c.length;b++){g=c[b];var p=e.parentSurface.layerViewByIndex(b,a);if(u[b]=p.fullOpacity,(g.data||g.upsampleFromTile)&&(l++,!p.isTransparent)){k=!1;break}}b===c.length&&b--;0===l&&this._gridTex?(f.textureReference=this._gridTex,m.set2(0,0,f.texOffset),f.texScale=1):1!==l||k?(this._composeMapLayers(e,c,b,k,u),f.textureReference=null,m.set2(0,0,f.texOffset),f.texScale=1):(g=c[b],g.data?(h=g,m.set2(0,0,f.texOffset),f.texScale=1):(d=g.upsampleFromTile,h=d.tile.layerInfo[a][b],
m.set(d.offset,f.texOffset),f.texScale=d.scale),h&&(h.data instanceof HTMLImageElement&&(h.data=this._buildTexture(h.data)),f.textureReference=h.data));this._setNeedsRender()}},k.prototype.setGridImage=function(e){this._gridTex=this._buildTexture(e)},k.prototype._buildTexture=function(e){var a,c={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},b=this._context;if(e)try{a=new q(b,c,e)}catch(g){c.width=c.height=this.tileSize,
a=new q(b,c),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else c.width=c.height=this.tileSize,a=new q(b,c);return b.bindTexture(a),a.generateMipmap(),a},k.prototype._drawVectorData=function(e,a,c,b,g,h,d,f,l){void 0===l&&(l=1);D(this._context,c,e,a.renderer,a.schemeHelper,c[0],b,g,0,h,d,f,l)},k.prototype._drawRasterData=function(e,a,c,b){void 0===b&&(b=1);var g=this._context,h=this._blendLayersProgram,d=this._vaoQuad;g.bindProgram(h);g.bindVAO(d);
t.assertCompatibleVertexAttributeLocations(d,h);g.bindTexture(e,0);h.setUniform1i("tex",0);h.setUniform1f("scale",a);h.setUniform2f("offset",c[0],c[1]);h.setUniform1f("opacity",b);g.drawArrays(5,0,t.vertexCount(d,"geometry"))},k.prototype._composeMapLayers=function(e,a,c,b,g){var h=r.LayerClass.MAP,d=this._context;e.renderData.texture||(e.renderData.texture=this._buildTexture());var f=e.renderData.texture,l=this._fbo;l&&l.width===f.descriptor.width&&l.height===f.descriptor.height||(l=x.create(d,{colorTarget:0,
depthStencilTarget:1,width:f.descriptor.width,height:f.descriptor.height}),this._fbo=l);var k=d.gl;d.bindFramebuffer(l);d.setViewport(0,0,this.tileSize,this.tileSize);d.setClearColor(0,0,0,0);d.setClearDepth(1);d.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT);d.setDepthTestEnabled(!1);d.setBlendFunctionSeparate(1,771,1,771);d.setBlendEquation(32774);d.setBlendingEnabled(!0);var p,m,n,q;for(b&&this._gridTex&&this._drawRasterData(this._gridTex,1,v);0<=c;c--)b=null,(p=a[c],p.data)?(b=p,m=v,n=1):p.upsampleFromTile&&
(n=p.upsampleFromTile,b=n.tile.layerInfo[h][c],q=n.tile.lij[0],m=n.offset,n=n.scale),b&&(((b.data instanceof HTMLImageElement||b.data instanceof HTMLCanvasElement)&&(b.data=this._buildTexture(b.data)),b.data instanceof C)?(l=e.parentSurface.layerViewByIndex(c,h),this._drawVectorData(b.data,l,e.lij,f.descriptor.width,f.descriptor.height,n,m,q,g[c])):this._drawRasterData(b.data,n,m,g[c]));d.bindTexture(f);k.copyTexImage2D(d.gl.TEXTURE_2D,0,f.descriptor.pixelFormat,0,0,f.descriptor.width,f.descriptor.height,
0);f.generateMipmap();d.bindFramebuffer(null);d.setBlendFunctionSeparate(770,771,1,771);d.setBlendingEnabled(!1);this._resourceCounter.incrementNumTileTexturesComposited()},k}()});