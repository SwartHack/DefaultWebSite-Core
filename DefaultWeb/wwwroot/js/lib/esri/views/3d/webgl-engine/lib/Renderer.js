//>>built
define("require exports ./IntervalUtilities ./ModelDirtyTypesTs ./Float32ArrayList ./InstanceBufferData ../lighting/SceneLighting ./LinearDepthTextureHelper ./NormalTextureHelper ./HighlightTextureHelper ./RenderPass ./RenderSlot ./RenderContext ./ExternalRendererContainer ./StencilRenderingHelper ./Util ./gl-matrix ./ComponentUtils ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ../../../webgl/Util ./FxaaRenderPass ./SmaaRenderPass ../../../webgl/enums ./DefaultVertexAttributeLocations ../../../webgl/Profiling ../materials/HUDMaterial".split(" "),
function(Z,va,aa,wa,ba,ha,ia,ja,ka,la,D,n,ma,na,oa,K,ca,da,ea,O,S,G,pa,qa,xa,T,ra,sa){function U(e){return da.generateVisibleIndexRanges(e.instanceParameters.componentVisibilities,e.componentOffsets)}function W(e,a,b){var d=e.origin.vec3;V(L,-d[0],-d[1],-d[2]);E.multiply(L,e.transformation,a);E.inverse(a,b);E.transpose(b)}function H(e,a,b){for(var d in e){var c=e[d];a(d,c);for(var f in c.origin2data)b(f,c.origin2data[f])}}function M(e){return!1===e.preinterleaved?ta(e.indices).length:e.indexCount}
var y,F=K.assert,X=K.objectEmpty,ta=K.getFirstObjectValue,V=K.setMatrixTranslation3;Z=ca.vec2d;var E=ca.mat4d,fa=K.VertexAttrConstants,P=E.identity();K=function(){function e(a,b,d,c,f){this._lighting=new ia.SceneLighting;this._mat2DataMerged={};this._mat2DataInstanced={};this._mat2DataPreinterleaved={};this._renderOrder=[];this._externalRenderers=new na;this._renderContext=new ma;this._isRendering=!1;this._highlights=[];this._pixelRatio=1;this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=
null;this._stats=new ua;this.ssaoEnabled=!1;this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._orderedRendering=f;this._rctx=c;this._fxaaPass=new pa(c);this._smaaPass=new qa(c);this._renderContext.lightingData=this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,
viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:c.extensions.angleInstancedArrays}};this._linearDepthTextureHelper=new ja(c);this._normalTextureHelper=new ka(c);this._highlightTextureHelper=new la(c);this._stencilRenderingHelper=new oa(c);this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?
a.RGBA:a.RGB,b=new ea(this._rctx,{target:3553,pixelFormat:a,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}},e.prototype.dispose=function(){var a=this,b=function(b){a._releaseMaterials(b)},d=function(a,b){if(b.type===y.Preinterleaved)for(var c in b.instances)b.instances[c].vao.dispose(!0);else b.vao.dispose(!0)};H(this._mat2DataMerged,b,d);H(this._mat2DataInstanced,b,d);H(this._mat2DataPreinterleaved,b,d);this._mat2DataPreinterleaved=this._mat2DataInstanced=
this._mat2DataMerged=null;this._framebuffer.texture.dispose();this._framebuffer.texture=null;this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable();this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable();this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1);this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1);this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),
this._fallbackDepthStencilTexture=null)},e.prototype.setLighting=function(a){this._lighting.set(a)},e.prototype.setPixelRatio=function(a){this._pixelRatio=a;this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(a,b){return this._externalRenderers.addRenderer(a,b),!0},e.prototype.removeExternalRenderer=function(a){return this._externalRenderers.removeRenderer(a),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},
e.prototype.resetNeedsRender=function(){this._needsRender=!1;this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){var a=this;this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;var b=function(){},d=function(b,d){if(d.type===y.Preinterleaved)for(var c in d.instances)b=d.instances[c].buffer,a._stats.VBOallocatedSize+=b.length,a._stats.VBOusedSize+=
b.length,a._stats.VBOoptimalSize+=b.length;else a._stats.VBOallocatedSize+=d.buffer.getArray().length,a._stats.VBOusedSize+=d.buffer.getSize(),a._stats.VBOoptimalSize+=d.optimalCount};return H(this._mat2DataMerged,b,d),H(this._mat2DataInstanced,b,d),H(this._mat2DataPreinterleaved,b,d),this._stats.VBOallocatedSize*=.00390625,this._stats.VBOusedSize*=.00390625,this._stats.VBOoptimalSize*=.00390625,this._stats},e.prototype._addHighlight=function(a){var b=this._getInstance(a);return null===b?void console.error("No instance found for RenderGeometry {name: '"+
a.name+"', uniqueName: '"+a.uniqueName+"'}"):(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,void(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)))},e.prototype._removeHighlight=function(a){var b=this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});b!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),
this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,configurable:!0}),e.prototype._renderHUDVisibility=function(a){var b=this,d=sa.shouldRenderVisibilityDuringRenderPass(a.pass),c=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.getEnableState();d&&c&&a.offscreenRenderingHelper.renderHUDVisibility(function(){b._renderInternalSlot(n.OCCLUSION_PIXELS,a)})},e.prototype.renderGeometrySlots=function(a){this._externalRenderers.render(n.INTERNAL_MATERIAL,
a);this._renderInternalSlot(n.STENCIL_MATERIAL,a);this._externalRenderers.render(n.OPAQUE_TERRAIN,a);this._renderInternalSlot(n.OPAQUE_MATERIAL,a);this._externalRenderers.render(n.OPAQUE_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._renderInternalSlot(n.TRANSPARENT_MATERIAL,a);this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(a),this._renderInternalSlot(n.LINE_CALLOUTS,this._renderContext));this._externalRenderers.render(n.TRANSPARENT_EXTERNAL,a);a.ssaoHelper&&
a.ssaoHelper.bindAll(this._programRep);this._externalRenderers.render(n.TRANSPARENT_TERRAIN,a)},e.prototype._renderHighlights=function(a,b,d){var c=!!d&&d.getEnableState()&&(this.hasHighlights||this._externalRenderers.needsHighlight());if(this._highlightTextureHelper.setEnableState(c),c){c=null;d.profilingCallback&&(c=ra.startMeasurement(this._renderContext.rctx));this._highlightTextureHelper.setupFBOs(a);this._highlightTextureHelper.prepareHighlightPass();this.renderGeometryPass(D.MATERIAL_HIGHLIGHT,
a,null,null);this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT);this._renderInternalSlot(n.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(n.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(n.HUDMATERIAL2,this._renderContext);this._highlightTextureHelper.finish(b);var f=this._highlightTextureHelper.getHighlightFBO();d.render(a,b,f);null!==c&&d.profilingCallback&&c.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}},e.prototype._needsRenderOccluded=function(a){for(var b in this._mat2DataInstanced){var d=
this._mat2DataInstanced[b][0];if(d&&d.isRenderOccluded()&&d.beginSlot(a)&&d.isVisible())return!0}return!1},e.prototype._renderOccluded=function(a,b,d){if(b&&d&&d.getEnableState()){var c=this._needsRenderOccluded(n.OPAQUE_MATERIAL)||this._needsRenderOccluded(n.TRANSPARENT_MATERIAL);if(c!==b.getEnableState()&&b.setEnableState(c),c)c=this._renderContext,b.setupFBOs(a),b.prepareColorPass(),c.pass=D.MATERIAL,c.renderOccludedOnly=!0,this._renderInternalSlot(n.OPAQUE_MATERIAL,c),this._renderInternalSlot(n.TRANSPARENT_MATERIAL,
c),c.renderOccludedOnly=!1,b.finish(d.getFramebuffer()),b.apply()}},e.prototype._renderUnordered=function(a,b,d,c){var f=this._rctx;this._isRendering=!0;this._stats.reset();this._updateGlobalUniforms(a.projectionMatrix);this._renderContext.pass=D.MATERIAL;this._renderContext.camera=a;this._renderContext.shadowMap=b;this._renderContext.ssaoHelper=c.ssao;this._renderContext.offscreenRenderingHelper=c.offscreenRendering;this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper;this._renderContext.depth=
this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO();this._renderContext.options=this.renderOptions;this._renderContext.rctx=this._rctx;this._renderContext.lightingData=this._lighting.getOld();c.offscreenRendering.setEnableState(!0);c.offscreenRendering.initializeFrame(a);this._externalRenderers.render(n.BACKGROUND,this._renderContext);this.renderGeometrySlots(this._renderContext);
this._externalRenderers.render(n.POSTPROCESSING_ATMOSPHERE,this._renderContext);this._externalRenderers.render(n.POSTPROCESSING_EXTERNAL,this._renderContext);this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(n.LINE_CALLOUTS,this._renderContext));this._renderOccluded(a,c.renderOccluded,c.offscreenRendering);b=this.renderOptions.antialiasing;"smaa"===b&&this._smaaPass.ensureEnabled()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:c.offscreenRendering.getColorTexture()},
null)):"fxaa"===b&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:c.offscreenRendering.getColorTexture()},null)):(b=a.viewport,b=E.ortho(b[0],b[2],b[1],b[3],-1,1),c.offscreenRendering.drawQuad(b),this._fxaaPass.disable(),this._smaaPass.disable());f.bindFramebuffer(null);this._renderContext.framebufferTex=c.offscreenRendering.getColorTexture();this._renderInternalSlot(n.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(n.HUDMATERIAL1,this._renderContext);
this._renderInternalSlot(n.HUDMATERIAL2,this._renderContext);this._renderHighlights(a,d,c.highlight);this._isRendering=!1},e.prototype._renderGeometryPassOrderedHighlight=function(a){this._renderInternalHighlights(this._highlights)},e.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var f=c.instanced||c.merged,e=f[a.pass];e&&e.isVisible()&&(this._renderInternalInstanced(f,e,this._bindParameters,
1/0),b=null)}c.merged&&(f=c.merged,(e=f[a.pass])&&e.isVisible()&&(c=e.getProgram(),c!==b&&(c.setUniformMatrix4fv("model",P),c.hasUniform("modelNormal")&&c.setUniformMatrix4fv("modelNormal",P)),b=c,this._renderInternalMerged(f,e,this._bindParameters,1/0)))}},e.prototype._renderGeometryPassOrdered=function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;N[0]=b.near;N[1]=b.far;this._bindParameters.nearFar=
N;this._bindParameters.lightingData=this._lighting.getOld();this._bindParameters.viewport=b.fullViewport;this._bindParameters.framebufferTex=this._framebuffer.texture;this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO();a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):this._renderGeometryPassOrderedMaterial(a)},
e.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,b)},e.prototype.render=function(a,b,d){this._orderedRendering?this._renderOrdered(D.MATERIAL,a):this._renderUnordered(a,d.shadowMap,b,d)},e.prototype.renderAuxiliaryBuffers=function(a,b,d){var c=d.ssao;d=d.shadowMap;var f=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();this._linearDepthTextureHelper.setEnableState(f);f&&(this._linearDepthTextureHelper.setupFBOs(a),this._linearDepthTextureHelper.prepareDepthPass(),
this.renderGeometryPass(D.MATERIAL_DEPTH,a,d,c),this._linearDepthTextureHelper.finish(b));this._normalTextureHelper.setEnableState(this.ssaoEnabled);this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(a),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(D.MATERIAL_NORMAL,a,d,c),this._normalTextureHelper.finish(b));this.ssaoEnabled&&c.computeSSAO(a,b,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO());c.bindAll(this._programRep)},e.prototype.renderGeometryPass=
function(a,b,d,c){this._isRendering=!0;this._updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=b;this._renderContext.shadowMap=d;this._renderContext.ssaoHelper=c;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.rctx=this._rctx;this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext);
this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)},e.prototype._renderInternalHighlights=function(a,b){void 0===b&&(b=null);for(var d=0;d<a.length;++d){var c=a[d],f=c.matData[D.MATERIAL_HIGHLIGHT];f&&(null===b||f.beginSlot(b))&&f.isVisible()&&this._renderInternalHighlight(c,this._bindParameters,D.MATERIAL_HIGHLIGHT)}},e.prototype._renderInternalSlotOccluded=function(a,b){for(var d in this._mat2DataInstanced){var c=this._mat2DataInstanced[d],f=c[b.pass];
f&&f.isRenderOccluded()&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalInstanced(c,f,this._bindParameters,a)}},e.prototype._renderInternalSlotMaterial=function(a,b){for(var d in this._mat2DataInstanced){var c=this._mat2DataInstanced[d],f=c[b.pass];f&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalInstanced(c,f,this._bindParameters,a)}for(var c=this._programRep.getProgramsUsingUniform("model"),f=this._programRep.getProgramsUsingUniform("modelNormal"),e=0;e<c.length;e++){var h=c[e];h.setUniformMatrix4fv("model",
P);-1<f.indexOf(h)&&h.setUniformMatrix4fv("modelNormal",P)}for(d in this._mat2DataMerged)c=this._mat2DataMerged[d],(f=c[b.pass])&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalMerged(c,f,this._bindParameters,a);for(d in this._mat2DataPreinterleaved)c=this._mat2DataPreinterleaved[d],(f=c[b.pass])&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalPreinterleaved(c,f,this._bindParameters,a);a===n.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()},e.prototype._renderInternalSlotHighlights=
function(a,b){this._renderInternalHighlights(this._highlights,a)},e.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;this._bindParameters.poiDistance=b.camera.distance;N[0]=b.camera.near;N[1]=b.camera.far;var d=this._renderContext.offscreenRenderingHelper;
this._bindParameters.nearFar=N;this._bindParameters.lightingData=this._lighting.getOld();this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.getColorTexture():null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.getEnableState();this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.getEnableState();this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=
void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();this._bindParameters.hudVisibilityTexture=d?d.getHUDVisibilityTexture():null;b.isHighlightPass?this._renderInternalSlotHighlights(a,b):b.renderOccludedOnly?this._renderInternalSlotOccluded(a,b):this._renderInternalSlotMaterial(a,b)},e.prototype._renderInternalInstanced=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,m=b.getDrawMode(f),g=this._bindParameters.extensions.angleInstancedArrays,l;for(l in a.origin2data){var p=
a.origin2data[l];d.origin=p.origin;c===n.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var k=!1;if(b.instanced)for(var q in p.perGeometryDataInfo){var w=p.perGeometryDataInfo[q];h||(b.bind(f,d),h=!0);f.bindVAO(w.vao);var r=b.getProgram();G.assertCompatibleVertexAttributeLocations(w.vao,r);k||(b.bindView(f,d),k=!0);var r=w.to-w.from,t=w.refCount;m===e.TRIANGLES&&(this._stats.trianglesRendered+=t*r/3);g.drawArraysInstancedANGLE(m,
w.from,r,t);this._stats.drawCallsAngleInstanced++;this._stats.instancesDrawnAngle+=t}else{var w=p.instances,y;for(y in w)r=w[y],(t=r.displayedIndexRange)&&0===t.length||(h||(b.bind(f,d),h=!0),k||(f.bindVAO(p.vao),b.bindView(f,d),k=!0),b.bindInstance(f,r),this._stats.drawCallsInstanced++,m===e.TRIANGLES&&(this._stats.trianglesRendered+=(r.to-r.from)/3),t?this._drawArraysFaceRange(t,r.from,m):f.drawArrays(m,r.from,r.to-r.from))}}f.bindVAO(null);h&&b.release(f,d)},e.prototype._renderInternalHighlight=
function(a,b,d){var c=this._rctx,f=c.gl;d=a.matData[d];var e=d.getDrawMode(c),h=a.instance,m=h.highlightedIndexRange,g=this._renderContext.offscreenRenderingHelper,g=(g?g.getDepthTexture():null)||this._getFallbackDepthTexture(),l=d.getProgram(),p=this._bindParameters.extensions.angleInstancedArrays;if(b.origin=a.originData.origin,d.instanced&&a.type===y.Instanced)for(a=a.instancedVAO,d.bind(c,b),c.bindVAO(a),G.assertCompatibleVertexAttributeLocations(a,l),d.bindView(c,b),a=0;a<m.length;a++){var k=
m[a],q=k.range?k.range[0]+h.from:h.from,k=k.range?k.range[1]-k.range[0]+1:h.to-h.from;c.bindTexture(g,5);l.setUniform1i("depthTex",5);l.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);p.drawArraysInstancedANGLE(e,q,k,1);e===f.TRIANGLES&&(this._stats.trianglesRendered+=1*k/3);this._stats.drawCallsHighlight++}else if(a.type===y.Instanced&&d.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{switch(d.bind(c,
b),d.bindView(c,b),a.type){case y.Merged:p=a.originData;c.bindVAO(p.vao);l.setUniformMatrix4fv("model",P);break;case y.Instanced:p=a.originData;c.bindVAO(p.vao);d.bindInstance(c,h);break;case y.Preinterleaved:p=a.originData,a=p.instances[a.uniqueName].vao,c.bindVAO(a),d.bindInstance(c,h)}for(a=0;a<m.length;a++)k=m[a],q=k.range?k.range[0]+h.from:h.from,k=k.range?k.range[1]-k.range[0]+1:h.to-h.from,c.bindTexture(g,5),d.getProgram().setUniform1i("depthTex",5),l.setUniform4f("highlightViewportPixelSz",
0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),c.drawArrays(e,q,k),e===f.TRIANGLES&&(this._stats.trianglesRendered+=k/3),this._stats.drawCallsHighlight++}c.bindVAO(null);d.release(c,b)},e.prototype._drawArraysFaceRange=function(a,b,d){for(var c=this._rctx,f=0;f<a.length;f++){var e=a[f];c.drawArrays(d,e[0]+b,e[1]-e[0]+1)}this._stats.drawCallsFragmented+=a.length-1},e.prototype._renderInternalMerged=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,m;for(m in a.origin2data){var g=
a.origin2data[m];if(d.origin=g.origin,c===n.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass()),!g.displayedIndexRange||0!==g.displayedIndexRange.length){h||(b.bind(f,d),h=!0);var l=b.getProgram();f.bindVAO(g.vao);G.assertCompatibleVertexAttributeLocations(g.vao,l);b.bindView(f,d);this._stats.drawCallsMerged++;l=b.getDrawMode(f);l===e.TRIANGLES&&(this._stats.trianglesRendered+=g.vao.vertexBuffers.geometry.size/3);g.displayedIndexRange?
this._drawArraysFaceRange(g.displayedIndexRange,0,l):f.drawArrays(l,0,G.vertexCount(g.vao,"geometry"))}}h&&b.release(f,d)},e.prototype._renderInternalPreinterleaved=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,m=b.getDrawMode(f),g;for(g in a.origin2data){var l=a.origin2data[g];d.origin=l.origin;var p=!1;c===n.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());for(var k in l.instances){var q=l.instances[k],w=q.instance,q=q.vao,
r=w.displayedIndexRange;if(!r||0!==r.length){h||(b.bind(f,d),h=!0);var t=b.getProgram();G.assertCompatibleVertexAttributeLocations(q,t);f.bindVAO(q);p||(b.bindView(f,d),p=!0);b.bindInstance(f,w);this._stats.drawCallsPreinterleaved++;m===e.TRIANGLES&&(this._stats.trianglesRendered+=(w.to-w.from)/3);r?this._drawArraysFaceRange(r,w.from,m):f.drawArrays(m,w.from,w.to-w.from)}}}f.bindVAO(null);h&&b.release(f,d)},e.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),
d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}},e.prototype.print=function(){var a=Object.keys(this._mat2DataMerged).length,b=Object.keys(this._mat2DataInstanced).length,d=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+
a+"/"+b+"/"+d);var c=0;H(this._mat2DataMerged,function(){},function(a,b){c+=Object.keys(b.instances).length});var f=0;H(this._mat2DataInstanced,function(){},function(a,b){f+=Object.keys(b.instances).length});var e=0;H(this._mat2DataPreinterleaved,function(){},function(a,b){e+=Object.keys(b.instances).length});console.log("number of instances (merged/instanced/preinterleaved): "+c+"/"+f+"/"+e)},e.prototype.isEmpty=function(){for(var a in this._mat2DataInstanced){var b=this._mat2DataInstanced[a],d;
for(d in b.origin2data)if(!X(b.origin2data[d].instances))return!1}for(a in this._mat2DataMerged)for(d in b=this._mat2DataMerged[a],b.origin2data)if(!X(b.origin2data[d].instances))return!1;for(a in this._mat2DataPreinterleaved)for(d in b=this._mat2DataPreinterleaved[a],b.origin2data)if(!X(b.origin2data[d].instances))return!1;return!0},e.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var f=[],e=[],h=[];this._classifyRenderGeometry(a,f,e,
h);a=[];var m=[],g=[];this._classifyRenderGeometry(b,a,m,g);var l={};d&&this._performUpdates(d,l);d=[];this._modifyMerged(f,a,d,l);this._modifyInstanced(e,m,d);this._modifyPreinterleaved(h,g,d);this._updateMergedFaceranges(l);this._releaseMaterials(d);f=this._highlights.length;b&&0<b.length&&0<f&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===a.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights));
this._updateHighlightVAOs();this._modifyMaterials(c);this._needsRender=!0},e.prototype._classifyRenderGeometry=function(a,b,d,c){for(var f=0;f<a.length;f++){var e=a[f];if(1<=M(e.data))switch(this._getType(e)){case y.Merged:b.push(e);break;case y.Instanced:d.push(e);break;case y.Preinterleaved:c.push(e)}}},e.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=a[d],f=c.updateType,c=c.renderGeometry,e=this._getType(c)===y.Merged;if(1<=M(c.data)){if(2&f&&this._updateFaceranges(c,
b),32&f){var h=this._getInstance(c);h&&this._updateHighlightFaceranges(c,h.instance)}4&f||e&&16&f?this._updateVertexAttributes(c,!e):!e&&16&f?this._updateInstanceTransformation(c):8&f&&this._updateColorAttributes(c)}}},e.prototype._updateFaceranges=function(a,b){var d,c=a.material.getId(),f=a.origin.id,e=this._getType(a);if(e===y.Preinterleaved){var h=this._getOriginData(e,c,f);d=h.instances[a.uniqueName].instance}else h=this._getOriginData(e,c,f),(d=h.instances[a.uniqueName])&&e===y.Merged&&(b[this._modifiedMergedFacerangesKey(c,
f)]=h);d&&(d.displayedIndexRange=U(a),this._updateHighlightFaceranges(a,d))},e.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=da.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):!c&&d&&this._removeHighlight(a)}},e.prototype._updateMergedFaceranges=function(a){for(var b in a){var d=a[b];d.displayedIndexRange=[];var c=
d.instances,f=!0,e;for(e in c){var h=c[e];h.displayedIndexRange?(d.displayedIndexRange.push.apply(d.displayedIndexRange,aa.offsetIntervals(h.displayedIndexRange,h.from)),f=!1):d.displayedIndexRange.push([h.from,h.to-1])}f?d.displayedIndexRange=null:d.displayedIndexRange=aa.mergeIntervals(d.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(a,b){var d,c,f,e=a.material;d=e.getId();c=a.origin.id;var h=G.getStride(e.getVertexBufferLayout())/4;f=this._getType(a);if(f===y.Preinterleaved)f=
this._getOriginData(f,d,c),b=f.instances[a.uniqueName],d=b.instance,c=b.buffer,f=b.vao;else{f=this._getOriginData(f,d,c);d=f.instances[a.uniqueName];c=f.buffer.getArray();f=f.vao;var m=void 0,g=void 0;b||(W(a,Q,R),m=Q,g=R);e.fillInterleaved(a.data,m,g,a.instanceParameters,c,d.from*h)}F(d.from+e.getOutputAmount(M(a.data))/h===d.to,"material VBO layout has changed");f.vertexBuffers.geometry.setSubData(c,d.from*h*4,d.from*h*4,d.to*h*4)},e.prototype._updateInstanceTransformation=function(a){var b=this._getType(a),
d=a.material.getId(),c=a.origin.id;if(b===y.Preinterleaved)b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName].instance,W(a,c.transformation,c.transformationNormal);else if(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName],b=b.perGeometryDataInfo[a.data.id],d=b.instanceBufferData,W(a,c.transformation,c.transformationNormal),d)a=d.getSlot(a.idx),d.fill(a,0,c.transformation),d.fill(a,16,c.transformationNormal),a=4*d.getOffset(a),c=G.getStride(b.vao.layout.instance),b.vao.vertexBuffers.instance.setSubData(d.getArray(),
a,a,a+c)},e.prototype._updateColorAttributes=function(a){var b,d,c,f=a.material;b=f.getId();d=a.origin.id;var e=G.getStride(f.getVertexBufferLayout())/4;c=this._getType(a);if(c===y.Preinterleaved){c=this._getOriginData(c,b,d);var h=c.instances[a.uniqueName];b=h.instance;d=h.buffer;c=h.vao}else{c=this._getOriginData(c,b,d);b=c.instances[a.uniqueName];d=c.buffer.getArray();c=c.vao;var m=(h={},h[fa.COLOR]=!0,h[fa.SYMBOLCOLOR]=!0,h);f.fillInterleaved(a.data,void 0,void 0,a.instanceParameters,d,b.from*
e,m)}F(b.from+f.getOutputAmount(M(a.data))/e===b.to,"material VBO layout has changed");c.vertexBuffers.geometry.setSubData(d,b.from*e*4,b.from*e*4,b.to*e*4)},e.prototype._modifyMerged=function(a,b,d,c){var e=this._rctx,ga=y.Merged;a=this._compMat2delta(a,b,ga);b=this._mat2DataMerged;for(var h in a){var m=a[h],g;for(g in m){var l=m[g],p=l.optimalCount,k=l.material,q=k.getVertexBufferLayout(),w=G.getStride(q)/4,r=b[h];if(null==r){F(0<p);var t=k.getRenderPriority(),r=this._initializeMatData(k);b[h]=
r;this._orderedRendering&&this._insertIntoRenderOrder(r,t,"merged")}t=r.origin2data[g];if(null==t&&(F(0<p),t={type:ga,instances:{},vao:new O(e,T.Default3D,{geometry:q},{geometry:S.createVertex(e,35044)}),buffer:new ba(p),optimalCount:0,origin:l.origin},r.origin2data[g]=t),0<p){var q=t.buffer.getSize(),n=t.buffer.getArray(),r=p<l.sparseCount/2,A=t.buffer.resize(r?p:l.sparseCount),x=l.toRemove;if(r||A){for(var q=0,z=t.buffer.getArray(),r=0;r<x.length;++r)A=t.instances[x[r].uniqueName],t.optimalCount-=
(A.to-A.from)*w,delete t.instances[x[r].uniqueName];var r={},B;for(B in t.instances)A=t.instances[B],F(null==r[A.from]),r[A.from]=A;for(var u in r){var A=r[u],v=A.from*w,C=A.to*w;z.set(n.subarray(v,C),q);A.from=q/w;q+=C-v;A.to=q/w}F(q===t.optimalCount)}else for(r=0;r<x.length;++r)A=x[r].uniqueName,F(void 0!==t.instances[A]),v=t.instances[A].from*w,C=t.instances[A].to*w,t.buffer.erase(v,C),delete t.instances[A],t.optimalCount-=C-v;V(L,-l.origin[0],-l.origin[1],-l.origin[2]);n=l.toAdd;l=!1;for(r=0;r<
n.length;++r)x=n[r],v=x.data,E.multiply(L,x.transformation,Q),E.inverse(Q,R),E.transpose(R),A=q,k.fillInterleaved(v,Q,R,x.instanceParameters,t.buffer.getArray(),q),v=k.getOutputAmount(M(v)),z=A+v,F(null==t.instances[x.uniqueName]),C=U(x),A=new Y(x.name,A/w,z/w,C,void 0,void 0,x.idx),t.instances[x.uniqueName]=A,this._updateHighlightFaceranges(x,A),C&&(l=!0),t.optimalCount+=v,q+=v;F(t.optimalCount===p);p=new Float32Array(t.buffer.getArray().buffer,0,t.buffer.getSize());t.vao.vertexBuffers.geometry.setData(p);
(l||t.displayedIndexRange)&&(c[this._modifiedMergedFacerangesKey(h,g)]=t)}else F(0===p),t.vao.dispose(!0),t.vao=null,delete r.origin2data[g],0===Object.keys(r.origin2data).length&&(d.push(h),delete b[h],this._orderedRendering&&this._removeFromRenderOrder(r,"merged"))}}},e.prototype._modifyInstanced=function(a,b,d){var c=this._rctx,e=y.Instanced;a=this._compMat2delta(a,b,e);b=this._mat2DataInstanced;for(var n in a){var h=a[n],m;for(m in h){var g=h[m];if(0!==g.optimalCount){var l=g.material,p=b[n];
if(null==p){var k=l.getRenderPriority(),p=this._initializeMatData(l);b[n]=p;this._orderedRendering&&this._insertIntoRenderOrder(p,k,"instanced")}var q=l.getVertexBufferLayout(),w=p[D.MATERIAL].instanced?l.getInstanceBufferLayout():void 0,r=w&&G.findAttribute(w,"instanceColor"),t=w&&G.findAttribute(w,"instanceFeatureAttribute"),J=G.getStride(q)/4,k=p.origin2data[m];null==k&&(k={type:e,instances:{},vao:new O(c,T.Default3D,{geometry:q},{geometry:S.createVertex(c,35044)}),buffer:new ba(g.optimalCount),
optimalCount:0,perGeometryDataInfo:{},origin:g.origin},p.origin2data[m]=k);var p=k.buffer.getSize(),A=k.buffer.getArray(),x=g.optimalCount<g.sparseCount/2,z=k.buffer.resize(x?g.optimalCount:g.sparseCount),B;for(B in g.perGeometryDelta){var u=k.perGeometryDataInfo[B];if(u&&u.instanceBufferData){var v=g.perGeometryDelta[B].removeCount;0<v&&u.instanceBufferData.prepareFree(v)}}var C=g.toRemove;if(x||z){for(x=0;x<C.length;++x){z=C[x];delete k.instances[z.uniqueName];B=z.data.id;var I=u=k.perGeometryDataInfo[B];
0===--I.refCount&&null==g.dataId2refCount[B]?(k.optimalCount-=(I.to-I.from)*J,delete k.perGeometryDataInfo[B]):u.instanceBufferData&&u.instanceBufferData.free(z.idx)}var p=0,x=k.buffer.getArray(),z={},H;for(H in k.perGeometryDataInfo)I=k.perGeometryDataInfo[H],F(null==z[I.from]),z[I.from]=I;for(var K in z)I=z[K],v=I.from*J,u=I.to*J,x.set(A.subarray(v,u),p),I.from=p/J,p+=u-v,I.to=p/J;for(var N in k.instances)v=k.instances[N],v.from=k.perGeometryDataInfo[v.dataId].from,v.to=k.perGeometryDataInfo[v.dataId].to}else for(x=
0;x<C.length;++x)z=C[x],delete k.instances[z.uniqueName],B=z.data.id,u=k.perGeometryDataInfo[B],0===--u.refCount&&null==g.dataId2refCount[B]?(v=u.from*J,u=u.to*J,k.buffer.erase(v,u),k.optimalCount-=u-v,delete k.perGeometryDataInfo[B]):u.instanceBufferData&&u.instanceBufferData.free(z.idx);V(L,-g.origin[0],-g.origin[1],-g.origin[2]);for(B in g.perGeometryDelta)(u=k.perGeometryDataInfo[B])&&u.instanceBufferData&&(x=g.perGeometryDelta[B].addCount,0<x&&u.instanceBufferData.prepareAllocate(x));A=g.toAdd;
for(x=0;x<A.length;++x){z=A[x];v=z.data;B=v.id;u=k.perGeometryDataInfo[B];if(null==u){l.fillInterleaved(v,void 0,void 0,void 0,k.buffer.getArray(),p);C=l.getOutputAmount(M(v));v=p/J;p+=C;u=p/J;if(k.optimalCount+=C,u={refCount:1,from:v,to:u,vao:null,instanceBufferData:null},w)v=G.getStride(w)/4,u.vao=new O(c,T.Default3D,{geometry:q,instance:w},{geometry:k.vao.vertexBuffers.geometry,instance:S.createVertex(c,35044)}),u.instanceBufferData=new ha(v,g.perGeometryDelta[B].addCount);k.perGeometryDataInfo[B]=
u}else++u.refCount;F(u.from*J<=k.buffer.getSize()&&u.to*J<=k.buffer.getSize());v=E.create();E.multiply(L,z.transformation,v);C=U(z);v=new Y(z.name,u.from,u.to,C,v,z.instanceParameters,z.idx,B);k.instances[z.uniqueName]=v;this._updateHighlightFaceranges(z,v);if(u=u.instanceBufferData)C=u.allocate(z.idx),u.fill(C,0,v.transformation),u.fill(C,16,v.transformationNormal),r&&u.fill(C,r.offset/4,z.instanceParameters.color),t&&u.fill(C,t.offset/4,z.instanceParameters.featureAttribute)}F(k.optimalCount===
g.optimalCount);l=new Float32Array(k.buffer.getArray().buffer,0,k.buffer.getSize());k.vao.vertexBuffers.geometry.setData(l);for(B in k.perGeometryDataInfo)if(q=k.perGeometryDataInfo[B],q.vao&&(l=q.vao.vertexBuffers.instance))w=g.perGeometryDelta[B],0<w.addCount+w.removeCount&&(q=q.instanceBufferData.compact(),l.setData(q))}else g=b[n],g.origin2data[m].vao.dispose(!0),delete g.origin2data[m],0===Object.keys(g.origin2data).length&&(d.push(n),delete b[n],this._orderedRendering&&this._removeFromRenderOrder(g,
"instanced"))}}},e.prototype._modifyPreinterleaved=function(a,b,d){for(var c=this._rctx,e=y.Preinterleaved,n=this._mat2DataPreinterleaved,h=0;h<a.length;h++){var m=a[h],g=m.material,l=g.getId(),p=m.origin.id,k=m.origin.vec3,q=n[l];null==q&&(q=this._initializeMatData(g),n[l]=q);l=q.origin2data[p];null==l&&(l={type:e,origin:k,count:0,instances:{}},q.origin2data[p]=l);V(L,-k[0],-k[1],-k[2]);q=E.create();E.multiply(L,m.transformation,q);k=U(m);p=m.data;p.preinterleaved?(q=new Y(m.name,0,p.indexCount,
k,q,m.instanceParameters,m.idx,p.id),g=g.getVertexBufferLayout(),g=new O(c,T.Default3D,{geometry:g},{geometry:S.createVertex(c,35044)}),g.vertexBuffers.geometry.setData(p.vertexData),l.count+=1,l.instances[m.uniqueName]={instance:q,vao:g,buffer:p.vertexData},this._updateHighlightFaceranges(m,q)):F(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(a=0;a<b.length;a++)m=b[a],k=m.origin,g=m.material,l=g.getId(),p=k.id,m=m.uniqueName,q=n[l],c=q.origin2data[p],c.instances[m].vao.dispose(),
delete c.instances[m],--c.count,0===c.count&&delete q.origin2data[p],0===Object.keys(q.origin2data).length&&(d.push(l),delete n[l])},e.prototype._compMat2delta=function(a,b,d){var c={};return this._updateMat2delta(a,!0,d,c),this._updateMat2delta(b,!1,d,c),c},e.prototype._updateMat2delta=function(a,b,d,c){d=d===y.Instanced;for(var e=0;e<a.length;e++){var n=a[e],h=n.origin,m=n.material,g=m.getId(),l=d?this._mat2DataInstanced[g]:this._mat2DataMerged[g],l=l&&l.origin2data[h.id],p=c[g];null==p&&(p={},
c[g]=p);g=p[h.id];if(null==g){if(g={optimalCount:null==l?0:l.optimalCount,sparseCount:null==l?0:l.buffer.getSize(),material:m,toAdd:[],toRemove:[],perGeometryDelta:null,origin:h.vec3},d){var k={};if(void 0!==l)for(var q in l.perGeometryDataInfo)k[q]=l.perGeometryDataInfo[q].refCount;g.dataId2refCount=k;g.perGeometryDelta={}}p[h.id]=g}h=m.getOutputAmount(M(n.data));d?(m=n.data.id,(l=g.perGeometryDelta[m])||(l={addCount:0,removeCount:0},g.perGeometryDelta[m]=l),b?(l.addCount++,null==g.dataId2refCount[m]&&
(g.dataId2refCount[m]=0),1===++g.dataId2refCount[m]&&(g.optimalCount+=h,g.sparseCount+=h),g.toAdd.push(n)):(l.removeCount++,0===--g.dataId2refCount[m]&&(delete g.dataId2refCount[m],g.optimalCount-=h),g.toRemove.push(n))):b?(g.optimalCount+=h,g.sparseCount+=h,g.toAdd.push(n)):(g.optimalCount-=h,g.toRemove.push(n))}},e.prototype._getType=function(a){if(a.data.preinterleaved)return y.Preinterleaved;var b=!1,d=M(a.data);return b=b||!1===a.material.canBeMerged,b=b||a.material.instanced,b=b||a.material.isBackdrop,
b=b||!0===a.material.isRenderOccluded(),a.singleUse||(b=b||d>this._threshold),b?y.Instanced:y.Merged},e.prototype._getTargetMat2Data=function(a){switch(a){case y.Merged:return this._mat2DataMerged;case y.Instanced:return this._mat2DataInstanced;case y.Preinterleaved:return this._mat2DataPreinterleaved}},e.prototype._getOriginData=function(a,b,d){return this._getTargetMat2Data(a)[b].origin2data[d]},e.prototype._modifiedMergedFacerangesKey=function(a,b){return a+"_"+b},e.prototype._insertIntoRenderOrder=
function(a,b,d){for(var c=a[D.MATERIAL].getMaterialId(),e=this._renderOrder.length,n=0;e>n&&this._renderOrder[n][0]>=b;){var h=this._renderOrder[n][1];if(h.id===c)return F(!h[d],"matData for type already exists"),void(h[d]=a);n++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(n,0,[b,c])},e.prototype._removeFromRenderOrder=function(a,b){var d=a[D.MATERIAL].getMaterialId();for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;d.instanced||d.merged||this._renderOrder.splice(a,
1)},e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(a,b){a=a.matData[D.MATERIAL].getRenderPriority();b=b.matData[D.MATERIAL].getRenderPriority();return a>b?-1:b>a?1:0})},e.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;d>c&&b[c][1].id!==a;)c++;if(d>c){a=b[c][1];a=(a.merged||a.instanced)[D.MATERIAL].getRenderPriority();var e=b[c][0];if(a!==b[c][0])for(b[c][0]=a,e=a>e?-1:1,c+=e;-1<c&&d>c&&e*b[c][0]>e*a;){var n=b[c];b[c]=b[c-e];b[c-e]=n;c+=e}}},e.prototype._modifyMaterials=
function(a){for(var b in a)this._materialRep.updateMaterialParameters(b)},e.prototype.modifyRenderOrder=function(a){if(this._orderedRendering){for(var b in a)this._updateRenderOrder(b,this._renderOrder);this._sortHighlightsByRenderOrder();this._needsRender=!0}},e.prototype._initializeMatData=function(a){var b={origin2data:{}};return b[D.MATERIAL]=this._materialRep.aquire(a),b[D.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(a),b[D.MATERIAL_NORMAL]=this._materialRep.aquireNormal(a),
b[D.MATERIAL_DEPTH]=this._materialRep.aquireDepth(a),b[D.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(a),b},e.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),
this._materialRep.releaseDepth(a),this._materialRep.releaseHighlight(a)},e.prototype._getInstance=function(a){var b=a.uniqueName,d=a.material.getId(),c=this._getType(a),d=this._getTargetMat2Data(c)[d];if(!d)return null;a=d.origin2data[a.origin.id];if(!a)return null;var e;return e=a.type===y.Preinterleaved?a.instances[b].instance:a.instances[b],e?{type:c,uniqueName:b,instance:e,matData:d,originData:a,instancedVAO:null,instancedVAOBaseInstance:null}:null},e.prototype._createBaseInstanceVAO=function(a){var b=
this._rctx,d=a.instance,c=a.originData;if(a.type===y.Instanced&&c.perGeometryDataInfo){var c=c.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==d&&(e=G.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new O(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}},e.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])},e.prototype._getFallbackDepthTexture=
function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new ea(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}();var ua=function(){function e(){this.reset()}return e.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsPreinterleaved=
this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=0},e}(),Y=function(){return function(e,a,b,d,c,f,n,h){this.name=e;this.from=a;this.to=b;this.displayedIndexRange=d;this.transformation=c;this.instanceParameters=f;this.idx=n;this.dataId=h;null!=c&&(this.transformationNormal=E.create(),E.set(c,this.transformationNormal),E.inverse(this.transformationNormal,this.transformationNormal),E.transpose(this.transformationNormal,this.transformationNormal))}}();!function(e){e[e.Merged=
0]="Merged";e[e.Instanced=1]="Instanced";e[e.Preinterleaved=2]="Preinterleaved"}(y||(y={}));var N=Z.create(),L=E.identity(),Q=E.create(),R=E.create();return K});