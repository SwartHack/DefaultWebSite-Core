//>>built
define("require exports dojo/has ./PerformanceTimer ./gl-matrix ./Object3D".split(" "),function(p,x,u,v,b,w){var r=b.vec3d.create(),t=b.vec3d.create(),n=u("dojo-debug-messages");p=function(){function a(g,c,a,k,h,d,e,f){void 0===f&&(f=!1);this.dir=b.vec3d.create();this.normalDir=null;this.minResult=new q;this.maxResult=new q;this.transform=b.mat4d.create();this._transformInverse=new m({value:this.transform},b.mat4d.inverse,b.mat4d.create);this._transformInverseTranspose=new m(this._transformInverse,
b.mat4d.transpose,b.mat4d.create);this._transformTranspose=new m({value:this.transform},b.mat4d.transpose,b.mat4d.create);this._transformInverseRotation=new m({value:this.transform},b.mat4d.toInverseMat3,b.mat3d.create);this.enableTerrain=this.enableHUDSelection=!0;this.enableInvisibleTerrain=!1;this.enableBackfacesTerrain=!0;this.performanceInfo={queryDuration:0,numObjectsTested:0};this.viewingMode=g||"global";this.intersectObject=this.intersectObject.bind(this);n&&(this.timer=new v(1));this.init(c,
a,k,h,d,e,f)}return a.prototype.init=function(g,c,a,k,h,d,e){if(c&&a&&b.vec3d.subtract(a,c,this.dir),this.minResult.init(c,a),this.maxResult.init(c,a),this.numObjectsTested=0,this.point=k,this.camera=h,this.isSelection=e,this.layers=g,this.p0=c,this.p1=a,this.hudResults=[],null==d&&(d=1E-5),this.tolerance=d,this.layers){n&&this.timer.start();for(g=0;g<this.layers.length;++g)if(c=this.layers[g],a=c.getSpatialQueryAccelerator?c.getSpatialQueryAccelerator():void 0)a.forEachAlongRay(this.p0,this.dir,
this.intersectObject);else for(c=c.getObjects(),a=0;a<c.length;++a)this.intersectObject(c[a]);n&&(this.timer.stop(),this.performanceInfo.queryDuration=this.timer.getLast(),this.performanceInfo.numObjectsTested=this.numObjectsTested)}},Object.defineProperty(a.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,
configurable:!0}),Object.defineProperty(a.prototype,"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),a.prototype.getDirection=function(){return this.normalDir||(this.normalDir=b.vec3d.create(),b.vec3d.normalize(this.dir,this.normalDir)),this.normalDir},a.prototype.intersectObject=function(g){var a=
this;this.numObjectsTested++;for(var l,k=g.getId(),h=g.getGeometryRecords(),d=g.objectTransformation,e=0;e<h.length;e++){var f=h[e],m=f.geometry,n=f.materials,p=f.instanceParameters;l=m.getId();b.mat4d.set(d,this.transform);b.mat4d.multiply(this.transform,f.getShaderTransformation());this._transformInverse.invalidate();this._transformInverseTranspose.invalidate();this._transformTranspose.invalidate();this._transformInverseRotation.invalidate();b.mat4d.multiplyVec3(this.transformInverse,this.p0,r);
b.mat4d.multiplyVec3(this.transformInverse,this.p1,t);n[0].intersect(m,p,this.transform,this,r,t,function(b,c,f,d,e,h){0<=b&&(e?(e=new q,e.init(a.p0,a.p1),e.set(g,k,b,c,d,h,l,f),a.hudResults.push(e)):((null==a.minResult.priority||d>=a.minResult.priority)&&(null==a.minResult.dist||b<a.minResult.dist)&&a.minResult.set(g,k,b,c,d,null,l,f),(null==a.maxResult.priority||d>=a.maxResult.priority)&&(null==a.maxResult.dist||b>a.maxResult.dist)&&a.maxResult.set(g,k,b,c,d,null,l,f)))},f.customTransformation)}},
a.prototype.getMinResult=function(){return this.minResult},a.prototype.getMaxResult=function(){return this.maxResult},a.prototype.getHudResults=function(){return this.hudResults},a.DEFAULT_TOLERANCE=1E-5,a}();var q=function(){function a(a,c){this.normal=b.vec3d.create();this.init(a,c)}return a.prototype.getIntersectionPoint=function(a){return null==this.dist?!1:(b.vec3d.lerp(this.p0,this.p1,this.dist,a),!0)},a.prototype.set=function(a,c,l,k,h,d,e,f){this.dist=l;b.vec3d.set(k,this.normal);a?this.targetType=
a instanceof w?"StageObject":"StagePoint":this.targetType="None";this.target=a;this.name=c;this.priority=h;this.center=d?b.vec3d.create(d):null;this.geometryId=e;this.triangleNr=f},a.prototype.copyFrom=function(a){this.p0=a.p0;this.p1=a.p1;this.dist=a.dist;this.targetType=a.targetType;this.target=a.target;this.name=a.name;this.priority=a.priority;this.center=a.center?b.vec3d.create(a.center):null;this.geometryId=a.geometryId;this.triangleNr=a.triangleNr;this.intersector=a.intersector;b.vec3d.set(a.normal,
this.normal)},a.prototype.setIntersector=function(a){this.intersector=a},a.prototype.init=function(a,b){this.dist=void 0;this.targetType="None";this.priority=this.name=this.target=void 0;this.triangleNr=this.geometryId=this.center=null;this.intersector="stage";this.p0=a;this.p1=b},a}(),m=function(){function a(a,b,l){this.original=a;this.update=b;this.dirty=!0;this.transform=l()}return a.prototype.invalidate=function(){this.dirty=!0},Object.defineProperty(a.prototype,"value",{get:function(){return this.dirty&&
(this.update(this.original.value,this.transform),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),a}();return p});