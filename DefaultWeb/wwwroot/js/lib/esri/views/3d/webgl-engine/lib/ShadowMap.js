//>>built
define("./Camera ./Util ./gl-matrix ../../../../core/Logger ../../../webgl/Texture ../../../webgl/FramebufferObject ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ../../../webgl/Util".split(" "),function(wa,m,t,P,ga,xa,ya,za,Aa,Ba,ha){var b=t.vec2d,G=t.vec3d,ba=t.vec4d,Ca=t.mat3d,D=t.mat4d,ia=t.mat4,Da=P.getLogger("esri.views.3d.webgl-engine.lib.ShadowMap");return function(t,k){function u(a,b){return G.set3(a[b],a[b+3],a[b+
6],ja),ja}var q,V,z=k.gl,K=4096,ca=new ga(k,{target:z.TEXTURE_2D,pixelFormat:z.RGBA,dataType:z.UNSIGNED_BYTE,samplingMode:z.NEAREST,width:4,height:4}),H=1,da=2,L=[0,0,0,0,0];this.dispose=function(){ca.dispose();ca=null};var d,f,v,P=function(){this.camera=new wa;this.lightMat=D.create()},Y=[];for(d=0;4>d;++d)Y[d]=new P;this.getIsSupported=function(){return k.extensions.standardDerivatives};this.setTextureResolution=function(a){K=a};this.getTextureResolution=function(){return K};this.setMaxNumCascades=
function(a){da=m.clamp(Math.floor(a),1,4)};this.getMaxNumCascades=function(){return da};this.setEnableState=function(a){a?this.enable():this.disable()};this.getEnableState=function(){return void 0!==q};this.getDepthTexture=function(){return q};this.enable=function(){if(!this.getEnableState()){if(!this.getIsSupported())return void Da.warn("Shadow maps are not supported for this browser or hardware");q=new ga(k,{target:z.TEXTURE_2D,pixelFormat:z.RGBA,dataType:z.UNSIGNED_BYTE,wrapMode:z.CLAMP_TO_EDGE,
samplingMode:z.NEAREST,flipped:!0,width:K,height:K});V=xa.createWithAttachments(k,q,{colorTarget:0,depthStencilTarget:1,width:K,height:K})}};this.disable=function(){this.getEnableState()&&V&&(V.dispose(),V=void 0,q=void 0)};var ka=D.create(),la=D.create(),ma=ba.create(),w=Array(8);for(d=0;8>d;++d)w[d]=ba.create();var I=G.create(),J=G.create(),na=b.create(),oa=b.create(),Ea=b.create(),pa=b.create(),qa=b.create(),ra=D.create(),sa=G.create();this.prepare=function(y,d,R,r){m.assert(this.getEnableState());
D.multiply(y.projectionMatrix,y.viewMatrix,ka);var c=r[0],n=r[1];2>c&&(c=2);2>n&&(n=2);c>=n&&(c=2,n=4);H=Math.min(1+Math.floor(m.logWithBase(n/c,4)),da);R=Math.pow(n/c,1/H);for(r=0;H+1>r;++r)L[r]=c*Math.pow(R,r);D.inverse(ka,la);D.lookAt([0,0,0],[-d[0],-d[1],-d[2]],[0,1,0],ra);R=y.viewMatrix;y=y.projectionMatrix;for(r=0;H>r;++r){var x=Y[r],c=-L[r],n=-L[r+1],c=(y[10]*c+y[14])/Math.abs(y[11]*c+y[15]),n=(y[10]*n+y[14])/Math.abs(y[11]*n+y[15]);m.assert(n>c);for(f=0;8>f;++f)for(ba.set4(0===f%4||3==f%4?
-1:1,0===f%4||1==f%4?-1:1,4>f?c:n,1,ma),D.multiplyVec4(la,ma,w[f]),v=0;3>v;++v)w[f][v]/=w[f][3];G.negate(w[0],sa);D.translate(ra,sa,x.camera.viewMatrix);for(f=0;8>f;++f)D.multiplyVec3(x.camera.viewMatrix,w[f]);G.set(w[0],I);G.set(w[0],J);for(f=1;8>f;++f)for(v=0;3>v;++v)I[v]=Math.min(I[v],w[f][v]),J[v]=Math.max(J[v],w[f][v]);I[2]-=200;J[2]+=200;x.camera.near=-J[2];x.camera.far=-I[2];c=1/w[0][3];n=1/w[4][3];m.assert(n>c);var h=c+Math.sqrt(c*n),l=Math.sin(Math.acos(R[2]*d[0]+R[6]*d[1]+R[10]*d[2])),h=
h/l,c=w,t=h,q=l,l=na,A=oa,g=Ea,E=pa,h=qa;b.set2(0,0,C);for(var e=void 0,e=0;4>e;++e)b.add(C,c[e],C);b.scale(C,.25);b.set2(0,0,W);for(e=4;8>e;++e)b.add(W,c[e],W);b.scale(W,.25);b.lerp(c[4],c[5],.5,Q[0]);b.lerp(c[5],c[6],.5,Q[1]);b.lerp(c[6],c[7],.5,Q[2]);b.lerp(c[7],c[4],.5,Q[3]);for(var M=0,F=b.dist2(Q[0],C),e=1;4>e;++e){var S=b.dist2(Q[e],C);F>S&&(F=S,M=e)}b.subtract(Q[M],c[M+4],p);e=p[0];p[0]=-p[1];p[1]=e;b.subtract(W,C,ta);b.lerp(p,ta,q);b.normalize(p);M=q=void 0;q=M=b.dot(b.subtract(c[0],C,N),
p);for(e=1;8>e;++e)F=b.dot(b.subtract(c[e],C,N),p),q>F?q=F:F>M&&(M=F);b.set(C,l);b.scale(p,q-t,N);b.add(l,N,l);for(var S=-1,P=1,e=t=F=0;8>e;++e){b.subtract(c[e],l,Z);b.normalize(Z);var X=p[0]*Z[1]-p[1]*Z[0];0<X?X>S&&(S=X,F=e):P>X&&(P=X,t=e)}m.verify(0<S,"leftArea");m.verify(0>P,"rightArea");b.scale(p,q,T);b.add(T,C,T);b.scale(p,M,U);b.add(U,C,U);aa[0]=-p[1];aa[1]=p[0];A=m.rayRay2D(l,c[t],U,b.add(U,aa,N),1,A);g=m.rayRay2D(l,c[F],U,N,1,g);E=m.rayRay2D(l,c[F],T,b.add(T,aa,N),1,E);c=m.rayRay2D(l,c[t],
T,N,1,h);m.verify(A,"rayRay");m.verify(g,"rayRay");m.verify(E,"rayRay");m.verify(c,"rayRay");g=na;c=oa;l=pa;E=qa;h=x.camera.projectionMatrix;b.scale(b.subtract(l,E,B),.5);a[0]=B[0];a[1]=B[1];a[2]=0;a[3]=B[1];a[4]=-B[0];a[5]=0;a[6]=B[0]*B[0]+B[1]*B[1];a[7]=B[0]*B[1]-B[1]*B[0];a[8]=1;a[6]=-b.dot(u(a,0),g);a[7]=-b.dot(u(a,1),g);g=b.dot(u(a,0),l)+a[6];A=b.dot(u(a,1),l)+a[7];e=b.dot(u(a,0),E)+a[6];E=b.dot(u(a,1),E)+a[7];g=-(g+e)/(A+E);a[0]+=a[1]*g;a[3]+=a[4]*g;a[6]+=a[7]*g;g=1/(b.dot(u(a,0),l)+a[6]);A=
1/(b.dot(u(a,1),l)+a[7]);a[0]*=g;a[3]*=g;a[6]*=g;a[1]*=A;a[4]*=A;a[7]*=A;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;g=b.dot(u(a,1),c)+a[7];A=b.dot(u(a,2),c)+a[8];e=b.dot(u(a,1),l)+a[7];E=b.dot(u(a,2),l)+a[8];g=-.5*(g/A+e/E);a[1]+=a[2]*g;a[4]+=a[5]*g;a[7]+=a[8]*g;g=b.dot(u(a,1),c)+a[7];A=b.dot(u(a,2),c)+a[8];e=-A/g;a[1]*=e;a[4]*=e;a[7]*=e;h[0]=a[0];h[1]=a[1];h[2]=0;h[3]=a[2];h[4]=a[3];h[5]=a[4];h[6]=0;h[7]=a[5];h[8]=0;h[9]=0;h[10]=1;h[11]=0;h[12]=a[6];h[13]=a[7];h[14]=0;h[15]=a[8];x.camera.projectionMatrix[10]=
2/(I[2]-J[2]);x.camera.projectionMatrix[14]=-(I[2]+J[2])/(I[2]-J[2]);D.multiply(x.camera.projectionMatrix,x.camera.viewMatrix,x.lightMat);c=K/2;x.camera.viewport[0]=0===r%2?0:c;x.camera.viewport[1]=0===Math.floor(r/2)?0:c;x.camera.viewport[2]=c;x.camera.viewport[3]=c}O=void 0;L[H]=100*n;k.bindFramebuffer(V);k.bindTexture(null,7);k.setClearColor(1,1,1,1);k.clear(z.COLOR_BUFFER_BIT|z.DEPTH_BUFFER_BIT);k.setBlendingEnabled(!1)};var ea=[];this.getCascades=function(){for(var a=0;H>a;++a)ea[a]=Y[a];return ea.length=
H,ea};this.finish=function(a){m.assert(this.getEnableState());k.bindFramebuffer(a)};this.bind=function(a){var b=this.getEnableState();k.bindTexture(b?q:ca,7);k.bindProgram(a);a.setUniform1i("depthTex",7);a.setUniform1f("depthHalfPixelSz",b?.5/K:-1);a.setUniform1i("shadowMapNum",H);a.setUniform4f("shadowMapDistance",L[0],L[1],L[2],L[3])};this.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var b=0;b<a.length;b++)this.bind(a[b])};var O,ua=ia.create(),va=new Float32Array(64);
this.bindView=function(a,b){if(this.getEnableState()){if(!O||O[0]!==b[0]||O[1]!==b[1]||O[2]!==b[2]){var d;O=O||G.create();G.set(b,O);for(f=0;H>f;++f)for(ia.translate(Y[f].lightMat,b,ua),d=0;16>d;++d)va[16*f+d]=ua[d]}a.setUniformMatrix4fv("shadowMapMatrix",va)}};d=new Float32Array(16);d[0]=0;d[1]=0;d[2]=0;d[3]=0;d[4]=256;d[5]=0;d[6]=1;d[7]=0;d[8]=0;d[9]=256;d[10]=0;d[11]=1;d[12]=256;d[13]=256;d[14]=1;d[15]=1;var fa=new ya(k,Aa.Default3D,{geometry:Ba.Pos2Tex},{geometry:za.createVertex(k,z.STATIC_DRAW,
d)});this.drawDebugQuad=function(a){m.assert(this.getEnableState());var b=t.get("showDepth");k.setDepthTestEnabled(!1);k.bindProgram(b);b.setUniformMatrix4fv("proj",a);b.setUniform1i("depthTex",0);k.bindTexture(q,0);k.bindVAO(fa);ha.assertCompatibleVertexAttributeLocations(fa,b);k.drawArrays(z.TRIANGLE_STRIP,0,ha.vertexCount(fa,"geometry"));k.setDepthTestEnabled(!0)};var C=b.create(),W=b.create(),Q=[b.create(),b.create(),b.create(),b.create()],p=b.create(),ta=b.create(),N=b.create(),Z=b.create(),
T=b.create(),U=b.create(),aa=b.create(),ja=G.create(),B=b.create(),a=Ca.create()}});