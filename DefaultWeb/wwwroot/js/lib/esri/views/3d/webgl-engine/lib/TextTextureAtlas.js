//>>built
define("require exports ./Texture ./TextTexture ./ModelContentType ../../../webgl/Texture ../../../webgl/enums".split(" "),function(t,u,p,q,m,r,v){var b=q.preferredAtlasSize(),n=function(){function a(a){this.textTextures={};this.dirty=!1;this._glTexture=null;this.id=p.idGen.gen(a)}return a.prototype.getId=function(){return this.id},a.prototype.dispose=function(){},a.prototype.deferredLoading=function(){return!1},a.prototype.getWidth=function(){return b},a.prototype.getHeight=function(){return b},
a.prototype.initializeThroughRender=function(a,b){b.wrapMode=33071;b.samplingMode=9987;b.flipped=!0;b.preMultiplyAlpha=!0;b.hasMipmap=!0;var e=this._drawToCanvas();return this._glTexture=new r(a,b,e),this.dirty=!1,this._glTexture},a.prototype.redraw=function(){if(this.dirty&&this._glTexture){var a=this._drawToCanvas();this._glTexture.setData(a);this.dirty=!1}},a.prototype.setUnloadFunc=function(a){this._unloadFunc=a},a.prototype.unload=function(){null!=this._unloadFunc&&(this._unloadFunc(this.id),
this._unloadFunc=null)},a.prototype._drawToCanvas=function(){var e=a._create2Dcanvas(),k=e.getContext("2d");k.clearRect(0,0,b,b);for(var f in this.textTextures){var c=this.textTextures[f];c.textTexture.renderText(c.placement.width,c.placement.height,k,c.placement.atlasOffX,c.placement.atlasOffY)}return e},a._create2Dcanvas=function(){return a._textCanvas2D||(a._textCanvas2D=document.createElement("canvas"),a._textCanvas2D.setAttribute("id","canvas2d"),a._textCanvas2D.setAttribute("width",b.toString()),
a._textCanvas2D.setAttribute("height",b.toString()),a._textCanvas2D.setAttribute("style","display:none")),a._textCanvas2D},a}();return function(){function a(a,b){this._textureAtlasSubtextures=[];this._curLineHeight=this._curY=this._curX=0;this._idHint=a;this._stage=b}return a.prototype.dispose=function(){for(var a=0;a<this._textureAtlasSubtextures.length;a++)this._stage.remove(m.TEXTURE,this._textureAtlasSubtextures[a].getId());this._textureAtlasSubtextures=[]},a.prototype.canHoldTextTexture=function(a){return a.getRenderedWidth()<=
b&&a.getRenderedHeight()<=b},a.prototype.addTextTexture=function(a){for(var k=JSON.stringify(a.getParams())+"_"+a.getText(),f=0;f<this._textureAtlasSubtextures.length;f++){var c=this._textureAtlasSubtextures[f].textTextures[k];if(null!=c)return c.placement}var d=null;0===this._textureAtlasSubtextures.length&&(d=new n(this._idHint),this._textureAtlasSubtextures.push(d));var g,h,f=a.getRenderedWidth(),c=a.getRenderedHeight(),e=f+2,l=c+2+2;this._curLineHeight=Math.max(this._curLineHeight,l);this._curX+
e<b&&this._curY+this._curLineHeight<b?(g=this._curX,h=this._curY,this._curX+=e):this._curY+this._curLineHeight+l<b?(this._curX=0,this._curY+=this._curLineHeight,g=this._curX,h=this._curY,this._curX+=e):(d=new n(this._idHint),this._textureAtlasSubtextures.push(d),this._curX=0,this._curY=0,this._curLineHeight=l,g=this._curX,h=this._curY,this._curX+=e);null!=d&&this._stage.add(m.TEXTURE,d);d=this._textureAtlasSubtextures[this._textureAtlasSubtextures.length-1];g={uvMinMax:[g/b,1-(h+c)/b,(g+f)/b,1-h/
b],atlasOffX:g,atlasOffY:h,width:f,height:c,texture:d};return d.textTextures[k]={placement:g,textTexture:a},d.dirty=!0,g},a}()});