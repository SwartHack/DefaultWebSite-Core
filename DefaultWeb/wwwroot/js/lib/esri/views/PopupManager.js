//>>built
define("require ../core/promiseUtils dojo/_base/array dojo/on dojo/Deferred dojo/promise/all ../layers/support/layerUtils ../geometry/support/scaleUtils ../geometry/Extent ../tasks/support/Query ../layers/GroupLayer ../core/Accessor".split(" "),function(H,x,l,D,z,I,E,F,J,K,G,L){var A;return L.createSubclass({declaredClass:"esri.views.PopupManager",properties:{map:{dependsOn:["view.map"],readOnly:!0}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache={};
this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(b){this._clickHandle&&(b?this._clickHandle.resume():this._clickHandle.pause());this._set("enabled",b)},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(b){this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null);b&&(this._clickHandle=D.pausable(b,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause());this._set("view",b)},getMapLayer:function(b){var c;
if(b&&(c=b.findLayerById())&&(b=c.id,this._featureLayersCache[b])){var a=b.lastIndexOf("_");-1<a&&(b=b.substring(0,a),c=this.map.findLayerById(b))}return c},_closePopup:function(){var b=this.get("view.popup");b&&(b.clear(),b.close())},_showPopup:function(b,c,a){function k(u){return e.allLayerViews.find(function(a){return a.layer===u})}function w(a){if(null==a)return!1;var b=k(a);return null==b?!1:a.loaded&&!b.suspended&&(a.popupEnabled&&a.popupTemplate||"graphics"===a.type||"geo-rss"===a.type||"map-notes"===
a.type||"kml"===a.type||b.getPopupData)}function r(a){return(a=k(a))&&a.hasDraped}var e=this.view;b=e.popup;var t=this,n=[],d="3d"===e.type;l.forEach(this.map.layers.toArray(),function(a){a.isInstanceOf(G)?l.forEach(a.layers.toArray(),function(a){!w(a)||d&&!r(a)||n.push(a)}):!w(a)||d&&!r(a)||n.push(a)});0<e.graphics.length&&n.push(e.graphics);if((a&&e.graphics.includes(a)?!a.popupTemplate:a&&!w(a.layer))&&(a=null),!n.length&&!a)return void t._closePopup();var h=[],q=!!a,m=t._calculateClickTolerance(n);
if(!c)return void t._closePopup();var y=1;"2d"===e.type&&(y=e.state.resolution);var g=e.basemapTerrain;g&&g.overlayManager&&(y=g.overlayManager.overlayPixelSizeInMapUnits(c));m*=y;g&&!g.spatialReference.equals(e.spatialReference)&&(m*=F.getMetersPerUnitForSR(g.spatialReference)/F.getMetersPerUnitForSR(e.spatialReference));var g=c.clone().offset(-m,-m),m=c.clone().offset(m,m),v=new J(Math.min(g.x,m.x),Math.min(g.y,m.y),Math.max(g.x,m.x),Math.max(g.y,m.y),e.spatialReference),g=function(b){var d;if("imagery"===
b.type){d=new K;d.geometry=c;var f=k(b),h={rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0};h.layerView=f;d=b.queryVisibleRasters(d,h).then(function(a){return q=q||0<a.length,a})}else if("csv"===b.type||"scene"===b.type||!t._featureLayersCache[b.id]&&"function"!=typeof b.queryFeatures){if("map-image"===b.type||"wms"===b.type)return f=k(b),f.getPopupData(v);var e,g=[];"esri.core.Collection\x3cesri.Graphic\x3e"===b.declaredClass?(h=b,e=!0):"graphics"===b.type?(h=b.graphics,e=!0):(f=
k(b),h=f&&f.loadedGraphics,e=!1);h&&(g=h.filter(function(a){return a&&(!e||a.popupTemplate)&&a.visible&&v.intersects(a.geometry)}).toArray());0<g.length&&(q=!0,d="scene"===b.type?t._fetchSceneAttributes(b,g):x.resolve(g))}else f=b.createQuery(),f.geometry=v,d=b.queryFeatures(f).then(function(d){d=d.features;if(a&&a.layer===b&&b.objectIdField){var c=b.objectIdField,h=a.attributes[c];d=d.filter(function(a){return a.attributes[c]!==h})}if(!a&&"function"==typeof k(b).getGraphics3DGraphics){var f=[],e=
k(b).getGraphics3DGraphics(),g;for(g in e)f.push(e[g].graphic.attributes[b.objectIdField]);d=d.filter(function(a){return-1!==f.indexOf(a.attributes[b.objectIdField])})}return q=q||0<d.length,d});return d};if(d&&!a||!d)var h=n.map(g).filter(function(a){return!!a}),p=function(a){return a.reduce(function(a,b){return a.concat(b.items?p(b.items):b)},[])},h=p(h);a&&(a.layer&&"scene"===a.layer.type?h.unshift(this._fetchSceneAttributes(a.layer,[a])):a.popupTemplate&&(g=new z,h.unshift(g.resolve([a]))));return l.some(h,
function(a){return!a.isFulfilled()})||q?void(h.length&&b.open({promises:h,location:c})):void t._closePopup()},_fetchSceneAttributes:function(b,c){return this.view.whenLayerView(b).then(function(a){var k=this._getOutFields(b.popupTemplate),w=c.map(function(b){return a.whenGraphicAttributes(b,k).otherwise(function(){return b})});return x.eachAlways(w)}.bind(this)).then(function(a){return a.map(function(a){return a.value})})},_getSubLayerFeatureLayers:function(b,c){var a=c||new z,k=[];c=b.length;var w=
Math.floor(this.view.extent.width/this.view.width),r=this.view.scale,e=!1,t=this,n=0;a:for(;c>n;n++){var d=b[n],h=d.dynamicLayerInfos||d.layerInfos;if(h){var q=null;d._params&&(d._params.layers||d._params.dynamicLayers)&&(q=d.visibleLayers);for(var q=E._getVisibleLayers(h,q),m=E._getLayersForScale(r,h),y=h.length,g=0;y>g;g++){var v=h[g],p=v.id,u=d.popupTemplates[p];if(!v.subLayerIds&&u&&u.popupTemplate&&-1<l.indexOf(q,p)&&-1<l.indexOf(m,p)){if(!A){e=!0;break a}var B=d.id+"_"+p,f=this._featureLayersCache[B];
f&&f.loadError||(f||((f=u.layerUrl)||(f=v.source?this._getLayerUrl(d.url,"/dynamicLayer"):this._getLayerUrl(d.url,p)),f=new A(f,{id:B,drawMode:!1,mode:A.MODE_SELECTION,outFields:this._getOutFields(u.popupTemplate),resourceInfo:u.resourceInfo,source:v.source}),this._featureLayersCache[B]=f),f.setDefinitionExpression(d.layerDefinitions&&d.layerDefinitions[p]),f.setGDBVersion(d.gdbVersion),f.popupTemplate=u.popupTemplate,f.setMaxAllowableOffset(w),f.setUseMapTime(!!d.useMapTime),d.layerDrawingOptions&&
d.layerDrawingOptions[p]&&d.layerDrawingOptions[p].renderer&&f.setRenderer(d.layerDrawingOptions[p].renderer),k.push(f))}}}}if(e){var x=new z;H(["../layers/FeatureLayer"],function(a){A=a;x.resolve()});x.then(function(){t._getSubLayerFeatureLayers(b,a)})}else{var C=[];l.forEach(k,function(a){if(!a.loaded){var b=new z;D.once(a,"load, error",function(){b.resolve()});C.push(b.promise)}});C.length?I(C).then(function(){k=l.filter(k,function(a){return!a.loadError&&a.isVisibleAtScale(r)});a.resolve(k)}):
(k=l.filter(k,function(a){return a.isVisibleAtScale(r)}),a.resolve(k))}return a.promise},_getLayerUrl:function(b,c){var a=b.indexOf("?");return-1===a?b+"/"+c:b.substring(0,a)+"/"+c+b.substring(a)},_getOutFields:function(b){var c=["*"];if("esri.PopupTemplate"===b.declaredClass){var a=null==b.content||Array.isArray(b.content)&&b.content.every(function(a){return"attachments"===a.type||"fields"===a.type&&null==a.fieldInfos||"text"===a.type&&-1===a.text.indexOf("{")});b.fieldInfos&&!b.expressionInfos&&
a&&(c=[],l.forEach(b.fieldInfos,function(a){var b=a.fieldName&&a.fieldName.toLowerCase();b&&"shape"!==b&&0!==b.indexOf("relationships/")&&c.push(a.fieldName)}))}return c},_calculateClickTolerance:function(b){var c=6;return l.forEach(b,function(a){if(a=a.renderer)"simple"===a.type?((a=a.symbol)&&a.xoffset&&(c=Math.max(c,Math.abs(a.xoffset))),a&&a.yoffset&&(c=Math.max(c,Math.abs(a.yoffset)))):"unique-value"!==a.type&&"class-breaks"!==a.type||l.forEach(a.uniqueValueInfos||a.classBreakInfos,function(a){(a=
a.symbol)&&a.xoffset&&(c=Math.max(c,Math.abs(a.xoffset)));a&&a.yoffset&&(c=Math.max(c,Math.abs(a.yoffset)))})}),c},_clickHandler:function(b){function c(b){return a.allLayerViews.find(function(a){return a.layer===b})}var a=this.view,k=a.popup,l=a.map,r=b.screenPoint,e=this;if(0===b.button&&k&&a.ready){var t="3d"===a.type,n=l.allLayers.some(function(a){if(a.isInstanceOf(G))a=!1;else{var b;null==a?b=!1:(b=c(a),b=null==b?!1:a.loaded&&!b.suspended&&(a.popupEnabled&&a.popupTemplate||"graphics"===a.type||
b.getPopupData));!(b=!b)&&(b=t)&&(a=c(a),b=!(a&&a.hasDraped));a=b?!1:!0}return a});return null!=r?void this.view.hitTest(r.x,r.y).then(function(a){n||0<a.results.length?0<a.results.length?(a=a.results[0],e._showPopup(b,a.mapPoint,a.graphic)):e._showPopup(b,b.mapPoint,null):e._closePopup()}):void e._showPopup(b,b.mapPoint)}}})});