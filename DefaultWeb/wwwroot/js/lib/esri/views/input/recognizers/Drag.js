//>>built
define(["require","exports","../../../core/tsSupport/extendsHelper","../InputHandler","./support"],function(k,l,m,n,p){Object.defineProperty(l,"__esModule",{value:!0});k=function(k){function b(){var a=k.call(this,!1)||this;return a._startStateModifiers=new Set,a._activePointers=[],a._activePointerMap=new Map,a._isDragging=!1,a._drag=a.registerOutgoing("drag"),a.registerIncoming("pointer-drag",a._handlePointerDrag.bind(a)),a.registerIncoming("pointer-down",a._handlePointerDown.bind(a)),a.registerIncoming("pointer-up",
a._handlePointerUpAndPointerLost.bind(a)),a.registerIncoming("pointer-capture-lost",a._handlePointerUpAndPointerLost.bind(a)),a}return m(b,k),b.prototype._createPayload=function(a,d){return{action:a,pointers:this._activePointers.map(function(a){return a.data}),startState:this._startState,previousState:this._previousState,currentState:d}},b.prototype._fitCircleLSQ=function(){var a=this._activePointers.map(function(a){return a.data.currentEvent});return p.fitCircleLSQ(a)},b.prototype._createDragState=
function(a){for(var d=this._fitCircleLSQ(),h=0,c=0,b=this._activePointers;c<b.length;c++){for(var g=b[c],e=this._pointerAngle(g,d),e=e-g.lastAngle;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;e=g.lastAngle+e;g.lastAngle=e;h+=e-g.initialAngle}return h/=this._activePointers.length,{angle:h,radius:d.radius,center:d.center,timestamp:a}},b.prototype._updateMultiPointer=function(a,d){var h=a.startEvent["native"].pointerId,c=this._activePointerMap.get(h),b=!c;b?(c={data:null,initialAngle:0,lastAngle:0},
this._activePointers.push(c),this._activePointerMap.set(h,c),c.data={startEvent:a.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent},a=this._fitCircleLSQ(),c.initialAngle=this._pointerAngle(c,a),c.lastAngle=c.initialAngle):c.data={startEvent:c.data.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent};return b&&this._isDragging&&this._updateInitialAngles(d),c},b.prototype._pointerAngle=function(a,d){a=a.data.currentEvent;return Math.atan2(a.y-d.center.y,a.x-d.center.x)},
b.prototype._updateInitialAngles=function(a){a=this._createDragState(a);for(var d=0,b=this._activePointers;d<b.length;d++){var c=b[d];c.initialAngle=this._pointerAngle(c,a)}},b.prototype._emitStart=function(a){this._updateInitialAngles(a.timestamp);var d=this._createDragState(a.timestamp);this._previousState=this._startState=d;this._startStateModifiers=a.modifiers;this._isDragging=!0;for(var b=0,c=this._activePointers;b<c.length;b++){var f=c[b];f.data={previousEvent:f.data.currentEvent,startEvent:f.data.currentEvent,
currentEvent:f.data.currentEvent}}this._drag.emit(this._createPayload("start",d),a.timestamp)},b.prototype._emitUpdate=function(a){a=this._createDragState(a.timestamp);this._drag.emit(this._createPayload("update",a),void 0,this._startStateModifiers);this._previousState=a},b.prototype._emitEnd=function(a){a=this._createDragState(a);this._drag.emit(this._createPayload("end",a),void 0,this._startStateModifiers);this._startState=this._previousState=null;this._isDragging=!1},b.prototype._handlePointerDown=
function(a){var b=a.data;this._isDragging&&this._emitEnd(a.timestamp);this._updateMultiPointer({startEvent:b,previousEvent:b,currentEvent:b},a.timestamp)},b.prototype._removeMultiPointer=function(a,b){var d=this,c=a["native"].pointerId,f=this._activePointerMap.get(c);if(f){var g=function(){d._activePointerMap["delete"](c);var a=d._activePointers.indexOf(f);d._activePointers.splice(a,1);d._isDragging&&d._updateInitialAngles(b)};this._isDragging?(this._updateMultiPointer({startEvent:f.data.startEvent,
previousEvent:f.data.currentEvent,currentEvent:a},b),this._emitEnd(b),g()):g()}},b.prototype._handlePointerUpAndPointerLost=function(a){this._removeMultiPointer(a.data,a.timestamp)},b.prototype._handlePointerDrag=function(a){var b=a.data;switch(b.action){case "start":this._isDragging||this._emitStart(a);break;case "update":this._isDragging||this._emitStart(a),this._updateMultiPointer(b,a.timestamp),this._emitUpdate(a)}},b}(n.InputHandler);l.Drag=k});