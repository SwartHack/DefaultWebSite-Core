//>>built
define(["require","exports","../2d/engine/webgl/Geometry","./GeometryUtils","./Conflict"],function(w,v,r,h,E){Object.defineProperty(v,"__esModule",{value:!0});w=function(){return function(c,a,e,b,f){void 0===e&&(e=0);void 0===b&&(b=-1);void 0===f&&(f=D);this.x=c;this.y=a;this.angle=e;this.segment=b;this.minzoom=f}}();v.Anchor=w;w=function(){return function(c,a,e,b){this.glyph=c;this.x=a;this.y=e;this.glyphItem=b}}();v.ShapedGlyph=w;var Q=function(){return function(c,a,e,b,f,g,l){void 0===f&&(f=!1);
void 0===g&&(g=D);void 0===l&&(l=h.C_INFINITY);this.anchor=c;this.labelAngle=a;this.glyphAngle=e;this.page=b;this.upsideDown=f;this.minzoom=g;this.maxzoom=l}}(),R=function(){return function(c,a,e,b,f,g,l,h,r,y){this.tl=c;this.tr=a;this.bl=e;this.br=b;this.mosaicRect=f;this.labelAngle=g;this.anchor=l;this.minzoom=h;this.maxzoom=r;this.page=y}}();v.PlacedSymbol=R;var S=function(){return function(h,a){this.footprint=h;this.shapes=a}}();v.Placement=S;var D=.5;w=function(){function c(){this.mapAngle=0;
this._conflictEngine=new E.ConflictEngine}return c.prototype.reset=function(){this._conflictEngine.reset()},c.prototype.setAngle=function(a){this.mapAngle=a;this._conflictEngine.setAngle(a)},c.prototype.getIconPlacement=function(a,e,b,f,g,l,c){var I=b.width/(b.sdfRatio*b.pixelRatio),y=b.height/(b.sdfRatio*b.pixelRatio);g=l.offset[0]-I/2;var z=l.offset[1]-y/2,I=g+I,y=z+y,A=b.rect,n=(b.sdf?17:2)/b.sdfRatio,k=g-n,d=z-n,m=k+A.width/(b.pixelRatio*b.sdfRatio),p=d+A.height/(b.pixelRatio*b.sdfRatio);b=new r.Point(k,
d);n=new r.Point(m,p);p=new r.Point(k,p);d=new r.Point(m,d);m=l.rotate*h.C_DEG_TO_RAD;k=1===l.rotationAlignment;if(0<=a.segment&&!k&&(m+=a.angle),0!==m){var q=Math.cos(m),t=Math.sin(m);b.rotate(q,t);n.rotate(q,t);p.rotate(q,t);d.rotate(q,t)}q=8*l.padding;t=new r.Point(a.x,a.y);a=new E.Footprint(this.mapAngle,q,k);a.addBox(t,new E.Box(g,z,I,y),f,m,e,D,h.C_INFINITY);e=new R(b,d,p,n,A,0,t,D,h.C_INFINITY,0);e=new S(a,[e]);f=D;return l.allowOverlap||(f=this._conflictEngine.getMinZoom(e.footprint,f,c,k)),
a.minzoom=f,e},c.prototype.getTextPlacement=function(a,e,b,f,g,l,c,I){for(var y,z=new r.Point(a.x,a.y),A=c.rotate*h.C_DEG_TO_RAD,n=0===c.rotationAlignment,k=c.keepUpright,d=D,m=!n,p=m?0:a.angle,q=0<=a.segment&&n,t=new E.Footprint(this.mapAngle,8*c.padding,m),w=[],v=!q,F=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,K=F,L=G,da=q?k:n&&k,T=0;T<f.length;T++){var B=f[T],u=B.glyphItem;if(u&&!u.rect.isEmpty){var U=u.rect,H=u.metrics,C=u.page;v&&(y&&y!==B.y&&(t.addBox(z,new E.Box(F,K,G,L),g,A,e,D,h.C_INFINITY),
F=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,K=F,L=G),y=B.y);var J=[];if(q){if(u=(b.x+B.x+H.left-4+.5*u.metrics.width)*g,d=this._placeGlyph(a,d,u,l,a.segment,1,C,J),k&&(d=this._placeGlyph(a,d,u,l,a.segment,-1,C,J)),2<=d)break}else J.push(new Q(z,p,p,C)),n&&k&&J.push(new Q(z,p+h.C_PI,p+h.C_PI,C,!0));for(var C=B.x+b.x+H.left,B=B.y+b.y-H.top,u=C+H.width,H=B+H.height,M=new r.Point(C-4,B-4),V=new r.Point(M.x+U.width,M.y+U.height),ea=new r.Point(M.x,V.y),fa=new r.Point(V.x,M.y),W=0;W<J.length;W++){var x=
J[W],Z=M.clone(),aa=ea.clone(),ba=fa.clone(),ca=V.clone(),X=B,Y=H,N=x.glyphAngle+A;if(0!==N){var O=Math.cos(N),P=Math.sin(N);Z.rotate(O,P);ca.rotate(O,P);aa.rotate(O,P);ba.rotate(O,P)}w.push(new R(Z,ba,aa,ca,U,x.labelAngle,x.anchor,x.minzoom,x.maxzoom,x.page));(!da||this._legible(x.labelAngle))&&(v?(F>C&&(F=C),K>X&&(K=X),u>G&&(G=u),Y>L&&(L=Y)):2>x.minzoom&&t.addBox(x.anchor,new E.Box(C,X,u,Y),g,N,e,x.minzoom,x.maxzoom))}}}if(2<=d)return null;v&&t.addBox(z,new E.Box(F,K,G,L),g,A,e,D,h.C_INFINITY);
a=new S(t,w);return c.allowOverlap||(d=this._conflictEngine.getMinZoom(a.footprint,d,I,m)),t.minzoom=d,a},c.prototype.add=function(a){this._conflictEngine.add(a.footprint)},c.prototype._legible=function(a){a=h.radToByte(a);return 65>a||193<=a},c.prototype._placeGlyph=function(a,c,b,f,g,l,v,w){var e=0>l?h.positiveMod(a.angle+h.C_PI,h.C_2PI):a.angle,z=this._legible(e),A=0;0>b&&(l*=-1,b*=-1,A=h.C_PI);0<l&&++g;a=new r.Point(a.x,a.y);var n=f[g],k=h.C_INFINITY;if(f.length<=g)return k;for(;;){var d=n.x-
a.x,m=n.y-a.y,p=Math.sqrt(d*d+m*m),q=Math.max(b/p,c),d=h.positiveMod(Math.atan2(m/p,d/p)+A,h.C_2PI);if(w.push(new Q(a,e,d,v,z,q,k)),c>=q)return q;a=n.clone();do{if(g+=l,f.length<=g||0>g)return q;n=f[g]}while(a.isEqual(n));k=n.x-a.x;d=n.y-a.y;m=Math.sqrt(k*k+d*d);k*=p/m;d*=p/m;a.x-=k;a.y-=d;k=q}},c}();v.PlacementEngine=w});