//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ../2d/engine/webgl/Geometry ./style/StyleLayer ./Placement ./GeometryUtils ./TextShaping dojox/string/BidiEngine".split(" "),function(N,O,I,P,J,A,F,G,t,K,L){function M(t,h){return t.iconMosaicItem&&h.iconMosaicItem?t.iconMosaicItem.page===h.iconMosaicItem.page?0:t.iconMosaicItem.page<h.iconMosaicItem.page?-1:1:t.iconMosaicItem&&!h.iconMosaicItem?1:!t.iconMosaicItem&&h.iconMosaicItem?-1:0}return function(){return function(){}}(),
function(H){function h(a,c,g,d,e,b,f,v){c=H.call(this,a,c)||this;if(c._markerMap=new Map,c._glyphMap=new Map,c._glyphBufferDataStorage=new Map,c._sdfMarkers=!1,a.hasDataDrivenIcon!==g.isDataDriven())throw Error("incompatible icon buffer");if(a.hasDataDrivenText!==e.isDataDriven())throw Error("incompatible text buffer");return c._iconVertexBuffer=g,c._iconIndexBuffer=d,c._textVertexBuffer=e,c._textIndexBuffer=b,c._placementEngine=f,c._workerTileHandler=v,c}return I(h,H),Object.defineProperty(h.prototype,
"markerPageMap",{get:function(){return this._markerMap},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"sdfMarker",{get:function(){return this._sdfMarkers},enumerable:!0,configurable:!0}),h.prototype.copy=function(a,c,g,d,e){a=new h(this.layer,this.zoom,a,c,g,d,e,this._workerTileHandler);return a.layerIndex=this.layerIndex,a.layerExtent=this.layerExtent,a._iconIndexStart=
c.index,a._textIndexStart=d.index,a._iconIndexCount=0,a._textIndexCount=0,a._symbolInstances=this._symbolInstances,a._workerTileHandler=this._workerTileHandler,a._fontArray=this._fontArray,a._textLayout=this._textLayout,a._iconLayout=this._iconLayout,a._isLinePlacement=this._isLinePlacement,a._avoidEdges=this._avoidEdges,a},h.prototype.getResources=function(a,c,g){var d=this.layer,e=this.zoom,b=d.hasDataDrivenIcon,f=d.hasDataDrivenText;a&&a.setExtent(this.layerExtent);for(var v=d.getLayoutProperty("icon-image"),
m=d.getLayoutProperty("text-field"),E=d.getLayoutValue("text-font",e),q=d.getLayoutValue("text-transform",e),x=[],k=0,u=this._features;k<u.length;k++){var l=u[k],p=l.getGeometry(a);if(p&&0!==p.length){var w=void 0;v&&(w=d.getLayoutValue("icon-image",e,l),v.isDataDriven||(w=this._replaceKeys(w,l.values)),w&&c.add(w));var n=void 0,r=!1;if(m&&(n=d.getLayoutValue("text-field",e,l),m.isDataDriven||(n=this._replaceKeys(n,l.values)),n)){switch(q){case 2:n=n.toLowerCase();break;case 1:n=n.toUpperCase()}h._bidiEngine.hasBidiChar(n)&&
(r=void 0,r="rtl"===h._bidiEngine.checkContextual(n)?"IDNNN":"ICNNN",n=h._bidiEngine.bidiTransform(n,r,"VLYSN"),r=!0);var y=n.length;if(0<y)for(var z=0,t=E;z<t.length;z++){var C=t[z],A=g[C];A||(A=g[C]=new Set);for(C=0;y>C;C++){var D=n.charCodeAt(C);A.add(D)}}}if(w||n)y=d.getLayoutValue("icon-size",e,l),z=d.getLayoutValue("text-size",e,l),l={sprite:w,label:n,rtl:r,geometry:p,iconSize:y,iconRotate:d.getLayoutValue("icon-rotate",e,l),ddIconValues:b?{color:d.getPaintValue("icon-color",e,l),opacity:d.getPaintValue("icon-opacity",
e,l),size:y}:null,textSize:z,textRotate:d.getLayoutValue("text-rotate",e,l),ddTextValues:f?{color:d.getPaintValue("text-color",e,l),opacity:d.getPaintValue("text-opacity",e,l),size:z}:null},x.push(l)}}this._symbolFeatures=x},h.prototype.processFeatures=function(a,c){a&&a.setExtent(this.layerExtent);var g,d,e=this.layer,b=this.zoom;c=this._isLinePlacement=1===e.getLayoutValue("symbol-placement",b);a=this._avoidEdges=e.getLayoutValue("symbol-avoid-edges",b)&&!c;var f=8*e.getLayoutValue("symbol-spacing",
b),v=e.getLayoutProperty("icon-image"),m=e.getLayoutProperty("text-field"),E=this._workerTileHandler;v&&(this._iconLayout=new F.IconLayout(e,b,c),g=E.getSpriteItems(),d=this._getTranslate(!0));var q,x,k;if(m){q=this._textLayout=new F.TextLayout(e,b,c);this._fontArray=q.fontArray;k=.5;switch(q.anchor){case 5:case 1:case 7:k=0;break;case 6:case 2:case 8:k=1}x=.5;switch(q.anchor){case 5:case 3:case 6:x=0;break;case 7:case 4:case 8:x=1}e=.5;switch(q.justify){case 0:e=0;break;case 2:e=1}var b=24*q.letterSpacing,
v=c?0:24*q.maxWidth,m=24*q.lineHeight,u=[24*q.offset[0],24*q.offset[1]];q=this._fontArray.map(function(a){return E.getGlyphItems(a)});x=new K(q,v,m,b,u,k,x,e);k=this._getTranslate(!1)}this._iconIndexStart=this._iconIndexBuffer.index;this._textIndexStart=this._textIndexBuffer.index;this._textIndexCount=this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();this._symbolInstances=e=[];b=this._textLayout;v=1;b&&b.size&&(v=b.size/24);m=b?b.maxAngle*t.C_DEG_TO_RAD:0;q=b?8*b.size:0;for(var u=
0,l=this._symbolFeatures;u<l.length;u++){var p=l[u],w=void 0;p.sprite&&(w=g[p.sprite],w&&w.sdf&&(this._sdfMarkers=!0));var n=void 0,r=p.label,y=0;if(r&&(n=x.getShaping(r,p.rtl),n&&0<n.length)){for(var y=1E30,r=-1E30,z=0,B=n;z<B.length;z++)var C=B[z],y=Math.min(y,C.x),r=Math.max(r,C.x);y=(r-y+48)*v*8}r=0;for(z=p.geometry;r<z.length;r++){var B=z[r],A=void 0;c?(n&&0<n.length&&b&&b.size&&h._smoothVertices(B,8*b.size*(2+Math.min(2,4*Math.abs(b.offset[1])))),A=h._findAnchors(B,f,y)):A=[new G.Anchor(B[0].x,
B[0].y)];for(C=0;C<A.length;C++){var D=A[C];0>D.x||4096<D.x||0>D.y||4096<D.y||c&&0<y&&0===b.rotationAlignment&&!h._honorsTextMaxAngle(B,D,y,m,q)||e.push({shaping:n,line:B,iconMosaicItem:w,anchor:D,iconSize:p.iconSize,iconRotate:p.iconRotate,ddIconValues:p.ddIconValues,textSize:p.textSize,textRotate:p.textRotate,ddTextValues:p.ddTextValues})}}}e.sort(M);for(g=0;g<e.length;g++)this._processFeature(e[g],d,k,a);this._addPlacedGlyphs()},h.prototype.updateSymbols=function(){this._iconIndexStart=this._iconIndexBuffer.index;
this._textIndexStart=this._textIndexBuffer.index;this._textIndexCount=this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();var a,c=this._avoidEdges,g=this.layer;g.getLayoutProperty("icon-image")&&(a=this._getTranslate(!0));var d;g.getLayoutProperty("text-field")&&(d=this._getTranslate(!1));for(var g=0,e=this._symbolInstances;g<e.length;g++)this._processFeature(e[g],a,d,c);this._addPlacedGlyphs()},h.prototype._getTranslate=function(a){var c=this.layer.getPaintValue(a?"icon-translate":
"text-translate",this.zoom);if(0!==c[0]||0!==c[1]){var g=this._placementEngine.mapAngle;return 0!==g&&0===this.layer.getPaintValue(a?"icon-translate-anchor":"text-translate-anchor",this.zoom)?(a=Math.sin(g),g=Math.cos(g),[8*(c[0]*g-c[1]*a),8*(c[0]*a+c[1]*g)]):[8*c[0],8*c[1]]}},h.prototype._replaceKeys=function(a,c){return a.replace(/{([^{}]+)}/g,function(a,d){return d in c?c[d]:""})},h.prototype._processFeature=function(a,c,g,d){var e=a.line,b=a.iconMosaicItem,f=a.shaping,v=a.anchor,m=this._iconLayout,
h=m&&!!b,q=!0,x=1;h&&(m.size=a.iconSize,m.rotate=a.iconRotate,x=8*m.size,q=m.optional||!b);var k=this._textLayout,u=k&&f&&0<f.length,l=1,p=l,w=!0;u&&(k.size=a.textSize,k.rotate=a.textRotate,l=k.size/24,p=8*l,w=k.optional||!f||0===f.length);var n,l=new A.Point(0,-17);if(h){if(n=this._placementEngine.getIconPlacement(v,c,b,x,e,m,d),n.footprint.minzoom===t.C_INFINITY&&!q)return;v.minzoom>n.footprint.minzoom&&(n.footprint.minzoom=v.minzoom)}var r;if(u&&(r=this._placementEngine.getTextPlacement(v,g,l,
f,p,e,k,d))){if(r.footprint.minzoom===t.C_INFINITY&&!w)return;v.minzoom>r.footprint.minzoom&&(r.footprint.minzoom=v.minzoom)}if(!w&&!q||!q&&r&&r.footprint.minzoom!==t.C_INFINITY||!w&&n&&n.footprint.minzoom!==t.C_INFINITY)c=Math.max(n.footprint.minzoom,r.footprint.minzoom),n.footprint.minzoom=c,r.footprint.minzoom=c;r&&r.footprint.minzoom!==t.C_INFINITY&&(k.ignorePlacement||this._placementEngine.add(r),this._storePlacedGlyphs(r.shapes,r.footprint.minzoom,this.zoom,a.ddTextValues));n&&n.footprint.minzoom!==
t.C_INFINITY&&(m.ignorePlacement||this._placementEngine.add(n),this._addPlacedIcons(n.shapes,n.footprint.minzoom,this.zoom,b.page,a.ddIconValues))},h.prototype._addPlacedIcons=function(a,c,g,d,e){c=Math.max(g+t.log2(c),0);for(var b=this._iconVertexBuffer,f=this._iconIndexBuffer,v=0;v<a.length;v++){var m=a[v],h=Math.max(g+t.log2(m.minzoom),c),q=Math.min(g+t.log2(m.maxzoom),25);if(!(h>=q)){var x=m.tl,k=m.tr,u=m.bl,l=m.br,p=m.mosaicRect,w=m.labelAngle,m=m.anchor,n=b.index,r=p.x,y=p.y,z=r+p.width,p=y+
p.height;b.add(m.x,m.y,x.x,x.y,r,y,w,h,q,c,e);b.add(m.x,m.y,k.x,k.y,z,y,w,h,q,c,e);b.add(m.x,m.y,u.x,u.y,r,p,w,h,q,c,e);b.add(m.x,m.y,l.x,l.y,z,p,w,h,q,c,e);f.add(n+0,n+1,n+2);f.add(n+1,n+2,n+3);this._markerMap.has(d)?this._markerMap.get(d)[1]+=6:this._markerMap.set(d,[this._iconIndexStart+this._iconIndexCount,6]);this._iconIndexCount+=2}}},h.prototype._addPlacedGlyphs=function(){var a=this,c=this._textVertexBuffer,g=this._textIndexBuffer;this._glyphBufferDataStorage.forEach(function(d,e){for(var b=
0;b<d.length;b++){var f=d[b],v=c.index;c.add(f.glyphAnchor[0],f.glyphAnchor[1],f.tl[0],f.tl[1],f.xmin,f.ymin,f.labelAngle,f.minLod,f.maxLod,f.placementLod,f.ddValues);c.add(f.glyphAnchor[0],f.glyphAnchor[1],f.tr[0],f.tr[1],f.xmax,f.ymin,f.labelAngle,f.minLod,f.maxLod,f.placementLod,f.ddValues);c.add(f.glyphAnchor[0],f.glyphAnchor[1],f.bl[0],f.bl[1],f.xmin,f.ymax,f.labelAngle,f.minLod,f.maxLod,f.placementLod,f.ddValues);c.add(f.glyphAnchor[0],f.glyphAnchor[1],f.br[0],f.br[1],f.xmax,f.ymax,f.labelAngle,
f.minLod,f.maxLod,f.placementLod,f.ddValues);g.add(v+0,v+1,v+2);g.add(v+1,v+2,v+3);a._glyphMap.has(e)?a._glyphMap.get(e)[1]+=6:a._glyphMap.set(e,[a._textIndexStart+a._textIndexCount,6]);a._textIndexCount+=2}});this._glyphBufferDataStorage.clear()},h.prototype._storePlacedGlyphs=function(a,c,g,d){c=Math.max(g+t.log2(c),0);for(var e=0;e<a.length;e++){var b=a[e],f=Math.max(g+t.log2(b.minzoom),c),v=Math.min(g+t.log2(b.maxzoom),25);if(!(f>=v)){var m=b.tl,h=b.tr,q=b.bl,x=b.br,k=b.labelAngle,u=b.anchor,
l=b.mosaicRect;this._glyphBufferDataStorage.has(b.page)||this._glyphBufferDataStorage.set(b.page,[]);this._glyphBufferDataStorage.get(b.page).push({glyphAnchor:[u.x,u.y],tl:[m.x,m.y],tr:[h.x,h.y],bl:[q.x,q.y],br:[x.x,x.y],xmin:l.x,ymin:l.y,xmax:l.x+l.width,ymax:l.y+l.height,labelAngle:k,minLod:f,maxLod:v,placementLod:c,ddValues:d})}}},h._findAnchors=function(a,c,g){c+=g;for(var d=0,e=a.length-1,b=0;e>b;b++)d+=A.Point.distance(a[b],a[b+1]);b=g||c;if(b*=.5,b>=d)return[];g=b/d;c=d/Math.max(Math.round(d/
c),1);for(var d=0,e=-c/2,f=[],v=a.length-1,b=0;v>b;b++){for(var m=a[b],h=a[b+1],q=h.x-m.x,x=h.y-m.y,k=Math.sqrt(q*q+x*x),u=void 0;d+k>e+c;){var e=e+c,l=(e-d)/k,p=t.interpolate(m.x,h.x,l),l=t.interpolate(m.y,h.y,l);void 0===u&&(u=Math.atan2(x,q));f.push(new G.Anchor(p,l,u,b,g))}d+=k}return f},h.deviation=function(a,c,g){return Math.atan2((c.x-a.x)*(g.y-c.y)-(c.y-a.y)*(g.x-c.x),(c.x-a.x)*(g.x-c.x)+(c.y-a.y)*(g.y-c.y))},h._honorsTextMaxAngle=function(a,c,g,d,e){var b=0;g/=2;for(var f=new A.Point(c.x,
c.y),h=c.segment+1;b>-g;){if(--h,0>h)return!1;b-=A.Point.distance(a[h],f);f=a[h]}b+=A.Point.distance(a[h],a[h+1]);c=[];for(var f=0,m=a.length;g>b;){var t=a[h],q=void 0;do{if(++h,h===m)return!1;q=a[h]}while(q.isEqual(t));var x=h,k=void 0;do{if(++x,x===m)return!1;k=a[x]}while(k.isEqual(q));t=this.deviation(t,q,k);c.push({deviation:t,distToAnchor:b});for(f+=t;b-c[0].distToAnchor>e;)f-=c.shift().deviation;if(Math.abs(f)>d)return!1;b+=A.Point.distance(q,k)}return!0},h._smoothVertices=function(a,c){if(!(0>=
c)){var g=a.length;if(!(3>g)){var d=[],e=0;d.push(0);for(var b=1;g>b;b++)e+=A.Point.distance(a[b],a[b-1]),d.push(e);c=Math.min(c,.2*e);e=[];e.push(a[0].x);e.push(a[0].y);var f=a[g-1].x,h=a[g-1].y,b=A.Point.sub(a[0],a[1]);b.normalize();a[0].x+=c*b.x;a[0].y+=c*b.y;b.assignSub(a[g-1],a[g-2]);b.normalize();a[g-1].x+=c*b.x;a[g-1].y+=c*b.y;for(b=1;g>b;b++)d[b]+=c;d[g-1]+=c;for(var m=.5*c,b=1;g-1>b;b++){for(var t=0,q=0,x=0,k=b-1;0<=k&&!(d[k+1]<d[b]-m);k--){var u=m+d[k+1]-d[b],l=d[k+1]-d[k],p=d[b]-d[k]<m?
1:u/l;if(1E-6>Math.abs(p))break;var w=p*p,n=p*u-.5*w*l,r=p*l/c,y=a[k+1],z=a[k].x-y.x,B=a[k].y-y.y,t=t+r/n*(y.x*p*u+.5*w*(u*z-l*y.x)-w*p*l*z/3),q=q+r/n*(y.y*p*u+.5*w*(u*B-l*y.y)-w*p*l*B/3),x=x+r}for(k=b+1;g>k&&!(d[k-1]>d[b]+m);k++){u=m-d[k-1]+d[b];l=d[k]-d[k-1];p=d[k]-d[b]<m?1:u/l;if(1E-6>Math.abs(p))break;w=p*p;n=p*u-.5*w*l;r=p*l/c;y=a[k-1];z=a[k].x-y.x;B=a[k].y-y.y;t+=r/n*(y.x*p*u+.5*w*(u*z-l*y.x)-w*p*l*z/3);q+=r/n*(y.y*p*u+.5*w*(u*B-l*y.y)-w*p*l*B/3);x+=r}e.push(t/x);e.push(q/x)}e.push(f);e.push(h);
for(k=b=0;g>b;b++)a[b].x=e[k++],a[b].y=e[k++]}}},h._bidiEngine=new L,h}(J)});