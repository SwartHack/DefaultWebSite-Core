//>>built
define("require exports dojo/promise/all ../../core/promiseUtils ../../core/executeAsync ../../core/pbf ./SourceLayerData ./Feature ./BackgroundBucket ./FillBucket ./LineBucket ./SymbolBucket ../2d/engine/webgl/TileClipper".split(" "),function(R,S,L,F,G,x,y,M,N,O,P,Q,n){return function(){function c(a,b,e){this._pbfTile=new x(new Uint8Array(a),new DataView(a));this._tile=b;this._connection=e;this._layers=b.getLayers();e=b.tileKey.split("/").map(parseFloat);var c=e[0];a=e[1];e=e[2];this._level=c;b.refKey&&
(b=b.refKey.split("/").map(parseFloat)[0],b=c-b,0<b&&(c=(1<<b)-1,this._tileClipper=new n.TileClipper(b,a&c,e&c)));this._tileClipper||(this._tileClipper=new n.SimpleBuilder)}return c.prototype.parse=function(){for(var a,b=this,c=this._parseTileData(this._pbfTile),n=this._layers,h=n.length,H=this._level,l=[],p={},I=new Set,h=h-1;0<=h;h--)if(a=n[h],!(a.minzoom&&H<a.minzoom||a.maxzoom&&H>=a.maxzoom||a.layout&&"none"===a.layout.visibility))if(0!==a.type){var u=a.sourceLayer,q=c[u];if(q){I.add(u);var k=
this._createBucket(a);k&&(k.layerIndex=h,k.layerExtent=q.extent,(q=p[u])||(q=p[u]=[]),q.push(k))}}else k=this._createBucket(a),k.layerIndex=h,l.push(k);var x=10*this._level,y=10*(this._level+1),r=[],z=[],v=[],J=[],A=this._tileClipper,B=new Set,C={},D=[];I.forEach(function(b){return D.push(b)});var w=0,t=0,E=D.length;return G(function(){if(6===b._tile.status)return!0;switch(w){case 0:if(E>t){var a=D[t++],e=c[a],m=p[a];if(m&&0!==m.length)for(a=e.getData();a.next(2);){var f=new M(a.getMessage(),e),d=
f.values;if(d){var g=d._minzoom;if(g&&g>=y)continue;if((d=d._maxzoom)&&x>=d)continue}for(var g=0,K=m;g<K.length;g++)d=K[g],d.pushFeature(f)}}else{e=b._tile;for(a in p)for(m=p[a],f=0;f<m.length;f++)d=m[f],d.hasFeatures()&&(3===d.layer.type?(r.push(d),e.addBucket(d)):d.layer.refLayerId?v.push(d):(z.push(d),J[d.layer.id]=d));w=1;t=0;E=r.length}break;case 1:E>t?r[t++].getResources(A,B,C):w=2}return 2===w},50).then(function(){if(6===b._tile.status)return[];var a,c=[],e=b._tile.getWorkerTileHandler();0<
B.size&&(a=e.fetchSprites(B,b._connection),c.push(a));var f,d;for(d in C)a=C[d],0<a.size&&(f=e.fetchGlyphs(b._tile.tileKey,d,a,b._connection),c.push(f));return L(c).then(function(a){if(6===b._tile.status)return[];var c=0,d=0,e=z.length;return G(function(){if(6===b._tile.status)return!0;switch(c){case 0:if(e>d){var a=z[d++];a.processFeatures(A,b._tile);l.push(a)}else c=1,d=0,e=v.length;break;case 1:for(var f=0;f<v.length;f++){var a=v[f],g=J[a.layer.refLayerId];g&&(g.assignBufferInfo(a),l.push(a))}c=
2;d=0;e=r.length;break;case 2:e>d?(a=r[d++],a.processFeatures(A,b._tile),l.push(a)):c=3}return 3===c},50).then(function(){return l.sort(function(a,b){return a.layerIndex-b.layerIndex}),l})}).otherwise(function(a){return F.reject(Error(a))})}).otherwise(function(a){return F.reject(Error(a))})},c.prototype._parseTileData=function(a){for(var b={};a.next();)switch(a.tag()){case 3:var c=new y(a.getMessage());b[c.name]=c;break;default:a.skip()}return b},c.prototype._createBucket=function(a){switch(a.type){case 0:return this._createBackgroundBucket(a);
case 1:return this._createFillBucket(a);case 2:return this._createLineBucket(a);case 3:return this._createSymbolBucket(a)}},c.prototype._createBackgroundBucket=function(a){return new N(a,this._level)},c.prototype._createFillBucket=function(a){var b=this._tile;return new O(a,this._level,a.hasDataDrivenFill?b.fillDDVertexBuffer:b.fillVertexBuffer,b.fillIndexBuffer,a.hasDataDrivenOutline?b.outlineDDVertexBuffer:b.outlineVertexBuffer,b.outlineIndexBuffer)},c.prototype._createLineBucket=function(a){var b=
this._tile;return new P(a,this._level,a.hasDataDrivenLine?b.lineDDVertexBuffer:b.lineVertexBuffer,b.lineIndexBuffer)},c.prototype._createSymbolBucket=function(a){var b=this._tile;return new Q(a,this._level,a.hasDataDrivenIcon?b.iconDDVertexBuffer:b.iconVertexBuffer,b.iconIndexBuffer,a.hasDataDrivenText?b.textDDVertexBuffer:b.textVertexBuffer,b.textIndexBuffer,b.placementEngine,b.getWorkerTileHandler())},c}()});