//>>built
define("../Widget ../../core/Accessor ../../core/date ../../core/Error ../../core/HandleRegistry ../../core/lang ../../core/Logger ../../core/urlUtils ../../core/promiseUtils ../../core/watchUtils ../../request ../../support/arcadeUtils ../../tasks/support/StatisticDefinition ../../tasks/support/Query ../../tasks/QueryTask dojo/promise/all dojo/i18n!dojo/cldr/nls/number dojox/html/entities".split(" "),function(F,G,x,z,H,g,I,J,u,K,A,v,L,B,M,y,C,N){var O=/\'/g,P=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,
D=/^\s*expression\//i,Q=/(\{([^\{\r\n]+)\})/g,q={attachments:"attachments",fields:"fields",media:"media",text:"text"},E=I.getLogger("esri.widgets.Popup.PopupRendererViewModel");return G.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},view:{},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new H},initialize:function(){this._handles.add([K.watch(this,
["graphic","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","contentEnabled"],function(){this._updateGraphic(this.graphic,this.contentEnabled)}.bind(this))]);this._updateGraphic(this.graphic,this.contentEnabled)},destroy:function(){this._handles.destroy();this._handles=null;this._clearRelatedInfo();this._cancelPromises();this.graphic=null;this._set("title",null);this._set("content",null);this._set("waitingForContent",null)},content:null,contentEnabled:!0,
contentTypes:q,formattedAttributes:null,graphic:null,title:"",view:null,waitingForContent:!1,_handles:null,_contentPromise:null,_contentElementPromises:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_addValuesToHref:function(b,a,c,e){return a=this._trimString(a),g.substitute((a?"{"!==a[0]:1)?e:c,b)},_cancelPromises:function(){this._contentElementPromises&&(this._contentElementPromises.forEach(function(b){b.cancel()},this),this._contentElementPromises=
null);this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null);this._relatedRecordsQueryPromises.forEach(function(b){b.cancel()});this._relatedRecordsQueryPromises.length=0;this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedInfo=this._relatedLayersInfo=null},_compileContent:function(b,a){var c=b.content;if(c&&(c.nodeName||c&&c&&"function"==typeof c.postMixInProperties&&"function"==typeof c.buildRendering&&
"function"==typeof c.postCreate&&"function"==typeof c.startup||c&&c.isInstanceOf&&c.isInstanceOf(F)))return c;if("string"==typeof c)return this._compileText(b,{type:q.text,text:c}).text;if(Array.isArray(c))return c.map(function(c,d){d=(d=a&&a[d])&&d.value;switch(c.type){case q.attachments:return this._proxyAttachments(c,d);case q.fields:return this._compileFields(b,c);case q.media:return this._compileMedia(b,c);case q.text:return this._compileText(b,c)}},this);if(c)try{throw new z(this.declaredClass+
"::invalid content type.");}catch(e){E.warn(e.stack)}},_compileFields:function(b,a){a=g.clone(a);var c=(b=b.template)&&b.expressionInfos;b=b&&g.clone(b.fieldInfos);b=a.fieldInfos||b;var e=[];return b&&b.forEach(function(b){var a=b.fieldName.toLowerCase();if(b.hasOwnProperty("visible")?b.visible:1)a=this._isExpressionField(a)?this._getExpressionInfo(c,a):null,b.label=a?a.title:b.label,e.push(b)},this),a.fieldInfos=e,a},_compileMedia:function(b,a){var c,e;a=g.clone(a);var d=a.mediaInfos,f=b.attributes,
h=b.layer,l=this.formattedAttributes.global,k=b.substOptions;return d&&(c=[],d.forEach(function(a){e=0;var d=a.value;switch(a.type){case "image":var m=d.sourceURL,m=m&&this._trimString(g.substitute(f,this._fixTokens(m,h)));e=!!m;break;case "pie-chart":case "line-chart":case "column-chart":case "bar-chart":var p,m=d.normalizeField;d.fields=d.fields.map(function(a){return p=this._getLayerFieldInfo(h,a),p?p.name:a},this);m&&(p=this._getLayerFieldInfo(h,m),d.normalizeField=p?p.name:m);e=d.fields.some(function(a){return g.isDefined(f[a])||
-1!==a.indexOf("relationships/")&&this._relatedInfo},this);break;default:return}if(e){a=g.clone(a);var d=a.value,m=a.title?this._processFieldsInLinks(this._fixTokens(a.title,h),f):"",n=a.caption?this._processFieldsInLinks(this._fixTokens(a.caption,h),f):"";if(a.title=m?this._trimString(g.substitute(l,m,k)):"",a.caption=n?this._trimString(g.substitute(l,n,k)):"","image"===a.type)d.sourceURL=g.substitute(f,this._fixTokens(d.sourceURL,h)),d.linkURL&&(d.linkURL=this._trimString(g.substitute(f,this._fixTokens(d.linkURL,
h))));else{var t,w=(m=b.template)&&m.fieldInfos;d.fields.forEach(function(a,b){if(-1!==a.indexOf("relationships/"))a=this._getRelatedChartInfos(h,w,a,d,f,k),Array.isArray(a)?d.fields=a:d.fields[b]=a;else{var c=f[a],c=void 0===c?null:c;t=f[d.normalizeField]||0;c&&t&&(c/=t);var e=w&&this._getFieldInfo(w,a);d.fields[b]={y:c,tooltip:(e&&e.label||a)+":"+this._formatValue(c,{fieldInfos:w,fieldName:a,layer:h,substOptions:k,preventPlacesFormatting:!!t})}}},this)}c.push(a)}},this)),a.mediaInfos=c,a},_compileText:function(b,
a){if((a=g.clone(a))&&a.text){var c=b.attributes,e=this.formattedAttributes.global,d=b.substOptions;b=this._processFieldsInLinks(this._fixTokens(a.text,b.layer),c);a.text=this._trimString(g.substitute(e,b,d))}return a},_compileTitle:function(b){var a="",c=b.title,e=b.layer,d=b.attributes,f=b.substOptions,h=this.formattedAttributes.global;c&&("function"==typeof c&&(c=c.call(null,{graphic:b.graphic})),"string"==typeof c)&&(b=this._processFieldsInLinks(this._fixTokens(c,e),d),a=this._trimString(g.substitute(h,
b,f)));return a},_getExpressionInfo:function(b,a){if(this._isExpressionField(a)){a=a.replace(D,"");a=a.toLowerCase();var c;return b.some(function(b){return b.name.toLowerCase()===a&&(c=b),!!c}),c}},_createGraphicInfo:function(b,a){var c=b.popupTemplate,e=c&&c.title,d=c&&c.content,f=b.layer,h=f&&f._getDateOpts&&f._getDateOpts().properties,l=g.clone(b.attributes)||{},k={dateFormat:{properties:h,formatter:"DateFormat"+x.getFormat("short-date-short-time")}};return{graphic:b,template:c,title:e,content:d,
contentEnabled:a,layer:f,attributes:l,properties:h,substOptions:k}},_fixTokens:function(b,a){return b.replace(Q,function(b,e,d){return(b=this._getLayerFieldInfo(a,d))?"{"+b.name+"}":e}.bind(this))},_encodeAttributes:function(b){var a=g.clone(b)||{};return Object.keys(a).forEach(function(b){var c=a[b];"string"==typeof c&&(c=encodeURIComponent(c).replace(O,"\x26apos;"),a[b]=c)}),a},_formatAttributesToFieldInfos:function(b,a,c,e,d){b.forEach(function(f){var h=f.fieldName,l=this._getLayerFieldInfo(a,
h);l&&(h=f.fieldName=l.name);if(d[h]=this._formatValue(d[h],{fieldInfos:b,fieldName:h,layer:a,substOptions:c}),e&&f.format&&f.format.dateFormat)f=e.indexOf(h),-1<f&&e.splice(f,1)},this)},_getArcadeViewingMode:function(b){return b&&"local"===b.viewingMode?"localScene":"globalScene"},_formatAttributes:function(b,a,c,e,d,f,h,l){var k=g.clone(d);if(h&&h.forEach(function(a){var b="expression/"+a.name;a=l[a.name];var c=this.view,c=c&&v.getViewInfo({viewingMode:"3d"===c.type?this._getArcadeViewingMode(c):
"map",scale:c.scale,spatialReference:c.spatialReference});a=v.executeFunction(a&&a.compiledFunc,v.createExecContext(f,c));"string"==typeof a&&(a=N.encode(a));k[b]=a},this),this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(a){var b=this._relatedInfo[a];a=this._relatedLayersInfo[a];b&&(b.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,a,d,k)),b.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,a,d,k)))},this),b&&this._formatAttributesToFieldInfos(b,
a,c,e,k),a){var n=a.typeIdField;Object.keys(d).forEach(function(b){if(-1===b.indexOf("relationships/")){var c=d[b];if(g.isDefined(c)){var e=this._getDomainName(a,f,b,c);g.isDefined(e)?k[b]=e:b===n&&(c=this._getTypeName(a,f,c),g.isDefined(c)&&(k[b]=c))}}},this)}return k},_formatValue:function(b,a){var c=a.fieldInfos,e=a.fieldName,d=a.substOptions,c=c&&this._getFieldInfo(c,e),f=g.clone(c),c=a.preventPlacesFormatting;(a=this._getLayerFieldInfo(a.layer,e))&&"date"===a.type&&(a=f.format||{},a.dateFormat=
a.dateFormat||"short-date-short-time",f.format=a);a=f&&f.format;e="number"==typeof b&&d.dateFormat.properties&&-1===d.dateFormat.properties.indexOf(e)&&(!a||!a.dateFormat);if(!g.isDefined(b)||!f||!g.isDefined(a))return e?this._forceLTR(b):b;var h="",l=[],f=a.hasOwnProperty("places")||a.hasOwnProperty("digitSeparator"),k=a.hasOwnProperty("digitSeparator")?a.digitSeparator:!0;if(f)h="NumberFormat",g.isDefined(a.places)&&(!c||0<a.places)&&(l.push("places: "+Number(a.places)),h+="("+l.join(",")+")");
else{if(!a.dateFormat)return e?this._forceLTR(b):b;h="DateFormat"+x.getFormat(a.dateFormat)||x.getFormat("short-date-short-time")}b=g.substitute({myKey:b},"{myKey:"+h+"}",d)||"";return f&&!k&&C.group&&(b=b.replace(new RegExp("\\"+C.group,"g"),"")),e?this._forceLTR(b):b},_forceLTR:function(b){return"\x26lrm;"+b},_getDomainName:function(b,a,c,e){return(b=b.getFieldDomain&&b.getFieldDomain(c,{feature:a}))&&b.codedValues?b.getName(e):null},_getFieldInfo:function(b,a){var c;a=a.toLowerCase();for(var e=
0;e<b.length;e++){var d=b[e];if(d.fieldName&&d.fieldName.toLowerCase()===a){c=d;break}}return c},_getLayerFieldInfo:function(b,a){return a&&b&&b.getField?b.getField(a):null},_getTypeName:function(b,a){return(b=b.getType&&b.getType(a))&&b.name},_processFieldsInLinks:function(b,a){var c=this._encodeAttributes(a);return b&&(b=b.replace(P,function(b,d,f){return this._addValuesToHref(b,d||f,a,c)}.bind(this))),b},_proxyAttachments:function(b,a){b=g.clone(b);a&&!(a instanceof z)&&a.attachmentInfos&&a.attachmentInfos.length&&
(a=a.attachmentInfos.map(function(a){return a.url=J.addProxy(a.url),a},this),b.attachmentInfos=a);return b},_queryAttachments:function(b){var a=b.layer;if(!a)return u.resolve();"scene"===a.type&&a.associatedLayer&&(a=a.associatedLayer);var c=b.attributes;b=a&&a.objectIdField;c=c&&b&&c[b];return b&&a.get("capabilities.data.supportsAttachment")&&c?this._queryAttachmentInfos(a,c):void 0},_queryAttachmentInfos:function(b,a){var c=b.url+"/"+b.layerId+"/"+a+"/attachments",e=b.token||"";return A(c,{query:{f:"json",
token:e},callbackParamName:"callback"}).then(function(b){b=b.data;return b.attachmentInfos.forEach(function(b){b.url=c+"/"+b.id;e&&(b.url+="?token\x3d"+e);b.objectId=a}),b})},_queryContentElements:function(b){var a=b.content;if(!a||!Array.isArray(a))return u.resolve();var c=[],e={};return a.forEach(function(a,f){a.type===q.attachments&&(a=this._queryAttachments(b))&&(e[f]=a,c.push(a))},this),this._contentElementPromises=c,0===c.length?u.resolve():u.eachAlways(e).always(function(a){return this._contentElementPromises=
null,a}.bind(this))},_trimString:function(b){return(b||"").trim()},_getContent:function(b){var a=b.template,a=a&&a.content;return"function"==typeof a&&(a=a.call(null,{graphic:b.graphic})),a&&"function"==typeof a.then?a:u.resolve(a)},_updateContent:function(b){var a;return b.contentEnabled?(a=this._getContent(b).then(function(a){return b.content=a,this._queryContentElements(b)}.bind(this)).then(function(a){this._set("content",this._compileContent(b,a))}.bind(this)).otherwise(function(a){E.log("error loading template",
a)}.bind(this)).then(function(){this._contentPromise=null}.bind(this)),this._contentPromise=a,a):a=u.resolve()},_isExpressionField:function(b){return D.test(b)},_compileExpressions:function(b){if(b){var a={};return b.forEach(function(b){a[b.name]={compiledFunc:v.createFunction(b.expression)}}),a}},_createFormattedAttributes:function(b){var a=b.graphic,c=b.attributes,e=b.layer,d=b.template,f=d&&d.fieldInfos,h=d&&d.expressionInfos,l=this._compileExpressions(h),k=b.substOptions,g=b.properties,r={global:this._formatAttributes(f,
e,k,g,c,a,h,l),content:[]};b=d&&d.content;return Array.isArray(b)&&b.forEach(function(b,d){b.type===q.fields&&b.fieldInfos&&(r.content[d]=this._formatAttributes(b.fieldInfos,e,k,g,c,a,h,l))},this),r},_queryGraphicInfo:function(b,a){var c=this._createGraphicInfo(b,a);return this._checkForRelatedRecords(c).then(function(){return this._set("formattedAttributes",this._createFormattedAttributes(c)),this._set("title",this._compileTitle(c)),this._updateContent(c)}.bind(this))},_updateGraphic:function(b,
a){this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),b)&&(this._set("waitingForContent",!0),this._relatedRecordsPromise=this._queryGraphicInfo(b,a).always(function(){this._relatedRecordsPromise=null;this._relatedRecordsQueryPromises.length=0;this._set("waitingForContent",!1)}.bind(this)))},_getAllFieldInfos:function(b){var a=[],c=b.template,e=c&&c.fieldInfos;b=b.contentEnabled;
if(e&&(a=a.concat(e)),b)c=c&&c.content,Array.isArray(c)&&c.forEach(function(b){a=a.concat(b&&b.fieldInfos)},this);return a},_checkForRelatedRecords:function(b){var a=this._getAllFieldInfos(b).filter(function(a){return a&&a.fieldName&&-1!==a.fieldName.indexOf("relationships/")},this);return b.layer&&a&&0<a.length?this._getRelatedRecords({graphic:b.graphic,fieldsInfo:a}):u.resolve()},_relatedFeaturesAttributes:function(b,a,c,e){Object.keys(e.attributes).forEach(function(d){if("esriRelCardinalityOneToOne"===
b.relation.cardinality){var f=this._toRelatedFieldName([b.relation.id,d]);a[f]=c[f]=e.attributes[d]}},this)},_relatedStatsAttributes:function(b,a,c,e){Object.keys(e.attributes).forEach(function(d){var f=this._toRelatedFieldName([b.relation.id,d]);a[f]=c[f]=e.attributes[d]},this)},_getRelatedChartInfos:function(b,a,c,e,d,f){var h,g,k,n,r,m,p;return h=[],p=this._fromRelatedFieldName(c),r=p[0],g=this._relatedInfo[r],m=this._relatedLayersInfo[r],g&&g.relatedFeatures.forEach(function(g){var l,m=g.attributes;
Object.keys(m).forEach(function(g){g===p[1]&&((l={},n=m[g],e.normalizeField&&(k=-1!==e.normalizeField.indexOf("relationships/")?m[this._fromRelatedFieldName(e.normalizeField)[1]]:d[e.normalizeField]),n&&k&&(n/=k),e.tooltipField)?-1!==e.tooltipField.indexOf("relationships/")?(g=this._fromRelatedFieldName(e.tooltipField)[1],g=m[g],l.tooltip=g+": "+this._formatValue(n,{fieldInfos:a,fieldName:g,layer:b,substOptions:f,preventPlacesFormatting:!!k})):((g=this._getLayerFieldInfo(b,c))&&(c=g.name),l.tooltip=
c+": "+this._formatValue(n,{fieldInfos:a,fieldName:e.tooltipField,layer:b,substOptions:f,preventPlacesFormatting:!!k})):l.tooltip=n,l.y=n,h.push(l))},this)},this),"esriRelCardinalityOneToMany"===m.relation.cardinality||"esriRelCardinalityManyToMany"===m.relation.cardinality?h:h[0]},_getRelatedRecords:function(b){var a=b.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(a).then(function(a){return this._setRelatedRecords(a),a}.bind(this)):this._getRelatedLayersInfo(b).then(function(b){return Object.keys(b).forEach(function(a){b[a]&&
(this._relatedLayersInfo[a].relatedLayerInfo=b[a].data)},this),this._queryRelatedLayers(a).then(function(a){return this._setRelatedRecords(a),a}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(b){var a,c=b.fieldsInfo,e={};return a=b.graphic.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),c.forEach(function(b){var c,d,e,g,n;if(c=this._fromRelatedFieldName(b.fieldName),d=c[0],e=c[1],d)this._relatedLayersInfo[d]||((c=a&&a.relationships)&&c.some(function(a){return a.id==d?(n=a,!0):
void 0}),n&&(this._relatedLayersInfo[d]={relation:n,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[d]&&(this._relatedLayersInfo[d].relatedFields.push(e),b.statisticType&&(g=new L({statisticType:b.statisticType,onStatisticField:e,outStatisticFieldName:e}),this._relatedLayersInfo[d].outStatistics.push(g)))},this),Object.keys(this._relatedLayersInfo).forEach(function(b){var c,d;this._relatedLayersInfo[b]&&(c=this._relatedLayersInfo[b].relation,d=a.url+"/"+c.relatedTableId,this._relatedLayersInfo[b].relatedLayerUrl=
d,e[b]=A(d,{query:{f:"json"},callbackParamName:"callback"}))},this),y(e)},_queryRelatedLayers:function(b){var a={};return Object.keys(this._relatedLayersInfo).forEach(function(c){a[c]=this._queryRelatedLayer({graphic:b,relatedInfo:this._relatedLayersInfo[c]})},this),y(a)},_queryRelatedLayer:function(b){var a,c,e,d,f,g,l,k,n,r,m,p,q,t;return a=b.graphic,c=a.layer,e=c.layerId,p=b.relatedInfo,d=p.relatedLayerInfo,q=p.relatedLayerUrl,t=p.relation,d&&d.relationships&&d.relationships.some(function(a){return a.relatedTableId===
parseInt(e,10)?(f=a,!0):void 0}),f&&(d.fields.some(function(a){if(a.name===f.keyField)return g=-1!==["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"].indexOf(a.type)?"number":"string",!0}),r="string"===g?f.keyField+"\x3d'"+a.attributes[t.keyField]+"'":f.keyField+"\x3d"+a.attributes[t.keyField],l=new B({where:r,outFields:p.relatedFields}),p.outStatistics&&0<p.outStatistics.length&&d.supportsStatistics&&(m=new B({where:l.where,outFields:l.outFields,outStatistics:p.outStatistics})),
k=new M({url:q}),n=[k.execute(l)],m&&n.push(k.execute(m))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(n),y(n)},_setRelatedRecords:function(b){this._relatedInfo=[];Object.keys(b).forEach(function(a){if(b[a]){var c=b[a];this._relatedInfo[a]={relatedFeatures:c[0].features};g.isDefined(c[1])&&(this._relatedInfo[a].relatedStatsFeatures=c[1].features)}},this)},_fromRelatedFieldName:function(b){return-1!==b.indexOf("relationships/")?b.split("/").slice(1):[]},_toRelatedFieldName:function(b){return b&&
0<b.length?"relationships/"+b[0]+"/"+b[1]:""}})});