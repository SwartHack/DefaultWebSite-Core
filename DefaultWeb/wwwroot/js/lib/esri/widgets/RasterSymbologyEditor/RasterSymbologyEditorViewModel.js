//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators ../../core/Accessor ../../core/lang ../../layers/support/RasterFunction ../../core/colorUtils ../../core/promiseUtils dojo/i18n!./nls/RasterSymbologyEditor".split(" "),function(C,D,x,p,q,y,z,h,v,A,B){return function(w){function c(){var a=null!==w&&w.apply(this,arguments)||this;return a.renderParameters={},a.stretchTypes=[{name:"none",filterType:0},{name:"minMax",
filterType:5},{name:"percentClip",filterType:6},{name:"standardDeviation",filterType:3}],a._cachedKeyProperties={},a._defaultRenderParameters={minPercent:2,maxPercent:2,discreteNColors:256,uniqueValuesColorRampId:"uniqueValueColorRamp_default",uniqueValueColorRampType:"multipart",colorRamp:"blackToWhite_predefined",numberOfStandardDeviations:2,gamma:1.1,dra:!0,uniqueValueField:"Value",selectedBand:0},a}return x(c,w),e=c,c.prototype.getSymbologyTypes=function(){var a=[e.SymbologyTypes.none,e.SymbologyTypes.stretch],
b=this.layer,d=b.bandCount,k=b.hasRasterAttributeTable,b=b.pixelType;return 3<=d&&a.push(e.SymbologyTypes.rgb),k&&1===d&&a.push(e.SymbologyTypes.uniqueValue),1===d&&b&&"u8"===b.toLowerCase()&&a.push(e.SymbologyTypes.discrete),a},c.prototype.isStretchColorRampApplicable=function(a){return a!==this.getStretchFilterType(e.StretchTypeNames.none)||this.layer.pixelType&&"u8"===this.layer.pixelType.toLowerCase()},c.prototype.getStretchFilterType=function(a){var b=0;return this.stretchTypes.some(function(d){return d.name===
a?(b=d.filterType,!0):void 0}),b},c.prototype.getDefaultRenderParameters=function(){var a={},b=this.layer;if(this.layer){var d,k,c=this._getRenderingRuleArguments("stretch")||{},t=this._getRenderingRuleArguments("colormap")||{},f={},l=this.layer.pixelType&&"u8"!==this.layer.pixelType.toLowerCase()?e.StretchTypeNames.minMax:e.StretchTypeNames.none;return this.stretchTypes.some(function(a){return a.name===l?(k=a.filterType,!0):void 0}),a.symbologyType=this._getDefaultSymbologyType(),a.selectedBand=
this._defaultRenderParameters.selectedBand,a.stretchType=c.stretchType||k,a.minPercent=c.MinPercent||this._defaultRenderParameters.minPercent,a.maxPercent=c.MaxPercent||this._defaultRenderParameters.maxPercent,a.numberOfStandardDeviations=c.NumberOfStandardDeviations||this._defaultRenderParameters.numberOfStandardDeviations,a.gamma=c.Gamma||this._defaultRenderParameters.gamma,a.dra=c.DRA||this._defaultRenderParameters.dra,a.colorRamp=t.colorRamp||this._defaultRenderParameters.colorRamp,b.bandIds&&
(a.bandIds=b.bandIds),b.hasRasterAttributeTable&&b.rasterAttributeTable&&b.rasterAttributeTable.features&&b.rasterAttributeTable.features.length&&b.rasterAttributeTable.features[0].attributes.Red&&b.rasterAttributeTable.features[0].attributes.Green&&b.rasterAttributeTable.features[0].attributes.Blue&&(f.id=this._defaultRenderParameters.uniqueValuesColorRampId,f.type=this._defaultRenderParameters.uniqueValueColorRampType,f.colorRamps=[],b.rasterAttributeTable.features.forEach(function(a){d=a.attributes;
f.colorRamps.push({fromColor:[d.Red,d.Green,d.Blue],toColor:[d.Red,d.Green,d.Blue]})}),a.uniqueValuesColorRamp=f,a.uniqueValuesField=b.rasterAttributeTable.features[0].attributes.Value?this._defaultRenderParameters.uniqueValueField:null),b.bandCount&&1===b.bandCount&&b.pixelType&&"u8"===b.pixelType.toLowerCase()&&(a.discreteNColors=this._defaultRenderParameters.discreteNColors,a.discreteColorRamp=this._defaultRenderParameters.colorRamp),a}},c.prototype.getUniqueValueFields=function(){return this.layer.hasRasterAttributeTable&&
this.layer.rasterAttributeTable&&this.layer.rasterAttributeTable.fields&&this.layer.rasterAttributeTable.fields.length?this.layer.rasterAttributeTable.fields.filter(function(a){return"esriFieldTypeOID"!==a.type?!0:void 0}):void 0},c.prototype.getBandData=function(){var a=this;if(this.layer){var b,d,c=this.layer.bandCount,r=this.layer.id;return!this._cachedKeyProperties[r]&&1<c?this.layer.fetchKeyProperties().then(function(c){return a._cachedKeyProperties[r]=c,b=a._createBandLists(),d=a._getBandCombinationPresets(),
{presets:d,lists:b}}):(b=this._createBandLists(),d=this._getBandCombinationPresets(),A.resolve({lists:b,presets:d}))}},c.prototype.getUniqueValueGridData=function(a,b){var d=this;if(this.layer.hasRasterAttributeTable&&this.layer.rasterAttributeTable&&a&&b){for(var c=this.layer.rasterAttributeTable.features,r=a.colorRamps?a.colorRamps.length:1,e=[],f=[],c=this._sortFeatures(c,b),l,m,n,u,h,g=b=0,g=0;r>g;g++)e[g]={},e[g].start=b,e[g].end=b+1/r,b=e[g].end;return c.forEach(function(b,k){u=(k+.5)/c.length;
e.forEach(function(c,k){u>=c.start&&u<c.end&&(h=(u-c.start)/(c.end-c.start),1<e.length?(l=d._getColorRGB(a.colorRamps[k].fromColor),m=d._getColorRGB(a.colorRamps[k].toColor)):(l=d._getColorRGB(a.fromColor),m=d._getColorRGB(a.toColor)),n=d._interpolateLab(l,m,h),f.push({esriRasterSymbologyEditorUniqueValueSymbol:d._correctRgbLimits(n),esriRasterSymbologyEditorUniqueValueValue:b.value,pixelValues:b.pixelValues,id:k+1}))})}),f}},c.prototype.updateRendering=function(a){a.symbologyType&&(a.symbologyType===
e.SymbologyTypes.none?this._clearRendering():a.symbologyType===e.SymbologyTypes.stretch?this._applyStretchSingleBand(a):a.symbologyType===e.SymbologyTypes.rgb?this._applyStretchRgb(a):(a.symbologyType===e.SymbologyTypes.uniqueValue||a.symbologyType===e.SymbologyTypes.discrete)&&this._applyColormap(a))},c.prototype._sortFeatures=function(a,b){if(a&&b){a=z.clone(a);var d=[];return a.sort(function(a,d){return"string"==typeof a.attributes[b]?a.attributes[b]<d.attributes[b]?-1:1:a.attributes[b]-d.attributes[b]}),
a.forEach(function(c,e){0<e&&c.attributes[b]===a[e-1].attributes[b]?d[d.length-1].pixelValues.push(c.attributes.Value):d.push({value:c.attributes[b],pixelValues:[c.attributes.Value]})}),d}},c.prototype._getDefaultSymbologyType=function(){if(this.layer&&this.layer.renderingRule&&this.layer.renderingRule.functionName){var a=this.layer.renderingRule,b=a.functionName,a=a.functionArguments;return b.toLowerCase()===e.RenderingRuleTypeNames.extractband||b.toLowerCase()===e.RenderingRuleTypeNames.stretch&&
this.layer.bandCount&&1===this.layer.bandCount||b.toLowerCase()===e.RenderingRuleTypeNames.colormap&&a&&a.colorRamp&&this.layer.bandCount&&1===this.layer.bandCount?e.SymbologyTypes.stretch:3<=this.layer.bandCount&&b.toLowerCase()===e.RenderingRuleTypeNames.stretch?e.SymbologyTypes.rgb:e.SymbologyTypes.none}return e.SymbologyTypes.none},c.prototype._getRenderingRuleArguments=function(a){if(this.layer&&this.layer.renderingRule&&a){var b=this.layer.renderingRule;return b.functionName&&b.functionName.toLowerCase()===
a?b.functionArguments:b.functionArguments&&b.functionArguments.Raster&&b.functionArguments.Raster.functionName&&b.functionArguments.Raster.functionName===a?b.functionArguments.Raster.functionArguments:null}},c.prototype._getBandCombinationPresets=function(){var a=this._cachedKeyProperties[this.layer.id];if(a){var b;return e.bandCombinationPresets.forEach(function(d){return d.bandDefinitionKeyword===a.BandDefinitionKeyword?(b=d.presets,!0):void 0}),b?b:void 0}},c.prototype._validateProps=function(a){return null===
a.stretchType||void 0===a.stretchType||6===a.stretchType&&(isNaN(a.minPercent)||isNaN(a.maxPercent))||3===a.stretchType&&isNaN(a.numberOfStandardDeviations)?!1:((!a.noData||isNaN(a.noData))&&(a.noData=0),this.renderParameters=a,!0)},c.prototype._clearRendering=function(){this.layer.bandIds=null;this.layer.noData=null;this.layer.renderingRule=null},c.prototype._applyStretchSingleBand=function(a){if(this._validateProps(a)){this.layer.noData=a.noData;this.layer.bandIds=null;var b=this._getStretchRasterFunctionArguments(a,
1);if(1<this.layer.bandCount){var d={BandIDs:[a.selectedBand]},c=new h;c.functionArguments=d;c.functionName="ExtractBand";b.Raster=c}d=new h;(d.functionName="Stretch",d.functionArguments=b,a.colorRampName&&"none"!==a.colorRampName)?(b=new h,b.functionName="Colormap",b.functionArguments={colorRamp:a.colorRampName,Raster:d},this.layer.renderingRule=b):this.layer.renderingRule=d}},c.prototype._applyStretchRgb=function(a){if(this._validateProps(a)){this.layer.noData=a.noData;this.layer.bandIds=a.bandIds;
a=this._getStretchRasterFunctionArguments(a,3);var b=new h;b.functionName="Stretch";b.functionArguments=a;this.layer.renderingRule=b}},c.prototype._getStretchRasterFunctionArguments=function(a,b){var d={DRA:a.dra,StretchType:a.stretchType,useGamma:!0};return 0!==a.stretchType&&(d.MinPercent=a.minPercent,d.MaxPercent=a.maxPercent,1===b?d.Gamma=[a.gamma]:3===b&&(d.Gamma=[a.gamma,a.gamma,a.gamma]),d.NumberOfStandardDeviations=a.numberOfStandardDeviations),d},c.prototype._getDiscreteColormap=function(a,
b){var d=this;if(a&&b){var c,e,t,f,l,m;m=a.colorRamps?a.colorRamps.length:1;for(var n=[],h=[],q=[],g=0,p=0,g=0;m>g;g++)n[g]={},n[g].start=p,n[g].end=p+1/m,p=n[g].end;for(g=0;b>g;g++)f=(g+.5)/b,n.forEach(function(b,k){f>=b.start&&f<b.end&&(l=(f-b.start)/(b.end-b.start),1<n.length?(c=d._getColorRGB(a.colorRamps[k].fromColor),e=d._getColorRGB(a.colorRamps[k].toColor)):(c=d._getColorRGB(a.fromColor),e=d._getColorRGB(a.toColor)),t=d._interpolateLab(c,e,l),q.push(t))});for(g=0;256>g;g++)m=q[g%b],h.push([g,
m.r,m.g,m.b]);return h}},c.prototype._getColorRGB=function(a){return{r:a[0],g:a[1],b:a[2]}},c.prototype._applyColormap=function(a){var b=new h;b.functionName="Colormap";b.functionArguments={};a.symbologyType===e.SymbologyTypes.uniqueValue?b.functionArguments.Colormap=this._getUniqueValuesColormap(a.uniqueValuesSymbolData):a.symbologyType===e.SymbologyTypes.discrete&&(b.functionArguments.Colormap=this._getDiscreteColormap(a.discreteColorRamp,a.discreteNColors));b.variableName="Raster";this.layer.noData=
a.noData;this.layer.renderingRule=b},c.prototype._getUniqueValuesColormap=function(a){var b=[];return a.forEach(function(a){a.pixelValues.forEach(function(d){b.push([d,a.esriRasterSymbologyEditorUniqueValueSymbol.r,a.esriRasterSymbologyEditorUniqueValueSymbol.g,a.esriRasterSymbologyEditorUniqueValueSymbol.b])})}),b},c.prototype._createBandLists=function(){var a=this;if(this.layer){var b,d=this.layer.id,c=this.layer.bandCount,e=this._cachedKeyProperties[d],h=this.layer.bandIds||[0,1,2],f=[],l=["red",
"green","blue"];return e&&e.BandProperties&&0<e.BandProperties.length&&(b=e.BandProperties),h.forEach(function(d,e){b&&b[0].hasOwnProperty("BandName")?f.push(a._getBandIdList(c,b,a._getBandIndex(b,l[e]))):f.push(a._getBandIdList(c,b,d))}),this._cachedKeyProperties[d]=e,f}},c.prototype._getBandIndex=function(a,b){if(!this.layer||!a)return 0;var d;for(d=0;d<a.length;d++)if(a[d]&&a[d].hasOwnProperty("BandName")&&a[d].BandName.toLowerCase()===b)return d;return 0},c.prototype._getBandIdList=function(a,
b,d){if(this.layer){var c=[],e={},h=!1;b&&a===b.length&&(h=!0);var f;for(f=0;a>f;f++){var l=f.toString(),m=f.toString(),l=h&&b[f]&&b[f].BandName?b[f].BandName:B.bandPrefix+"_"+(f+1),e={};d===f&&(e.selected=!0);e.name=l;e.index=m;c.push(e)}return c}},c.prototype._interpolateLab=function(a,b,d){a=v.toLAB(a);b=v.toLAB(b);return v.toRGB({l:a.l*(1-d)+d*b.l,a:a.a*(1-d)+d*b.a,b:a.b*(1-d)+d*b.b})},c.prototype._correctRgbLimits=function(a){var b=[a.r,a.g,a.b];return b.forEach(function(a,c){0>b[c]?b[c]=0:255<
b[c]&&(b[c]=255);b[c]=Math.floor(b[c])}),{r:b[0],g:b[1],b:b[2]}},c.bandCombinationPresets=[{bandDefinitionKeyword:"LandsatTM",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]},{LandWater:[7,5,4]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"Landsat 8",presets:[{NaturalColor:[4,3,2]},{ColorInfrared:[5,4,3]},{Landuse:[5,4,2]},{LandWater:[7,6,5]},{Vegetation:[6,5,4]},{ShallowBathymetric:[3,2,1]}]},{bandDefinitionKeyword:"IKONOS",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,
3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"QuickBird",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"Pleiades",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"GeoEye",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"OrbView",presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[4,3,2]},{Landuse:[4,3,1]}]},{bandDefinitionKeyword:"LandsatMSS",presets:[{ColorInfrared:[4,
3,2]}]},{bandDefinitionKeyword:"SPOT6",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"FORMOSTAT",presets:[{NaturalColor:[1,2,3]},{ColorInfrared:[4,1,2]},{Landuse:[4,1,3]}]},{bandDefinitionKeyword:"SPOT1",presets:[{ColorInfrared:[1,2,3]},{Vegetation:[2,3,4]}]},{bandDefinitionKeyword:"WorldView",presets:[{NaturalColor:[5,3,2]},{ColorInfrared:[7,5,3]},{Landuse:[7,5,2]},{LandWater:[8,7,6]},{Vegetation:[7,6,5]},{ShallowBathymetric:[3,2,1]}]},{bandDefinitionKeyword:"RapidEye",
presets:[{NaturalColor:[3,2,1]},{ColorInfrared:[5,3,2]},{Landuse:[5,3,1]},{Vegetation:[5,4,3]}]},{bandDefinitionKeyword:"DMCii",presets:[{ColorInfrared:[1,2,3]}]}],c.StretchTypeNames={none:"none",minMax:"minMax",percentClip:"percentClip",standardDeviation:"standardDeviation"},c.RenderingRuleTypeNames={extractband:"extractband",colormap:"colormap",stretch:"stretch"},c.SymbologyTypes={none:"none",stretch:"stretch",rgb:"rgb",uniqueValue:"unique-value",discrete:"discrete"},p([q.property()],c.prototype,
"layer",void 0),p([q.property()],c.prototype,"renderParameters",void 0),c=e=p([q.subclass("esri.widgets.RasterSymbologyEditor.RasterSymbologyEditorViewModel")],c);var e}(q.declared(y))});