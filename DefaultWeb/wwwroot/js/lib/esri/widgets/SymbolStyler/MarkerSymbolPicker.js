//>>built
require({cache:{"url:esri/widgets/SymbolStyler/templates/MarkerSymbolPicker.html":'\x3cdiv\x3e\n  \x3cdiv id\x3d"${id}_typeInput" data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-point\x3d"dap_markerCategoryInput" class\x3d"${css.typeInput} ${css.categorySelect}"\x3e\x3c/div\x3e\n  \x3cdiv data-dojo-attach-point\x3d"dap_symbolTypeHeader" class\x3d"${css.header} ${css.hidden}"\x3e\x3c/div\x3e\n  \x3cdiv class\x3d"${css.symbolViewport}" data-dojo-attach-point\x3d"dap_symbolViewport"\x3e\n    \x3cdiv class\x3d"${css.symbolGrid}" data-dojo-attach-point\x3d"dap_symbolGrid"\x3e\x3c!--symbols added dynamically--\x3e\x3c/div\x3e\n  \x3c/div\x3e\n\x3c/div\x3e\n'}});
define("../../core/domUtils ../../core/promiseUtils ../../portal/Portal ../../symbols/support/styleUtils ./support/symbolFetcher ./support/symbolStorage dijit/_TemplatedMixin dijit/_WidgetBase dijit/_WidgetsInTemplateMixin dijit/Tooltip dojo/dom-class dojo/dom-construct dojo/on dojo/store/Memory dojo/store/Observable dojo/i18n!./nls/SymbolStyler dojo/text!./templates/MarkerSymbolPicker.html dijit/form/Select".split(" "),function(t,l,u,m,n,g,v,w,x,y,e,p,z,q,A,h,B){function r(){return!0}var k={id:"customTypes",
keywords:"custom symbols",name:h.customImages,title:h.customImages},d={root:"esri-marker-symbol-picker",symbolGrid:"esri-symbol-grid",symbol:"esri-symbol",noSymbols:"esri-no-symbols",defaultSymbols:"esri-default-symbols",loadingIndicator:"esri-loading-indicator",loading:"esri-loading",typeInput:"esri-type-input",categorySelect:"esri-marker-symbol-picker__category-select",loadingSymbols:"esri-marker-symbol-picker--loading",symbolViewport:"esri-marker-symbol-picker__symbolViewport",selectedSymbol:"esri-symbol--selected",
dimensionalityFlat:"esri-marker-symbol-picker--dimensionality-flat",dimensionalityVolumetric:"esri-marker-symbol-picker--dimensionality-volumetric",blocked:"esri-marker-symbol-picker--blocked",header:"esri-marker-symbol-picker__header",showingOverlay:"esri-marker-symbol-picker--showing-overlay",hidden:"esri-hidden"};return w.createSubclass([v,x],{baseClass:d.root,declaredClass:"esri.widgets.SymbolStyler.MarkerSymbolPicker",templateString:B,css:d,postCreate:function(){this.inherited(arguments);this._sourceSymbolTypesStore=
new q;this._symbolTypesStore=new A(new q);this._activeSymbolFetch={};this._portalToSourcesMap=new Map;this.dap_markerCategoryInput.set({labelAttr:"title",sortByLabel:!1});this._symbolTooltip=new y({connectId:this.dap_symbolGrid,selector:".esri-symbol",getContent:function(a){return a.item.get("data.title")||""}.bind(this)});this.own(this._symbolTooltip)},startup:function(){this.inherited(arguments);g.init();var a=this;z(this.dap_symbolGrid,".esri-symbol:click",function(){this.item.getSymbol().then(function(b){a._selectedNode&&
e.remove(a._selectedNode,d.selectedSymbol);a._selectedNode=this;e.add(this,d.selectedSymbol);a.emit("symbol-select",{selection:b.clone()})}.bind(this))});this.dap_markerCategoryInput.on("change",function(a){this.clearSelection();this._fetchSymbols(a)}.bind(this));this.refresh()},destroy:function(){this.inherited(arguments);this._portalToSourcesMap.clear();this._portalToSourcesMap=null},_3dSymbolsFilter:"volumetric",_symbolTypesStore:null,_sourceSymbolTypesStore:null,_symbolItemSurfaces:null,_noSymbolsOverlay:null,
_symbolGrid:null,_portal:null,_portalLoadTimeoutInMs:3E3,_portalToSourcesMap:null,_selectedNode:null,_symbolTooltip:null,_webStyleItemKeywordBlacklist:{EsriThematicShapesStyle:!0},displayMode:"portal",filters:null,_setFiltersAttr:function(a){this._set("filters",{source:a&&a.source||r,symbol:a&&a.symbol||r})},portal:null,symbolSource:"symbol-set",addCustomImageSymbol:function(a){var b=a.clone();a=g.loadCustomItems()||[];var c=b.url.split("/").pop();a.some(function(a){return a.url===b.url})||(b.type=
"esriPMS",b.name=c,a.push(b),this.dap_markerCategoryInput.set("value",k.id),this.clearSelection(),this._fetchSymbols(k.id))},_getDimensionality:function(){return this.symbolSource.split(":")[1]},_updateDisplay:function(){var a=this.dap_markerCategoryInput;this.clearSelection();"portal"===this.displayMode&&(this._fetchSymbols(a.value),t.show(a.domNode),e.remove(this.domNode,d.defaultSymbols))},refresh:function(a){a=a||{};a.freshStorage&&g.empty();this._blockInteraction(!0);this._setUpDimensionality();
this._setUpSymbolCategories().then(this._updateDisplay.bind(this)).then(function(){this._blockInteraction(!1)}.bind(this))},_blockInteraction:function(a){this.dap_markerCategoryInput.set("disabled",a);e.toggle(this.domNode,d.blocked,a)},clearSelection:function(){for(var a=this.dap_symbolGrid;a.lastChild;)a.removeChild(a.lastChild)},_activeSymbolFetch:null,_fetchSymbols:function(a){if(a){var b;this._activeSymbolFetch.promise&&(this._activeSymbolFetch.promise.cancel(),this._activeSymbolFetch.promise=
null,this._activeSymbolFetch.id=null);b=this._symbolTypesStore.query({id:a})[0];this._showLoadingIndicator();this._activeSymbolFetch.id=a;this._activeSymbolFetch.promise=this._getSymbolItems(b).then(function(b){g.saveRecentItem({id:a,dimensionality:b[0]&&b[0].data.dimensionality});var c=this._symbolTypesStore.query({defaultType:!0})[0];return c&&c.id===a,b}.bind(this)).then(function(c){a===this._activeSymbolFetch.id&&this._updateSymbolOptions(this._filterSymbols(c,b))}.bind(this))}},_filterSymbols:function(a,
b){var c=[1,3,5];return a.filter(function(a,d){var f="basic-web-style:volumetric"===b.id&&-1<c.indexOf(d)?2:1;return this.filters.symbol({symbolLayers:{getItemAt:function(){return{height:f,width:1}}}},b)},this)},_showLoadingIndicator:function(){e.add(this.domNode,d.loadingSymbols)},_hideLoadingIndicator:function(){e.remove(this.domNode,d.loadingSymbols)},_showNoSymbolsMessage:function(){this._hideLoadingIndicator();e.add(this.domNode,d.noSymbols);this._showMessageOverlay(h.symbolLoadError)},_showMessageOverlay:function(a){e.add(this.dap_symbolViewport,
d.showingOverlay);this._noSymbolsOverlay||(this._noSymbolsOverlay=p.create("div"));this._noSymbolsOverlay.innerHTML=a;this.dap_symbolViewport.appendChild(this._noSymbolsOverlay)},_hideMessageOverlay:function(){e.remove(this.dap_symbolViewport,d.showingOverlay);this._noSymbolsOverlay&&this._noSymbolsOverlay.parentNode&&this._noSymbolsOverlay.parentNode.removeChild(this._noSymbolsOverlay)},_setUpSymbolCategories:function(){return this._showLoadingIndicator(),e.remove(this.dap_markerCategoryInput.domNode,
d.hidden),e.add(this.dap_symbolTypeHeader,d.hidden),this._hideMessageOverlay(),this._initPortal().then(function(a){if(0===this.symbolSource.indexOf("symbol-set"))return n.fetchSymbolSetSymbolSources(a);var b=this._portalToSourcesMap.get(a);return b?b:n.fetchWebStyleSymbolSources(a).then(function(a){return a.sort(function(a,b){a=m.styleNameFromItem(a.portalItem);b=m.styleNameFromItem(b.portalItem);return a>b?1:b>a?-1:0})}).then(function(b){return this._portalToSourcesMap.set(a,b),b}.bind(this))}.bind(this)).then(this._filterSourcesInternally.bind(this)).then(this._setUpSymbolSelect.bind(this)).then(function(){this._hideLoadingIndicator();
0===this._symbolTypesStore.data.length?this._showMessageOverlay(h.noSymbolsAvailable):this._hideMessageOverlay()}.bind(this)).otherwise(this._showNoSymbolsMessage.bind(this))},_filterSourcesInternally:function(a){return l.resolve(a).then(function(a){var b=this._webStyleItemKeywordBlacklist;return a.filter(function(a){return!a.portalItem.typeKeywords.some(function(a){return b[a]})})}.bind(this)).then(function(a){if(0===this.symbolSource.indexOf("symbol-set"))return a;var b=this._getDimensionality(),
d=a.map(function(a){return a.fetchData()});return l.eachAlways(d).then(function(c){var d=[n.getPrimitives(b)];return c.forEach(function(c,f){if((c=c.value)&&c.items&&Array.isArray(c.items)&&0!==c.items.length){var e=m.styleNameFromItem(a[f].portalItem);(c.items[0].dimensionality||("EsriIconsStyle"===e?"flat":"volumetric"))===b&&d.push(a[f])}}),d}).then(this._filterSources.bind(this))}.bind(this))},_filterSources:function(a){return a.filter(this.filters.source,this)},_setUpDimensionality:function(){var a=
"volumetric"===this._getDimensionality();e.toggle(this.domNode,d.dimensionalityVolumetric,a);e.toggle(this.domNode,d.dimensionalityFlat,!a)},_setUpSymbolSelect:function(a){var b,c,f=this._sourceSymbolTypesStore;f.setData(a);a.forEach(function(a){a.defaultType&&(b=a.id)});(a=g.loadRecentSymbolItem())&&(c=f.query({id:a.id})[0],c&&this._matchesDimensionality(a)&&(b=a.id));c=this._symbolTypesStore;c.setData(f.query());f=this.dap_markerCategoryInput;f.set("store",c);f.set("value",b,!1);this.dap_symbolTypeHeader.innerHTML=
f.get("displayedValue");c=c.data.length;e.toggle(f.domNode,d.hidden,1>=c);e.toggle(this.dap_symbolTypeHeader,d.hidden,1!=c)},_matchesDimensionality:function(a){var b=this._getDimensionality();a=a.dimensionality;return"volumetric"===a&&"volumetric"===b||"flat"===a&&"flat"===b},_injectCustomSymbolType:function(a){return a.push(k),a},_initPortal:function(){var a,b=this.portal||u.getDefault();return a=l.timeout(b.load().then(function(){return this._portal=b,b}.bind(this)),this._portalLoadTimeoutInMs),
this.own(a),a},_getSymbolItems:function(a){return a.id===k.id?g.loadCustomItems():a.getItems().then(function(a){return a.filter(function(a){var b=this.symbolSource.split(":")[1];a=a.data.dimensionality;return!b||a===b},this)}.bind(this))},_getActiveSource:function(){var a=this.dap_markerCategoryInput.get("value");return this._symbolTypesStore.query({id:a})[0]},_updateSymbolOptions:function(a){var b=document.createDocumentFragment();return a.forEach(function(a){var c=p.create("div",{"class":d.symbol});
c.item=a;a.getThumbnail(c);a.getSymbol();b.appendChild(c)}),this._hideLoadingIndicator(),0===a.length?void this._showMessageOverlay(h.noSymbolsAvailable):(this._hideMessageOverlay(),this.dap_symbolGrid.appendChild(b),void(this.dap_symbolViewport.scrollTop=0))}})});