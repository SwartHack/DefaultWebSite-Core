//>>built
!function(g,v){function w(a){var c=a.data,h=c.action;a=c.msgId;h&&a&&("initialize"==h?(u=new g.HeatmapCalculator(c),postMessage({msgId:a})):"calculate"==h&&(c=u.calculateImageData(c),postMessage({msgId:a,imageData:c},c)))}if("function"==typeof define&&define.amd?define([],v):g.HeatmapCalculator=v(),g.importScripts&&"function"==typeof g.importScripts){var u;g.addEventListener("message",w,!1)}}(this,function(){function g(a){a=a||{};this.radius=a.blurRadius||10;this.maxVal=a.maxPixelIntensity;this.minVal=
a.minPixelIntensity;this.field=a.field;this.fieldOffset=a.fieldOffset;this.width=a.width;this.height=a.height;this.gradient=a.gradient;this.stats=null}function v(a,c){for(var h=Array(a),b=0;a>b;b++)for(var d=h[b]=Array(c),f=0;c>f;f++)d[f]=0;return h}function w(a,c){return a-c}var u=window.ArrayBuffer?!0:!1;return g.prototype.calculateImageData=function(a){var c=this.radius=a.blurRadius||this.blurRadius;this.maxVal=null!=a.maxPixelIntensity?a.maxPixelIntensity:this.maxPixelIntensity;this.minVal=null!=
a.minPixelIntensity?a.minPixelIntensity:this.minPixelIntensity;var h=this.field="field"in a?a.field:this.field,b=this.fieldOffset="fieldOffset"in a?a.fieldOffset:this.fieldOffset,d=a.screenPoints,f=a.gradient;if(f)this.gradient=f;else{if(!this.gradient)return!1;f=this.gradient}var e=a.features,k=a.mapinfo;d||(e&&k?d=this.screenPoints=this._calculateScreenPoints(e,k):!k&&this.screenPoints&&(e=!0,a.width&&a.width!=this.width&&(e=!1,this.width=a.width),a.height&&a.height!=this.height&&(e=!1,this.height=
a.height),e?d=this.screenPoints:this.screenPoints=null));if(!d)return!1;e=k.width||a.width||this.width;a=k.height||a.height||this.height;c=this._calculateIntensityMatrix(d,e,a,c,h,b);this._lastMatrix=c.matrix;this._maxIntVal=c.max;return this._createImageData(e,a,this._lastMatrix,f)},g.prototype._calculateScreenPoints=function(a,c){var h=c.resolution,b=c.width,d=c.height;c=c.extent;var f=[];if(!c)return!1;h||(h=d?Math.abs(c[3]-c[1])/d:Math.abs(c[2]-c[0])/b);b=0;for(d=a.length;d>b;b++){var e=a[b];
f[b]={x:Math.round((e.geometry.x-c[0])/h),y:Math.round((c[3]-e.geometry.y)/h),attributes:e.attributes}}return f},g.prototype._calculateIntensityMatrix=function(a,c,h,b,d,f){var e,k=v(h,c),l=Math.round(4.5*b),p=b*b,m=[],g=2*l+1,n=-1,r=1,x=-(1/0);f=f||0;for(d=function(a){return"function"==typeof a?a:a?"abs"==f?function(b){return-1*+b.attributes[a]}:function(b){return+b.attributes[a]+f}:function(){return 1}}(d);++n<g;)m[n]=Math.exp(-Math.pow(n-l,2)/(2*p))/Math.sqrt(2*Math.PI)*(b/2);for(n=0;n<a.length;n++){var t=
a[n];b=t.x-l;for(var p=t.y-l,g=b,u=p,r=+d(t),w=Math.min(t.y+l,h-1),t=Math.min(t.x+l,c-1);w>=p;){for(var y=m[p-u];t>=b;)-1<b&&-1<p&&(e=k[p][b]+=y*m[b-g]*r,e>x&&(x=e)),b++;p++;b=g}}return{matrix:k,max:x}},g.prototype._createImageData=function(a,c,h,b){if(!u)return this._createPixelData(a,c,h,b);var d=new Uint32Array(a*c);b=b.buffer?new Uint32Array(b.buffer):new Uint32Array((new Uint8Array(b)).buffer);for(var f=this.minVal,e=b.length/(this.maxVal-f),k=0;c>k;k++)for(var l=h[k],g=0;a>g;g++){var m=Math.floor((l[g]-
f)*e);d[k*a+g]=0>m?b[0]:m<b.length?b[m]:b[b.length-1]}return d},g.prototype._createPixelData=function(a,c,h,b){for(var d=Array(a*c*4),f=this.minVal,e=b.length/4/(this.maxVal-f),k=3,g=0;c>g;g++)for(var p=h[g],m=0;a>m;m++){var q=4*(g*a+m)+3,n=4*Math.floor((p[m]-f)*e)+3;3>n?n=3:n>b.length-1&&(n=b.length-1);for(k=4;k--;)d[q-k]=b[n-k]}return d},g.calculateStats=function(a,c){if(!a)return!1;for(var h,b,d,f,e,g=a.length,l=0,p=0,m=0,q=0,n=1/0,r=-(1/0);g--;)for(d=a[g],h=d.length;h--;)e=d[h],c&&!c(e)||(f||
(f=e),b=e-f,q+=e,l+=b,p+=b*b,n>e&&(n=e),e>r&&(r=e),m++);return 0<m?{mean:q/m,stdDev:Math.sqrt((p-l*l/m)/m),min:n,max:r,mid:(r-n)/2}:{mean:0,stdDev:0,min:0,max:0,mid:0}},g.getBinnedValues=function(a){function c(){console.log("not enough information to determine bins for HeatmapCalculator.getBinnedValues")}function g(a,b,c){for(var d=[];b>a;a+=c)d.push(a);return d}a=a||{};var b=a.stats,d=a.min,f=a.max,e=a.bins,k=a.count,l=a.size;a=a.values;if(!a)return console.log("values are required for HeatmapCalculator.getBinnedValues function"),
!1;if(b&&null!=b.max&&null!=b.min&&(d=b.min,f=b.max),!e)if(l){if(null==d&&(d=0),null==f){if(null==k)return c(),!1;f=d+k*l}e=g(d,f,l)}else if(k){if(b&&null!=b.min&&null!=b.max?(d=b.min,f=b.max):null!=f&&0<f&&null==d&&(d=0),null==d||null==f)return c(),!1;e=g(d,f,(f-d)/k)}for(var k=e.length,p,m=v(k,0),q=a.length;q--;)for(d=a[q],b=d.length;b--;){f=d[b];for(l=1;k>l&&(p=e[l],!(p>f));l++);m[l-1].push(f)}return m.map(function(a){return a.sort(w)})},g.getHistogramData=function(a){a=a||{};var c=a.binnedData,
h=a.stats,b=a.byStdDev,d=a.matrix;a=a.binOptions||{};if(!c){if(!d)return console.log("no data provided to HeatmapCalculator.getHistogramData"),!1;if(a.values=d,b&&(h||(h=g.calculateStats(d)),a.size=h.stdDev),a.stats=h,c=g.getBinnedValues(a),!c)return!1}var f,e;if(a.bins)d=a.bins;else for(d=[],b=0;b<c.length;b++)e=c[b],d.push(e[0]);a=[];for(b=0;b<d.length-1;b++)e=d[b],a[b]={range:[e,d[b+1]],count:e.length};return h?f=h.max:(e=c[b],f=e[e.length-1]),e=d[b],a[b]={range:[e,f],count:e.length},a},g});